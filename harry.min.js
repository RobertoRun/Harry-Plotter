// harry plotter 0.8
// ~L~ nikomomo@gmail.com 2009-2012
// https://github.com/nikopol/Harry-Plotter
var harry=function(h){var W="#88a4d7 #d685c9 #86d685 #ffc34f #93c2ea #f28989 #f9eb8a".split(" "),E=function(b,a,g){var d,b=b&&b.constructor==Array&&3==b.length?b:(d=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(b))?[parseInt(d[1],10),parseInt(d[2],10),parseInt(d[3],10)]:(d=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(b))?[2.55*parseFloat(d[1]),2.55*parseFloat(d[2]),2.55*parseFloat(d[3])]:(d=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(b))?[parseInt(d[1],16),parseInt(d[2],16),parseInt(d[3],16)]:(d=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(b))?[parseInt(d[1]+d[1],16),parseInt(d[2]+d[2],16),parseInt(d[3]+d[3],16)]:[0,0,0];"array"!=typeof a&&(a=[a,a,a]);for(d=0;3>d;++d)b[d]=Math.max(Math.min(b[d]+a[d],255),0);return void 0!=g?"rgba("+b.join(",")+","+g+")":"rgb("+b.join(",")+")"},R=function(b){var a=b.match(/\d+px/i);return a?parseInt(a,10):(a=b.match(/[0-9\.]+em/i))?Math.floor(16*parseFloat(a)):(a=b.match(/\d+pt/i))?Math.floor(1.3333*
parseInt(a,10)):10},ia=function(b){var a=Math.floor(b).toString(),g=parseInt(a.substr(0,1),10);return g*parseFloat("1E"+(a.length-1))==b?b:(g+1)*parseFloat("1E"+(a.length-1))},S=function(a,c){if("object"==typeof c)for(var g in c)a[g]=c[g];return a},ja=function(a){a=a||window.event;if("offsetX"in a)return{x:a.offsetX,y:a.offsetY};for(var c=a.target,a={x:a.pageX,y:a.pageY};c.offsetParent;)a.x-=c.offsetLeft,a.y-=c.offsetTop,c=c.offsetParent;return a},f;if(h.canvas)f=document.getElementById(h.canvas);
else{f=h.container;var P=h.width||300,aa=h.height||150,X=document.createElement("canvas"),Y;X.setAttribute("width",P+"px");X.setAttribute("height",aa+"px");f&&(Y="string"==typeof f?document.getElementById(f):f);Y||(Y=document.body);Y.appendChild(X);f=X}var v=f,G=v.width,N=v.height,a=v.getContext("2d"),ba,ka=h.background,x=h.mode||"line",la=(h.fill||"a")[0].toLowerCase().replace(/[^nasvhrdl]+/g,"a"),B=parseFloat(h.opacity)||1,Z=parseInt(h.linewidth,10)||1,wa=h.linejoin||"miter",ma=parseInt(h.radiuspoint,
10)||0,na=h.autoscale&&/top/i.test(h.autoscale),ca=h.autoscale&&/bot/i.test(h.autoscale),m=S({color:"#a0a0a0",font:'normal 9px "Sans Serif"',marks:0,ypos:"right"},h.labels),n=!1===h.mouseover?!1:S({radius:5,linewidth:Z,circle:"#888",font:'normal 10px "Sans Serif"',color:"#fff",bullet:"rgba(99,99,99,0.8)",axis:!1,text:"%v"},h.mouseover),C,s=[],Q=!1,oa,da,ea;h.margins?f=h.margins:(P=x,f=R(m.font),/pie/.test(P)?(f=m.x?2*f:!1===n?0:15,f=[f,f,f,f]):(P=Math.floor(f/2),aa=m.marks,f=[m.y?P:0,m.y&&/r/i.test(m.ypos)?
4*f:m.x?f:1,m.x?3+f+aa:m.y?f:1,m.y&&/l/i.test(m.ypos)?4*f:m.x?P:0]));var u=S({color:"#a0a0a0",x:[0,100],y:[0,25,50,75,100]},h.grid),D=h.title?S({font:'bold 12px "Sans Serif"',color:"rgba(4,4,4,0.3)",x:f[3]+2.5,y:f[0]+2.5,z:"top"},h.title):!1,w=!1===h.legends?!1:S({x:f[3]+2.5,y:f[0]+2.5+(h.title&&!h.title.x?2+R(D.font):0),color:"#666",font:'10px "Sans Serif"'},h.legends),pa,q=[],O,y,o=0,H,I,T,A,U,J,F,K,p,V,qa=function(){var a,c,g,d;o=q.length;pa=/\:[rs]/.test(x);O=y=false;I=H=T=0;if(o){for(a=0;a<o;a++){c=
q[a];O=O===false?c.min:Math.min(c.min,O);y=y===false?c.max:Math.max(c.max,y)}na&&(y=ia(y));if(pa){a=0;for(g=q[0].len;a<g;++a){for(c=d=0;c<o;++c)d=d+(q[c].val[a]||0);d>H&&(H=na?ia(d):d)}I=ca?H-O:H}else{H=y;I=ca?y-O:y}T=ca?O:0}},ra=function(a){var c,g=a.values||a,d=a.labels||[],j={val:[],lab:[],len:0,sum:0,avg:0,max:0,min:0xffffffffffff,tit:a.title||"dataset#"+(q.length+1),col:a.color||W[q.length%W.length]};for(c in g){a=parseFloat(g[c]);j.val.push(g[c]==null?null:a);j.lab.push(d[c]||c);j.sum=j.sum+
a;if(a>j.max)j.max=a;if(a<j.min)j.min=a}j.len=j.val.length;j.avg=j.len?j.sum/j.len:0;q.push(j)},sa=function(a){if(a instanceof Array&&typeof a[0]=="object")for(var c=0,g=a.length;c<g;++c)ra(a[c]);else ra(a);qa()},fa=function(b){var c,g;if(la=="a"){B=1;g=/\:river/.test(x)?"v":/line/.test(x)||/curve/.test(x)?o>1?"n":"v":/chart/.test(x)?o>1?"s":"v":/pie/.test(x.test)?"r":"s"}else g=la;switch(g){case "s":c=E(b,0,B);break;case "l":c=E(b,21,B);break;case "d":c=E(b,-21,B);break;case "v":c=a.createLinearGradient(0,
p,0,U);c.addColorStop(0,E(b,-48,B));c.addColorStop(1,E(b,48,B));break;case "h":c=a.createLinearGradient(A,0,K,0);c.addColorStop(0,E(b,-48,B));c.addColorStop(1,E(b,48,B));break;case "r":c=a.createRadialGradient(K,p,0,A,p,1);c.addColorStop(1,E(b,-48,B));c.addColorStop(0,E(b,48,B))}return c?a.fillStyle=c:false},L=function(b){if(b&&a.hasOwnProperty("shadowBlur")){b=b.split(/[ ,;:-]/);a.shadowOffsetX=parseInt(b[0]||1,10);a.shadowOffsetY=parseInt(b[1]||1,10);a.shadowBlur=parseInt(b[2]||1,10);a.shadowColor=
b[3]||"#000"}},M=function(){if(a.hasOwnProperty("clearShadow"))a.clearShadow();else if(a.hasOwnProperty("shadowBlur")){a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;a.shadowColor="rgba(0,0,0,0)"}},ta=function(){if(D){L(D.shadow);a.font=D.font;a.textAlign="left";a.textBaseline="top";a.fillStyle=D.color;a.fillText(D.text,D.x,D.y);M()}},ga=function(b,c,g,d,j){a.save();if(m.x&&b%m.x==0){b=q[0].lab[b]||b;L(m.shadow);a.font=m.font;a.fillStyle=m.color;a.textAlign=d||"center";a.textBaseline=j||"alphabetic";
a.fillText(b,c,g);M()}if(m.marks){a.lineWidth=1;a.beginPath();a.moveTo(c,p);a.lineTo(c,p+m.marks);a.strokeStyle=m.color;a.stroke()}a.restore()},va=function(b,c){a.save();a.font=n.font;var g,d,j,i=b.length,e,z,k=0,t=0,l=R(n.font),f=l/2,m=l+3,h,r,o=G;r=0;h=N;var ua=0;b.sort(function(a,b){return parseInt(b.v,10)-parseInt(a.v,10)});for(d=0;d<i;d++){e=b[d];j=q[e.nds].lab[e.n];z=q[e.nds].tit;if(j=typeof n.text=="function"?n.text(e.n,e.v,j,e.x,e.y):n.text.replace("%v",e.v).replace("%l",j).replace("%n",e.n).replace("%t",
z).replace("%p",e.pct)){e.lines=j.split(/\n|\\n/);e.h=e.lines.length*m;e.h2=Math.floor(e.h/2);e.w=0;for(g in e.lines)if((j=a.measureText(e.lines[g]).width+6)>e.w)e.w=j;if(e.w>t)t=e.w;k=k+e.h;e.r++;o>e.x-e.r&&(o=e.x-e.r);r<e.x+e.r&&(r=e.x+e.r);if(h>e.y)h=e.y;if(ua<e.y)ua=e.y}}i>1&&(t=t+(6+l));if(k){k=k+3;if(c){r=o+(r-o)/2-t/2;r+t>G&&(r=G-1-t)}else r+t>=G&&(r=o-t);r<1&&(r=1);r=Math.floor(r)+0.5;g=r+t;d=h+k/2+k/2;d>p&&(d=p-1);d=Math.floor(d)+0.5;e=d-k;a.beginPath();a.moveTo(r,d);a.lineTo(g,d);a.lineTo(g,
e);a.lineTo(r,e);a.closePath();if(n.bullet){L(n.shadowbox);a.strokStyle="";a.fillStyle=n.bullet;a.fill();M()}if(n.border){a.lineWidth=1;a.lineJoin="round";a.strokeStyle=n.border;a.stroke()}a.textAlign="left";a.textBaseline="top";h=e+3;for(d=0;d<i;d++){e=b[d];k=r+3;if(i>1){a.beginPath();a.arc(k+f,h+f,f,0,2*Math.PI);a.fillStyle=q[e.nds].col;a.fill();k=k+(l+3)}L(n.shadow);a.fillStyle=n.color;for(g=0;g<e.lines.length;++g,h=h+m)a.fillText(e.lines[g],k,h);M()}}a.restore()},ha={line:function(b,c){var g=
o,d=I?F/I:0,j,i,e,z,k,h=function(a,b,d,g,e,i){for(var j,f,z,k,h,l;e<=i;)if(g[e]===null)e++;else if(c){j=b[e];f=d[e];for(e++;e<=i&&g[e]===null;)e++;if(e>i)a.lineTo(j,f);else{z=(j+b[e])/2;k=(f+d[e])/2;h=(j+z)/2;l=(f+k)/2;a.quadraticCurveTo(j,f,h,l);h=(z+b[e])/2;l=(k+d[e])/2;a.quadraticCurveTo(z,k,h,l)}}else{a.lineTo(b[e],d[e]);e++}};a.lineWidth=Z;a.lineJoin=wa;for(s=[];j=q[--g];)if((k=j.len)>1){var l=[],f=[];for(i=0;i<k;++i){z=0;if(b)for(e=0;e<=g;e++)z=z+(q[e].val[i]-T);else z=j.val[i]-T;l.push(A+Math.round(i*
(J/(k-1))));f.push(p-Math.round(d*z))}s.push({x:l,y:f,v:q[g].val,nds:g});i--;l.push(A+Math.round(i*(J/(k-1))));f.push(p-Math.round(d*z));for(i=0;j.val[i]===null;)i++;for(e=k-1;j.val[e]===null;)e--;if(i<=e&&fa(j.col)){a.beginPath();a.moveTo(l[i],p);a.lineTo(l[i],f[i]);h(a,l,f,j.val,i,e);a.lineTo(l[e],p);a.closePath();a.fill()}a.strokeStyle=j.col;a.beginPath();a.moveTo(l[i],f[i]);h(a,l,f,j.val,i,e);a.stroke();if(g==0)for(i=0;i<k;++i)ga(i,l[i],N-1);if(ma){a.fillStyle=j.col;for(i=0;i<k;++i)if(j.val[i]!=
void 0){a.beginPath();a.arc(l[i],f[i],ma,0,2*Math.PI);a.closePath();a.fill()}}}},curve:function(a){ha.line(a,true)},chart:function(b){s=[];if(o){var c,g,d=q[0].len,j=o>1?4:0,i=b?1:o,e=d&&o?(J-j*(d-1))/d/i-1:0,f,k,h,l=A,m,n,u=b?H?F/H:0:y?F/y:0;e<0&&(e=0);a.lineWidth=Z;a.lineJoin="miter";for(g=0;g<o;g++)s.push({x:[],y:[],v:[],nds:g});for(c=0;c<d;c++){ga(c,l+(e+1)*i/2,N-1);k=p;for(g=0;g<o;g++){f=q[g];h=b?k:p;k=h-Math.round(u*f.val[c]);m=Math.round(l);n=Math.round(l+e);if(f.val[c]!==null){a.beginPath();
a.moveTo(m,h);a.lineTo(m,k);a.lineTo(n,k);a.lineTo(n,h);a.closePath();fa(f.col)&&a.fill();a.strokeStyle=f.col;a.stroke()}s[g].x.push(0.5+Math.floor(l+e/2));s[g].y.push(k);s[g].v.push(f.val[c]);b||(l=l+(e+1))}l=l+(b?e+1+j:j)}}},pie:function(){s=[];if(o){var b,c=0,g=[],d=[],j=Math.PI*2,i=[],e=[];if(o>1){var f=0;for(b=0;b<o;b++)f=f+q[b].sum;if(f){b=0;for(c=o;b<o;b++){g[b]=q[b].sum/f*j;d[b]=q[b].col;i.push(q[b].sum);e.push(Math.round(100*q[b].sum/f))}}}else{f=q[0];if(f.sum){c=f.len;for(b=0;b<c;b++){g[b]=
f.val[b]/f.sum*j;d[b]=W[b%W.length];i.push(f.val[b]);e.push(Math.round(100*f.val[b]/f.sum))}}}var j=A+Math.round(J/2),f=U+Math.round(F/2),h=Math.min(F/2,J/2)-1,n=h+m.fontpx,l,p,u=Math.PI*1.5,w,r,x,y,v=Q;oa=h;da=j;ea=f;Q=v;a.lineWidth=Z;a.lineJoin="miter";for(b=0;b<c;b++){w=u+g[b];r=(u+w)/2;s.push({a:u%(2*Math.PI),n:b});if(b===v){l=j+Math.cos(r)*10;p=f+Math.sin(r)*10}else{l=j;p=f}a.beginPath();a.moveTo(l,p);a.arc(l,p,h,u,w,false);a.closePath();fa(d[b])&&a.fill();a.strokeStyle=d[b];a.stroke();if(b===
v){x=l+n/2*Math.cos(r);y=p+n/2*Math.sin(r)}else ga(i[b],l+n*Math.cos(r),p+n*Math.sin(r),"center","middle");u=w}v!==false&&va([{x:x,y:y,r:0,v:i[v],pct:e[v]+"%",n:v,nds:o>1?v:0}],true);s.sort(function(a,b){return a.a-b.a})}}},$={line:function(b){var c,g=false,d,f,i=n.linewidth||1,e=[];if(s.length){d=s[0];for(c=0;c<d.x.length;++c)if(d.v[c]!=void 0&&(Math.abs(b-d.x[c])<f||g===false)){f=Math.abs(b-d.x[c]);g=c}if(g!==false){for(c=0;c<s.length;++c){d=s[c];if(d.v[g]!=void 0){if(n.border2){a.beginPath();a.lineWidth=
i+2;a.arc(d.x[g],d.y[g],n.radius,0,2*Math.PI);if(n.linewidth==0){a.fillStyle=n.border2;a.fill()}else{a.strokeStyle=n.border2;a.stroke()}}a.beginPath();a.lineWidth=i;a.arc(d.x[g],d.y[g],n.radius,0,2*Math.PI);if(n.linewidth==0){a.fillStyle=n.circle;a.fill()}else{a.strokeStyle=n.circle;a.stroke()}if(n.axis){a.lineWidth=1;if(/x/i.test(n.axis)){for(b=d.y[g]+n.radius;b<p;){a.moveTo(d.x[g],b);b=b+2;b>p&&(b=p);a.lineTo(d.x[g],b);b=b+2}a.stroke()}if(/y/i.test(n.axis)){for(b=d.x[g]+n.radius;b<K;){a.moveTo(b,
d.y[g]);b=b+2;b>K&&(b=K);a.lineTo(b,d.y[g]);b=b+2}a.stroke()}}e.push({x:d.x[g],y:d.y[g],r:i/2+1+n.radius,v:d.v[g],n:g,nds:d.nds})}}va(e)}}},chart:function(a,c){$.line(a,c)},curve:function(a,c,g){$.line(a,c,g,true)},pie:function(a,c){var g,d=0;if(Math.sqrt(Math.pow(a-da,2)+Math.pow(c-ea,2))<=oa){g=Math.PI-Math.atan2(ea-c,a-da);for(g=(g+3*Math.PI)%(2*Math.PI);d<s.length&&g>s[d].a;)d++;--d<0&&(d=s.length-1);Q=s[d].n;V(true)}else if(Q!==false){Q=false;V(true)}}};V=function(b){var c=x.split(/:/),g=c[0],
d=c[1]||false;a.clearRect(0,0,G,N);if(ka){a.fillStyle=ka;a.fillRect(0,0,G,N)}if(/chart|line|curve/.test(x)){var f,i;a.lineWidth=u.linewidth||1;a.strokeStyle=u.color;if(u.x){c=0;for(f=u.x.length;c<f;++c){i=A+Math.round(J*u.x[c]/100);a.beginPath();a.moveTo(i,U);a.lineTo(i,p);a.stroke()}}if(u.y){c=0;for(f=u.y.length;c<f;++c){i=p-Math.round(F*u.y[c]/100);a.beginPath();a.moveTo(A,i);a.lineTo(K,i);a.stroke()}}}if(o&&m.y&&/chart|line|curve/.test(x)){var e,h,k=I<10?100:I<100?10:1;L(m.shadow);a.font=m.font;
a.fillStyle=m.color;a.textBaseline="middle";c=0;for(f=m.y.length;c<f;++c){e=p-Math.round(F*m.y[c]/100);h=T+I*m.y[c]/100;h=Math.round(k*h)/k;if(/r/i.test(m.ypos)){i=K+1;a.textAlign="left";a.fillText(h,i,e)}if(/l/i.test(m.ypos)){i=A-2;a.textAlign="right";a.fillText(h,i,e)}}M()}if(D&&D.z=="top"){ha[g](d);ta()}else{ta();ha[g](d)}if(w!==false&&o>1){a.save();a.font=w.font;var t,l,k=0;f=R(w.font)+3;i=f-3;e=o;l=3+f*e;h=w.x;for(var s=w.y,c=0;c<e;++c)if((t=a.measureText(q[c].tit)).width>k)k=t.width;t=9+i+k;
a.lineWidth=1;if(k=w.background){L(w.shadowbox);a.fillStyle=k;a.fillRect(h,s,t,l);M()}if(k=w.border){a.strokeStyle=k;a.strokeRect(h,s,t,l)}c=0;for(t=s+3;c<e;++c,t=t+f){l=q[c];L(w.shadow);a.fillStyle=l.col;a.fillRect(h+3,t,i,i);M();if(k=w.border2){a.strokeStyle=k;a.strokeRect(h+3,t,i,i)}L(w.shadow);a.textAlign="left";a.textBaseline="top";a.fillStyle=w.color;a.fillText(l.tit,h+6+i,t);M()}a.restore()}if(!b){v.onmouseover=v.onmousemove=v.onmouseout=void 0;Q=false;if(n){ba=a.getImageData(0,0,G,N);if(C)$[g](C.x,
C.y,d);v.onmouseover=function(a){C=ja(a)};v.onmousemove=function(b){if(C){g!="pie"&&a.putImageData(ba,0,0);C=ja(b);$[g](C.x,C.y,d)}};v.onmouseout=function(){C=void 0;a.putImageData(ba,0,0)}}else C=void 0}};m.fontpx=R(m.font);/none|false/.test(u.x)&&(u.x=[]);/none|false/.test(u.y)&&(u.y=[]);A=f[3]+0.5;U=f[0]+0.5;J=Math.max(G-f[1]-f[3],0);F=Math.max(N-f[0]-f[2],0);K=A+J;p=U+F;h.datas&&sa(h.datas);V();return{canvas:v,data:q,clear:function(){q=[];o=0;return this},load:function(a){sa(a);return this},cls:function(){return this},
draw:function(a){if(a){x=a.toLowerCase();qa()}V();return this}}},plotter=harry;
