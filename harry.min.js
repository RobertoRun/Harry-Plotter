// harry plotter 0.8
// ~L~ nikomomo@gmail.com 2009-2012
// https://github.com/nikopol/Harry-Plotter
var harry=function(j){var T="#88a4d7 #d685c9 #86d685 #ffc34f #93c2ea #f28989 #f9eb8a".split(" "),w=function(b,a,g){var c,b=b&&b.constructor==Array&&3==b.length?b:(c=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(b))?[parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10)]:(c=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(b))?[2.55*parseFloat(c[1]),2.55*parseFloat(c[2]),2.55*parseFloat(c[3])]:(c=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(b))?[parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],16)]:(c=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(b))?[parseInt(c[1]+c[1],16),parseInt(c[2]+c[2],16),parseInt(c[3]+c[3],16)]:[0,0,0];"array"!=typeof a&&(a=[a,a,a]);for(c=0;3>c;++c)b[c]=Math.max(Math.min(b[c]+a[c],255),0);return void 0!=g?"rgba("+b.join(",")+","+g+")":"rgb("+b.join(",")+")"},P=function(b){var a=b.match(/\d+px/i);return a?parseInt(a,10):(a=b.match(/[0-9\.]+em/i))?Math.floor(16*parseFloat(a)):(a=b.match(/\d+pt/i))?Math.floor(1.3333*
parseInt(a,10)):10},ga=function(b){var a=Math.floor(b).toString(),g=parseInt(a.substr(0,1),10);return g*parseFloat("1E"+(a.length-1))==b?b:(g+1)*parseFloat("1E"+(a.length-1))},Q=function(a,d){if("object"==typeof d)for(var g in d)a[g]=d[g];return a},ha=function(a){a=a||window.event;if("offsetX"in a)return{x:a.offsetX,y:a.offsetY};for(var d=a.target,a={x:a.pageX,y:a.pageY};d.offsetParent;)a.x-=d.offsetLeft,a.y-=d.offsetTop,d=d.offsetParent;return a},e;if(j.canvas)e=document.getElementById(j.canvas);
else{e=j.container;var N=j.width||300,Z=j.height||150,U=document.createElement("canvas"),V;U.setAttribute("width",N+"px");U.setAttribute("height",Z+"px");e&&(V="string"==typeof e?document.getElementById(e):e);V||(V=document.body);V.appendChild(U);e=U}var x=e,G=x.width,M=x.height,a=x.getContext("2d"),$,ia=j.background,u=j.mode||"line",ja=(j.fill||"a")[0].toLowerCase().replace(/[^nasvhrdl]+/g,"a"),r=parseFloat(j.opacity)||1,W=parseInt(j.linewidth,10)||1,ta=j.linejoin||"miter",ka=parseInt(j.radiuspoint,
10)||0,la=j.autoscale&&/top/i.test(j.autoscale),ma=j.autoscale&&/bot/i.test(j.autoscale),k=Q({color:"#a0a0a0",font:'normal 9px "Sans Serif"',marks:0,ypos:"right"},j.labels),m=!1===j.mouseover?!1:Q({radius:5,linewidth:W,circle:"#888",font:'normal 10px "Sans Serif"',color:"#fff",bullet:"rgba(99,99,99,0.8)",axis:!1,text:"%v"},j.mouseover),A,n=[],O=!1,na,aa,ba;j.margins?e=j.margins:(N=u,e=P(k.font),/pie/.test(N)?(e=k.x?2*e:!1===m?0:15,e=[e,e,e,e]):(N=Math.floor(e/2),Z=k.marks,e=[k.y?N:0,k.y&&/r/i.test(k.ypos)?
4*e:k.x?e:1,k.x?3+e+Z:k.y?e:1,k.y&&/l/i.test(k.ypos)?4*e:k.x?N:0]));var s=Q({color:"#a0a0a0",x:[0,100],y:[0,25,50,75,100]},j.grid),B=j.title?Q({font:'bold 12px "Sans Serif"',color:"rgba(4,4,4,0.3)",x:e[3]+2.5,y:e[0]+2.5,z:"top"},j.title):!1,t=!1===j.legends?!1:Q({x:e[3]+2.5,y:e[0]+2.5+(j.title&&!j.title.x?2+P(B.font):0),color:"#666",font:'10px "Sans Serif"'},j.legends),q=[],ca,H,y=0,E,z,R,I,C,J,o,S,oa=function(a){var d,g=a.values||a,c=a.labels||[],h={val:[],lab:[],len:0,sum:0,avg:0,max:0,min:0xffffffffffff,
tit:a.title||"dataset#"+(q.length+1),col:a.color||T[q.length%T.length]};for(d in g){a=parseFloat(g[d]);h.val.push(g[d]==null?null:a);h.lab.push(c[d]||d);h.sum=h.sum+a;if(a>h.max)h.max=a;if(a<h.min)h.min=a}h.len=h.val.length;h.avg=h.len?h.sum/h.len:0;q.push(h);y=q.length;if(y==1){ca=ma?h.min:0;E=H=la?ga(h.max):h.max}else{ca=ma?Math.min(h.min,ca):0;H=Math.max(h.max,H);d=E=0;for(g=q[0].val.length;d<g;++d){for(a=c=0;a<q.length;++a)c=c+(q[a].val[d]||0);c>E&&(E=la?ga(c):c)}}},pa=function(a){if(a instanceof
Array&&typeof a[0]=="object")for(var d=0,g=a.length;d<g;++d)oa(a[d]);else oa(a)},da=function(b){var d,g;if(ja=="a"){r=1;g=/\:river/.test(u)?"v":/line/.test(u)||/curve/.test(u)?y>1?"n":"v":/chart/.test(u)?y>1?"s":"v":/pie/.test(u.test)?"r":"s"}else g=ja;switch(g){case "s":d=w(b,0,r);break;case "l":d=w(b,21,r);break;case "d":d=w(b,-21,r);break;case "v":d=a.createLinearGradient(0,o,0,R);d.addColorStop(0,w(b,-48,r));d.addColorStop(1,w(b,48,r));break;case "h":d=a.createLinearGradient(z,0,J,0);d.addColorStop(0,
w(b,-48,r));d.addColorStop(1,w(b,48,r));break;case "r":d=a.createRadialGradient(J,o,0,z,o,1);d.addColorStop(1,w(b,-48,r));d.addColorStop(0,w(b,48,r))}return d?a.fillStyle=d:false},K=function(b){if(b&&a.hasOwnProperty("shadowBlur")){b=b.split(/[ ,;:-]/);a.shadowOffsetX=parseInt(b[0]||1,10);a.shadowOffsetY=parseInt(b[1]||1,10);a.shadowBlur=parseInt(b[2]||1,10);a.shadowColor=b[3]||"#000"}},L=function(){if(a.hasOwnProperty("clearShadow"))a.clearShadow();else if(a.hasOwnProperty("shadowBlur")){a.shadowOffsetX=
0;a.shadowOffsetY=0;a.shadowBlur=0;a.shadowColor="rgba(0,0,0,0)"}},qa=function(){if(B){K(B.shadow);a.font=B.font;a.textAlign="left";a.textBaseline="top";a.fillStyle=B.color;a.fillText(B.text,B.x,B.y);L()}},ea=function(b,d,g,c,h){if(k.x&&b%k.x==0){b=q[0].lab[b]||b;K(k.shadow);a.font=k.font;a.fillStyle=k.color;a.textAlign=c||"center";a.textBaseline=h||"alphabetic";a.fillText(b,d,g);L()}if(k.marks){a.save();a.lineWidth=1;a.moveTo(d,o);a.lineTo(d,o+k.marks);a.strokeStyle=k.color;a.stroke();a.restore()}},
sa=function(b,d){a.save();a.font=m.font;var g,c,h,i=b.length,f,v,l=0,D=0,X=P(m.font),e=X/2,k=X+3,j,p,n=G;p=0;j=M;var ra=0;b.sort(function(a,b){return parseInt(b.v,10)-parseInt(a.v,10)});for(c=0;c<i;c++){f=b[c];h=q[f.nds].lab[f.n];v=q[f.nds].tit;if(h=typeof m.text=="function"?m.text(f.n,f.v,h,f.x,f.y):m.text.replace("%v",f.v).replace("%l",h).replace("%n",f.n).replace("%t",v)){f.lines=h.split(/\n|\\n/);f.h=f.lines.length*k;f.h2=Math.floor(f.h/2);f.w=0;for(g in f.lines)if((h=a.measureText(f.lines[g]).width+
6)>f.w)f.w=h;if(f.w>D)D=f.w;l=l+f.h;f.r++;n>f.x-f.r&&(n=f.x-f.r);p<f.x+f.r&&(p=f.x+f.r);if(j>f.y)j=f.y;if(ra<f.y)ra=f.y}}i>1&&(D=D+(6+X));if(l){l=l+3;if(d){p=n+(p-n)/2-D/2;p+D>G&&(p=G-1-D)}else p+D>=G&&(p=n-D);p<1&&(p=1);p=Math.floor(p)+0.5;g=p+D;c=j+l/2+l/2;c>o&&(c=o-1);c=Math.floor(c)+0.5;f=c-l;a.beginPath();a.moveTo(p,c);a.lineTo(g,c);a.lineTo(g,f);a.lineTo(p,f);a.closePath();if(m.bullet){K(m.shadowbox);a.strokStyle="";a.fillStyle=m.bullet;a.fill();L()}if(m.border){a.lineWidth=1;a.lineJoin="round";
a.strokeStyle=m.border;a.stroke()}a.textAlign="left";a.textBaseline="top";j=f+3;for(c=0;c<i;c++){f=b[c];l=p+3;if(i>1){a.beginPath();a.arc(l+e,j+e,e,0,2*Math.PI);a.fillStyle=q[f.nds].col;a.fill();l=l+(X+3)}K(m.shadow);a.fillStyle=m.color;for(g=0;g<f.lines.length;++g,j=j+k)a.fillText(f.lines[g],l,j);L()}}a.restore()},fa={line:function(b,d){var g=y,c=b?E?C/E:0:H?C/H:0,h,i,f,v,l,j=function(a,b,c,g,f,h){for(var i,e,l,v,k,j;f<=h;)if(g[f]===null)f++;else if(d){i=b[f];e=c[f];for(f++;f<=h&&g[f]===null;)f++;
if(f>h)a.lineTo(i,e);else{l=(i+b[f])/2;v=(e+c[f])/2;k=(i+l)/2;j=(e+v)/2;a.quadraticCurveTo(i,e,k,j);k=(l+b[f])/2;j=(v+c[f])/2;a.quadraticCurveTo(l,v,k,j)}}else{a.lineTo(b[f],c[f]);f++}};a.lineWidth=W;a.lineJoin=ta;for(n=[];h=q[--g];)if((l=h.val.length)>1){var e=[],k=[];for(i=0;i<l;++i){v=0;if(b)for(f=0;f<=g;f++)v=v+q[f].val[i];else v=h.val[i];e.push(z+Math.round(i*(I/(l-1))));k.push(o-Math.round(c*v))}n.push({x:e,y:k,v:q[g].val,nds:g});i--;e.push(z+Math.round(i*(I/(l-1))));k.push(o-Math.round(c*v));
for(i=0;h.val[i]===null;)i++;for(f=l-1;h.val[f]===null;)f--;if(i<=f&&da(h.col)){a.beginPath();a.moveTo(e[i],o);a.lineTo(e[i],k[i]);j(a,e,k,h.val,i,f);a.lineTo(e[f],o);a.closePath();a.fill()}a.strokeStyle=h.col;a.beginPath();a.moveTo(e[i],k[i]);j(a,e,k,h.val,i,f);a.stroke();if(g==0)for(i=0;i<l;++i)ea(i,e[i],M-1);if(ka){a.fillStyle=h.col;for(i=0;i<l;++i)if(h.val[i]!=void 0){a.beginPath();a.arc(e[i],k[i],ka,0,2*Math.PI);a.closePath();a.fill()}}}},curve:function(a){fa.line(a,true)},chart:function(b){var d=
y;n=[];if(d){var g,c,h=q[0].len,i=d>1?4:0,f=b?1:d,e=h&&d?(I-i*(h-1))/h/f-1:0,l,k,j,m=z,F,s,p=b?E?C/E:0:H?C/H:0;e<0&&(e=0);a.lineWidth=W;a.lineJoin="miter";for(c=0;c<d;c++)n.push({x:[],y:[],v:[],nds:c});for(g=0;g<h;g++){ea(g,m+(e+1)*f/2,M-1);k=o;for(c=0;c<d;c++){l=q[c];j=b?k:o;k=j-Math.round(p*l.val[g]);F=Math.round(m);s=Math.round(m+e);if(l.val[g]!==null){a.beginPath();a.moveTo(F,j);a.lineTo(F,k);a.lineTo(s,k);a.lineTo(s,j);a.closePath();da(l.col)&&a.fill();a.strokeStyle=l.col;a.stroke()}n[c].x.push(0.5+
Math.floor(m+e/2));n[c].y.push(k);n[c].v.push(l.val[g]);b||(m=m+(e+1))}m=m+(b?e+1+i:i)}}},pie:function(){var b=y;n=[];if(b){var d=0,g=[],c=[],h=Math.PI*2,i=[],f=[];if(b>1){for(var e=0,d=b,b=0;b<d;b++)e=e+q[b].sum;if(e)for(b=0;b<d;b++){g[b]=q[b].sum/e*h;c[b]=q[b].col;i.push(q[b].sum);f.push(Math.round(100*q[b].sum/e))}}else{e=q[0];if(e.sum){d=e.len;for(b=0;b<d;b++){g[b]=e.val[b]/e.sum*h;c[b]=T[b%T.length];i.push(e.val[b]);f.push(Math.round(100*e.val[b]/e.sum))}}}var h=z+Math.round(I/2),e=R+Math.round(C/
2),j=Math.min(C/2,I/2)-1,m=j+k.fontpx,o,s,F=Math.PI*1.5,t,p,u,x,r=O;na=j;aa=h;ba=e;O=r;a.lineWidth=W;a.lineJoin="miter";for(b=0;b<d;b++){t=F+g[b];p=(F+t)/2;n.push({a:F%(2*Math.PI),n:b});if(b===r){o=h+Math.cos(p)*10;s=e+Math.sin(p)*10}else{o=h;s=e}a.beginPath();a.moveTo(o,s);a.arc(o,s,j,F,t,false);a.closePath();da(c[b])&&a.fill();a.strokeStyle=c[b];a.stroke();if(b===r){u=o+m/2*Math.cos(p);x=s+m/2*Math.sin(p)}else ea(i[b],o+m*Math.cos(p),s+m*Math.sin(p),"center","middle");F=t}r!==false&&sa([{x:u,y:x,
r:0,v:i[r]+" ("+f[r]+"%)",n:r,nds:0}],true);n.sort(function(a,b){return a.a-b.a})}}},Y={line:function(b){var d,g=false,c,e,i=m.linewidth||1,f=[];if(n.length){c=n[0];for(d=0;d<c.x.length;++d)if(c.v[d]!=void 0&&(Math.abs(b-c.x[d])<e||g===false)){e=Math.abs(b-c.x[d]);g=d}if(g!==false){for(d=0;d<n.length;++d){c=n[d];if(c.v[g]!=void 0){if(m.border2){a.beginPath();a.lineWidth=i+2;a.arc(c.x[g],c.y[g],m.radius,0,2*Math.PI);if(m.linewidth==0){a.fillStyle=m.border2;a.fill()}else{a.strokeStyle=m.border2;a.stroke()}}a.beginPath();
a.lineWidth=i;a.arc(c.x[g],c.y[g],m.radius,0,2*Math.PI);if(m.linewidth==0){a.fillStyle=m.circle;a.fill()}else{a.strokeStyle=m.circle;a.stroke()}if(m.axis){a.lineWidth=1;if(/x/i.test(m.axis)){for(b=c.y[g]+m.radius;b<o;){a.moveTo(c.x[g],b);b=b+2;b>o&&(b=o);a.lineTo(c.x[g],b);b=b+2}a.stroke()}if(/y/i.test(m.axis)){for(b=c.x[g]+m.radius;b<J;){a.moveTo(b,c.y[g]);b=b+2;b>J&&(b=J);a.lineTo(b,c.y[g]);b=b+2}a.stroke()}}f.push({x:c.x[g],y:c.y[g],r:i/2+1+m.radius,v:c.v[g],n:g,nds:c.nds})}}sa(f)}}},chart:function(a,
d){Y.line(a,d)},curve:function(a,d,e){Y.line(a,d,e,true)},pie:function(a,d){var e,c=0;if(Math.sqrt(Math.pow(a-aa,2)+Math.pow(d-ba,2))<=na){e=Math.PI-Math.atan2(ba-d,a-aa);for(e=(e+3*Math.PI)%(2*Math.PI);c<n.length&&e>n[c].a;)c++;--c<0&&(c=n.length-1);O=n[c].n;S(true)}else if(O!==false){O=false;S(true)}}};S=function(b){var d=u.split(/:/),e=d[0],c=d[1]||false;a.clearRect(0,0,G,M);if(ia){a.fillStyle=ia;a.fillRect(0,0,G,M)}if(/chart|line|curve/.test(u)){var h,i;a.lineWidth=s.linewidth||1;a.strokeStyle=
s.color;if(s.x){d=0;for(h=s.x.length;d<h;++d){i=z+Math.round(I*s.x[d]/100);a.beginPath();a.moveTo(i,R);a.lineTo(i,o);a.stroke()}}if(s.y){d=0;for(h=s.y.length;d<h;++d){i=o-Math.round(C*s.y[d]/100);a.beginPath();a.moveTo(z,i);a.lineTo(J,i);a.stroke()}}}if(y&&k.y&&/chart|line|curve/.test(u)){var d=/\:[r|s]/.test(u)?E:H,f,j,l,n=d<10?100:d<100?10:1;K(k.shadow);a.font=k.font;a.fillStyle=k.color;a.textBaseline="middle";h=0;for(i=k.y.length;h<i;++h){j=o-Math.round(C*k.y[h]/100);l=Math.round(n*d*k.y[h]/100)/
n;if(/r/i.test(k.ypos)){f=J+1;a.textAlign="left";a.fillText(l,f,j)}if(/l/i.test(k.ypos)){f=z-2;a.textAlign="right";a.fillText(l,f,j)}}L()}if(B&&B.z=="top"){fa[e](c);qa()}else{qa();fa[e](c)}if(t!==false&&y>1){a.save();a.font=t.font;var r;l=0;h=P(t.font)+3;i=h-3;f=y;r=3+h*f;j=t.x;for(var w=t.y,d=0;d<f;++d)if((n=a.measureText(q[d].tit)).width>l)l=n.width;n=9+i+l;a.lineWidth=1;if(l=t.background){K(t.shadowbox);a.fillStyle=l;a.fillRect(j,w,n,r);L()}if(l=t.border){a.strokeStyle=l;a.strokeRect(j,w,n,r)}d=
0;for(n=w+3;d<f;++d,n=n+h){r=q[d];K(t.shadow);a.fillStyle=r.col;a.fillRect(j+3,n,i,i);L();if(l=t.border2){a.strokeStyle=l;a.strokeRect(j+3,n,i,i)}K(t.shadow);a.textAlign="left";a.textBaseline="top";a.fillStyle=t.color;a.fillText(r.tit,j+6+i,n);L()}a.restore()}if(!b){x.onmouseover=x.onmousemove=x.onmouseout=void 0;O=false;if(m){$=a.getImageData(0,0,G,M);if(A)Y[e](A.x,A.y,c);x.onmouseover=function(a){A=ha(a)};x.onmousemove=function(b){if(A){e!="pie"&&a.putImageData($,0,0);A=ha(b);Y[e](A.x,A.y,c)}};
x.onmouseout=function(){A=void 0;a.putImageData($,0,0)}}else A=void 0}};k.fontpx=P(k.font);/none|false/.test(s.x)&&(s.x=[]);/none|false/.test(s.y)&&(s.y=[]);z=e[3]+0.5;R=e[0]+0.5;I=Math.max(G-e[1]-e[3],0);C=Math.max(M-e[0]-e[2],0);J=z+I;o=R+C;j.datas&&pa(j.datas);S();return{canvas:x,data:q,clear:function(){q=[];y=0;return this},load:function(a){pa(a);return this},cls:function(){return this},draw:function(a){a&&(u=a.toLowerCase());S();return this}}},plotter=harry;
