// harry plotter 0.8
// ~L~ nikomomo@gmail.com 2009-2012
// https://github.com/nikopol/Harry-Plotter
var harry=function(e){var U="#88a4d7 #d685c9 #86d685 #ffc34f #93c2ea #f28989 #f9eb8a".split(" "),E=function(b,a,g){var c,b=b&&b.constructor==Array&&3==b.length?b:(c=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(b))?[parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10)]:(c=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(b))?[2.55*parseFloat(c[1]),2.55*parseFloat(c[2]),2.55*parseFloat(c[3])]:(c=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(b))?[parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],16)]:(c=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(b))?[parseInt(c[1]+c[1],16),parseInt(c[2]+c[2],16),parseInt(c[3]+c[3],16)]:[0,0,0];"array"!=typeof a&&(a=[a,a,a]);for(c=0;3>c;++c)b[c]=Math.max(Math.min(b[c]+a[c],255),0);return void 0!=g?"rgba("+b.join(",")+","+g+")":"rgb("+b.join(",")+")"},Q=function(b){var a=b.match(/\d+px/i);return a?parseInt(a,10):(a=b.match(/[0-9\.]+em/i))?Math.floor(16*parseFloat(a)):(a=b.match(/\d+pt/i))?Math.floor(1.3333*
parseInt(a,10)):10},ga=function(b){var a=Math.floor(b).toString(),g=parseInt(a.substr(0,1),10);return g*parseFloat("1E"+(a.length-1))==b?b:(g+1)*parseFloat("1E"+(a.length-1))},R=function(a,d){if("object"==typeof d)for(var g in d)a[g]=d[g];return a},ha=function(a){a=a||window.event;if("offsetX"in a)return{x:a.offsetX,y:a.offsetY};for(var d=a.target,a={x:a.pageX,y:a.pageY};d.offsetParent;)a.x-=d.offsetLeft,a.y-=d.offsetTop,d=d.offsetParent;return a},h;if(e.canvas)h=document.getElementById(e.canvas);
else{h=e.container;var O=e.width||300,Z=e.height||150,V=document.createElement("canvas");V.setAttribute("width",O+"px");V.setAttribute("height",Z+"px");(h?document.getElementById(h):document.body).appendChild(V);h=V}var y=h,H=y.width,N=y.height,a=y.getContext("2d"),$,ia=e.background,w=e.mode||"line",ja=(e.fill||"a")[0].toLowerCase().replace(/[^nasvhrdl]/,"a"),u=parseFloat(e.opacity)||1,W=parseInt(e.linewidth,10)||1,sa=e.linejoin||"miter",ka=parseInt(e.radiuspoint,10)||0,la=!1===e.autoscale?!1:!0,
m=R({color:"#a0a0a0",font:'normal 9px "Sans Serif"',marks:0,ypos:"right"},e.labels),l=!1===e.mouseover?!1:R({radius:5,linewidth:W,circle:"#888",font:'normal 10px "Sans Serif"',color:"#fff",bullet:"rgba(99,99,99,0.8)",border:"#fff",axis:!1,text:"%v"},e.mouseover),B,o=[],P=!1,ma,aa,ba;e.margins?h=e.margins:(O=w,h=Q(m.font),/pie/.test(O)?(h=m.x?2*h:!1===l?0:15,h=[h,h,h,h]):(O=Math.floor(h/2),Z=m.marks,h=[m.y?O:0,m.y&&/right/i.test(m.ypos)?4*h:m.x?h:1,m.x?3+h+Z:m.y?h:1,m.y&&/left/i.test(m.ypos)?4*h:m.x?
O:0]));var s=R({color:"#a0a0a0",x:[0,100],y:[0,25,50,75,100]},e.grid),C=e.title?R({font:'bold 12px "Sans Serif"',color:"rgba(4,4,4,0.3)",x:h[3]+2.5,y:h[0]+2.5,z:"top"},e.title):!1,v=!1===e.legends?!1:R({x:h[3]+2.5,y:h[0]+2.5+(e.title&&!e.title.x?2+Q(C.font):0),color:"#666",border2:"#fff",font:'10px "Sans Serif"'},e.legends),r=[],ca,I,z=0,F,A,S,J,D,K,p,T,na=function(a){var d,g=a.values||a,c=a.labels||[],j={val:[],lab:[],len:0,sum:0,avg:0,max:0,min:0xffffffffffff,tit:a.title||"dataset#"+(r.length+1),
col:a.color||U[r.length%U.length]};for(d in g){a=parseFloat(g[d]);j.val.push(g[d]==null?null:a);j.lab.push(c[d]||d);j.sum=j.sum+a;if(a>j.max)j.max=a;if(a<j.min)j.min=a}j.len=j.val.length;j.avg=j.len?j.sum/j.len:0;r.push(j);z=r.length;if(z==1){ca=j.min;F=I=la?ga(j.max):j.max}else{ca=Math.min(j.min,ca);I=Math.max(j.max,I);d=F=0;for(g=r[0].val.length;d<g;++d){for(a=c=0;a<r.length;++a)c=c+(r[a].val[d]||0);c>F&&(F=la?ga(c):c)}}},oa=function(a){if(a instanceof Array&&typeof a[0]=="object")for(var d=0,g=
a.length;d<g;++d)na(a[d]);else na(a)},da=function(b){var d,g;if(ja=="a"){u=1;g=/\:river/.test(w)?"v":/line/.test(w)||/curve/.test(w)?z>1?"n":"v":/chart/.test(w)?z>1?"s":"v":/pie/.test(w.test)?"r":"s"}else g=ja;switch(g){case "s":d=E(b,0,u);break;case "l":d=E(b,21,u);break;case "d":d=E(b,-21,u);break;case "v":d=a.createLinearGradient(0,p,0,S);d.addColorStop(0,E(b,-48,u));d.addColorStop(1,E(b,48,u));break;case "h":d=a.createLinearGradient(A,0,K,0);d.addColorStop(0,E(b,-48,u));d.addColorStop(1,E(b,48,
u));break;case "r":d=a.createRadialGradient(K,p,0,A,p,1);d.addColorStop(1,E(b,-48,u));d.addColorStop(0,E(b,48,u))}return d?a.fillStyle=d:false},L=function(b){if(b&&a.hasOwnProperty("shadowBlur")){b=b.split(/[ ,;:-]/);a.shadowOffsetX=parseInt(b[0]||1,10);a.shadowOffsetY=parseInt(b[1]||1,10);a.shadowBlur=parseInt(b[2]||1,10);a.shadowColor=b[3]||"#000"}},M=function(){if(a.hasOwnProperty("clearShadow"))a.clearShadow();else if(a.hasOwnProperty("shadowBlur")){a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=
0;a.shadowColor="rgba(0,0,0,0)"}},pa=function(){if(C){L(C.shadow);a.font=C.font;a.textAlign="left";a.textBaseline="top";a.fillStyle=C.color;a.fillText(C.text,C.x,C.y);M()}},ea=function(b,d,g,c,j){if(m.x&&b%m.x==0){b=r[0].lab[b]||b;L(m.shadow);a.font=m.font;a.fillStyle=m.color;a.textAlign=c||"center";a.textBaseline=j||"alphabetic";a.fillText(b,d,g);M()}if(m.marks){a.save();a.lineWidth=1;a.moveTo(d,p);a.lineTo(d,p+m.marks);a.strokeStyle=m.color;a.stroke();a.restore()}},ra=function(b,d){a.save();a.font=
l.font;var g,c,j,i=b.length,f,x,k=0,n=0,X=Q(l.font),h=X/2,m=X+3,e,q,o=H;q=0;e=N;var qa=0;b.sort(function(a,b){return parseInt(b.v,10)-parseInt(a.v,10)});for(c=0;c<i;c++){f=b[c];j=r[f.nds].lab[f.n];x=r[f.nds].tit;if(j=typeof l.text=="function"?l.text(f.n,f.v,j,f.x,f.y):l.text.replace("%v",f.v).replace("%l",j).replace("%n",f.n).replace("%t",x)){f.lines=j.split(/\n|\\n/);f.h=f.lines.length*m;f.h2=Math.floor(f.h/2);f.w=0;for(g in f.lines)if((j=a.measureText(f.lines[g]).width+6)>f.w)f.w=j;if(f.w>n)n=f.w;
k=k+f.h;f.r++;o>f.x-f.r&&(o=f.x-f.r);q<f.x+f.r&&(q=f.x+f.r);if(e>f.y)e=f.y;if(qa<f.y)qa=f.y}}i>1&&(n=n+(6+X));if(k){k=k+3;if(d){q=o+(q-o)/2-n/2;q+n>H&&(q=H-1-n)}else q+n>=H&&(q=o-n);q<1&&(q=1);q=Math.floor(q)+0.5;g=q+n;c=e+k/2+k/2;c>p&&(c=p-1);c=Math.floor(c)+0.5;f=c-k;a.beginPath();a.moveTo(q,c);a.lineTo(g,c);a.lineTo(g,f);a.lineTo(q,f);a.closePath();L(l.shadowbox);a.fillStyle=l.bullet;a.fill();M();a.lineWidth=1;a.lineJoin="round";a.strokeStyle=l.border;a.stroke();a.textAlign="left";a.textBaseline=
"top";e=f+3;for(c=0;c<i;c++){f=b[c];k=q+3;if(i>1){a.beginPath();a.arc(k+h,e+h,h,0,2*Math.PI);a.fillStyle=r[f.nds].col;a.fill();k=k+(X+3)}L(l.shadow);a.fillStyle=l.color;for(g=0;g<f.lines.length;++g,e=e+m)a.fillText(f.lines[g],k,e);M()}}a.restore()},fa={line:function(b,d){var g=z,c=b?F?D/F:0:I?D/I:0,j,i,f,x,k,n=function(a,b,c,g,f,j){for(var i,e,k,h,x,n;f<=j;)if(g[f]===null)f++;else if(d){i=b[f];e=c[f];for(f++;f<=j&&g[f]===null;)f++;if(f>j)a.lineTo(i,e);else{k=(i+b[f])/2;h=(e+c[f])/2;x=(i+k)/2;n=(e+
h)/2;a.quadraticCurveTo(i,e,x,n);x=(k+b[f])/2;n=(h+c[f])/2;a.quadraticCurveTo(k,h,x,n)}}else{a.lineTo(b[f],c[f]);f++}};a.lineWidth=W;a.lineJoin=sa;for(o=[];j=r[--g];)if((k=j.val.length)>1){var e=[],h=[];for(i=0;i<k;++i){x=0;if(b)for(f=0;f<=g;f++)x=x+r[f].val[i];else x=j.val[i];e.push(A+Math.round(i*(J/(k-1))));h.push(p-Math.round(c*x))}o.push({x:e,y:h,v:r[g].val,nds:g});i--;e.push(A+Math.round(i*(J/(k-1))));h.push(p-Math.round(c*x));for(i=0;j.val[i]===null;)i++;for(f=k-1;j.val[f]===null;)f--;if(i<=
f&&da(j.col)){a.beginPath();a.moveTo(e[i],p);a.lineTo(e[i],h[i]);n(a,e,h,j.val,i,f);a.lineTo(e[f],p);a.closePath();a.fill()}a.strokeStyle=j.col;a.beginPath();a.moveTo(e[i],h[i]);n(a,e,h,j.val,i,f);a.stroke();if(g==0)for(i=0;i<k;++i)ea(i,e[i],N-1);if(ka){a.fillStyle=j.col;for(i=0;i<k;++i)if(j.val[i]!=void 0){a.beginPath();a.arc(e[i],h[i],ka,0,2*Math.PI);a.closePath();a.fill()}}}},curve:function(a){fa.line(a,true)},chart:function(b){var d=z;o=[];if(d){var g,c,j=r[0].len,i=d>1?4:0,f=b?1:d,e=j&&d?(J-
i*(j-1))/j/f-1:0,k,h,m,l=A,G,s,q=b?F?D/F:0:I?D/I:0;e<0&&(e=0);a.lineWidth=W;a.lineJoin="miter";for(c=0;c<d;c++)o.push({x:[],y:[],v:[],nds:c});for(g=0;g<j;g++){ea(g,l+(e+1)*f/2,N-1);h=p;for(c=0;c<d;c++){k=r[c];m=b?h:p;h=m-Math.round(q*k.val[g]);G=Math.round(l);s=Math.round(l+e);if(k.val[g]!==null){a.beginPath();a.moveTo(G,m);a.lineTo(G,h);a.lineTo(s,h);a.lineTo(s,m);a.closePath();da(k.col)&&a.fill();a.strokeStyle=k.col;a.stroke()}o[c].x.push(0.5+Math.floor(l+e/2));o[c].y.push(h);o[c].v.push(k.val[g]);
b||(l=l+(e+1))}l=l+(b?e+1+i:i)}}},pie:function(){var b=z;o=[];if(b){var d=0,g=[],c=[],j=Math.PI*2,i=[],f=[];if(b>1){for(var e=0,d=b,b=0;b<d;b++)e=e+r[b].sum;if(e)for(b=0;b<d;b++){g[b]=r[b].sum/e*j;c[b]=r[b].col;i.push(r[b].sum);f.push(Math.round(100*r[b].sum/e))}}else{e=r[0];if(e.sum){d=e.len;for(b=0;b<d;b++){g[b]=e.val[b]/e.sum*j;c[b]=U[b%U.length];i.push(e.val[b]);f.push(Math.round(100*e.val[b]/e.sum))}}}var j=A+Math.round(J/2),e=S+Math.round(D/2),h=Math.min(D/2,J/2)-1,l=h+m.fontpx,p,s,G=Math.PI*
1.5,v,q,w,y,u=P;ma=h;aa=j;ba=e;P=u;a.lineWidth=W;a.lineJoin="miter";for(b=0;b<d;b++){v=G+g[b];q=(G+v)/2;o.push({a:G%(2*Math.PI),n:b});if(b===u){p=j+Math.cos(q)*10;s=e+Math.sin(q)*10}else{p=j;s=e}a.beginPath();a.moveTo(p,s);a.arc(p,s,h,G,v,false);a.closePath();da(c[b])&&a.fill();a.strokeStyle=c[b];a.stroke();if(b===u){w=p+l/2*Math.cos(q);y=s+l/2*Math.sin(q)}else ea(i[b],p+l*Math.cos(q),s+l*Math.sin(q),"center","middle");G=v}u!==false&&ra([{x:w,y:y,r:0,v:i[u]+" ("+f[u]+"%)",n:u,nds:0}],true);o.sort(function(a,
b){return a.a-b.a})}}},Y={line:function(b){var d,g=false,c,e,i=l.linewidth||1,f=[];if(o.length){c=o[0];for(d=0;d<c.x.length;++d)if(c.v[d]!=void 0&&(Math.abs(b-c.x[d])<e||g===false)){e=Math.abs(b-c.x[d]);g=d}if(g!==false){for(d=0;d<o.length;++d){c=o[d];if(c.v[g]!=void 0){if(l.border){a.beginPath();a.lineWidth=i+2;a.arc(c.x[g],c.y[g],l.radius,0,2*Math.PI);if(l.linewidth==0){a.fillStyle=l.border;a.fill()}else{a.strokeStyle=l.border;a.stroke()}}a.beginPath();a.lineWidth=i;a.arc(c.x[g],c.y[g],l.radius,
0,2*Math.PI);if(l.linewidth==0){a.fillStyle=l.circle;a.fill()}else{a.strokeStyle=l.circle;a.stroke()}if(l.axis){a.lineWidth=1;if(/x/i.test(l.axis)){for(b=c.y[g]+l.radius;t<p;){a.moveTo(c.x[g],b);b=b+2;b>p&&(b=p);a.lineTo(c.x[g],b);b=b+2}a.stroke()}if(/y/i.test(l.axis)){for(b=c.x[g]+l.radius;b<K;){a.moveTo(b,c.y[g]);b=b+2;b>K&&(b=K);a.lineTo(b,c.y[g]);b=b+2}a.stroke()}}f.push({x:c.x[g],y:c.y[g],r:i/2+1+l.radius,v:c.v[g],n:g,nds:c.nds})}}ra(f)}}},chart:function(a,d){Y.line(a,d)},curve:function(a,d,
g){Y.line(a,d,g,true)},pie:function(a,d){var g,c=0;if(Math.sqrt(Math.pow(a-aa,2)+Math.pow(d-ba,2))<=ma){g=Math.PI-Math.atan2(ba-d,a-aa);for(g=(g+3*Math.PI)%(2*Math.PI);c<o.length&&g>o[c].a;)c++;--c<0&&(c=o.length-1);P=o[c].n;T(true)}else if(P!==false){P=false;T(true)}}};T=function(b){var d=w.split(/:/),g=d[0],c=d[1]||false;a.clearRect(0,0,H,N);if(ia){a.fillStyle=ia;a.fillRect(0,0,H,N)}if(/chart|line|curve/.test(w)){var e,i;a.lineWidth=s.linewidth||1;a.strokeStyle=s.color;if(s.x){d=0;for(e=s.x.length;d<
e;++d){i=A+Math.round(J*s.x[d]/100);a.beginPath();a.moveTo(i,S);a.lineTo(i,p);a.stroke()}}if(s.y){d=0;for(e=s.y.length;d<e;++d){i=p-Math.round(D*s.y[d]/100);a.beginPath();a.moveTo(A,i);a.lineTo(K,i);a.stroke()}}}if(z&&m.y&&/chart|line|curve/.test(w)){var d=/\:[r|s]/.test(w)?F:I,f,h,k,n=d<10?100:d<100?10:1;L(m.shadow);a.font=m.font;a.fillStyle=m.color;a.textBaseline="middle";e=0;for(i=m.y.length;e<i;++e){h=p-Math.round(D*m.y[e]/100);k=Math.round(n*d*m.y[e]/100)/n;if(/right/i.test(m.ypos)){f=K+1;a.textAlign=
"left";a.fillText(k,f,h)}if(/left/i.test(m.ypos)){f=A-2;a.textAlign="right";a.fillText(k,f,h)}}M()}if(C&&C.z=="top"){fa[g](c);pa()}else{pa();fa[g](c)}if(v!==false&&z>1){a.save();a.font=v.font;var o;k=0;e=Q(v.font)+3;i=e-3;f=z;o=3+e*f;h=v.x;for(var u=v.y,d=0;d<f;++d)if((n=a.measureText(r[d].tit)).width>k)k=n.width;n=9+i+k;a.lineWidth=1;if(k=v.background){L(v.shadowbox);a.fillStyle=k;a.fillRect(h,u,n,o);M()}if(k=v.border){a.strokeStyle=k;a.strokeRect(h,u,n,o)}d=0;for(n=u+3;d<f;++d,n=n+e){o=r[d];L(v.shadow);
a.fillStyle=o.col;a.fillRect(h+3,n,i,i);M();if(k=v.border2){a.strokeStyle=k;a.strokeRect(h+3,n,i,i)}L(v.shadow);a.textAlign="left";a.textBaseline="top";a.fillStyle=v.color;a.fillText(o.tit,h+6+i,n);M()}a.restore()}if(!b){y.onmouseover=y.onmousemove=y.onmouseout=void 0;P=false;if(l){$=a.getImageData(0,0,H,N);if(B)Y[g](B.x,B.y,c);y.onmouseover=function(a){B=ha(a)};y.onmousemove=function(b){if(B){g!="pie"&&a.putImageData($,0,0);B=ha(b);Y[g](B.x,B.y,c)}};y.onmouseout=function(){B=void 0;a.putImageData($,
0,0)}}else B=void 0}};m.fontpx=Q(m.font);/none|false/.test(s.x)&&(s.x=[]);/none|false/.test(s.y)&&(s.y=[]);A=h[3]+0.5;S=h[0]+0.5;J=Math.max(H-h[1]-h[3],0);D=Math.max(N-h[0]-h[2],0);K=A+J;p=S+D;e.datas&&oa(e.datas);T();return{canvas:y,data:r,clear:function(){r=[];z=0;return this},load:function(a){oa(a);return this},cls:function(){return this},draw:function(a){a&&(w=a.toLowerCase());T();return this}}},plotter=harry;
