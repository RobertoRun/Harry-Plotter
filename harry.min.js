// harry plotter 0.7
// ~L~ nikomomo@gmail.com 2009-2012
// https://github.com/nikopol/Harry-Plotter
var harryTools={COLORS:"#88a4d7 #d685c9 #86d685 #ffc34f #93c2ea #f28989 #f9eb8a".split(" "),count:0,getRGB:function(a){var b;return a&&a.constructor==Array&&3==a.length?a:(b=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(a))?[parseInt(b[1],10),parseInt(b[2],10),parseInt(b[3],10)]:(b=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(a))?[2.55*parseFloat(b[1]),2.55*parseFloat(b[2]),2.55*parseFloat(b[3])]:(b=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(a))?
[parseInt(b[1],16),parseInt(b[2],16),parseInt(b[3],16)]:(b=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(a))?[parseInt(b[1]+b[1],16),parseInt(b[2]+b[2],16),parseInt(b[3]+b[3],16)]:[0,0,0]},calcColor:function(a,b,c){a=harryTools.getRGB(a);"array"!=typeof b&&(b=[b,b,b]);for(var f=0;3>f;++f)a[f]=Math.max(Math.min(a[f]+b[f],255),0);return void 0!=c?"rgba("+a.join(",")+","+c+")":"rgb("+a.join(",")+")"},fontPixSize:function(a){var b=a.match(/\d+px/i);return b?parseInt(b,10):(b=a.match(/[0-9\.]+em/i))?
Math.floor(16*parseFloat(b,10)):(b=a.match(/\d+pt/i))?Math.floor(1.3333*parseInt(b,10)):10},scaleUp:function(a){var b=Math.floor(a).toString(),c=parseInt(b.substr(0,1));return c*parseFloat("1E"+(b.length-1))==a?a:(c+1)*parseFloat("1E"+(b.length-1))},merge:function(a,b){if("object"==typeof b)for(var c in b)a[c]=b[c];return a},mouseXY:function(a){return{x:void 0!=a.offsetX&&a.offsetX||void 0!=a.layerX&&a.layerX||void 0!=a.clientX&&a.clientX,y:void 0!=a.offsetY&&a.offsetY||void 0!=a.layerY&&a.layerY||
void 0!=a.clientY&&a.clientY}}},harry=function(a){this.clear();a.canvas?this.canvas=document.getElementById(a.canvas):(this.canvas=document.createElement("canvas"),a.id&&this.canvas.setAttribute("id",a.id),document.getElementById(a.container).appendChild(this.canvas),this.canvas.setAttribute("width",(a.width||300)+"px"),this.canvas.setAttribute("height",(a.height||150)+"px"));this.w=this.canvas.width;this.h=this.canvas.height;this.id=a.id||"harry"+ ++harryTools.count;this.bg=a.background;this.setMode(a.mode);
this.fill=(a.fill||"auto")[0].toLowerCase().replace(/[^nasvhrdl]/,"a");this.opacity=parseFloat(a.opacity,10)||1;this.linewidth=parseInt(a.linewidth,10)||1;this.linejoin=a.linejoin||"miter";this.radiuspoint=parseInt(a.radiuspoint,10)||0;this.labels=a.labels||{};this.labels.color=this.labels.color||"#a0a0a0";this.labels.font=this.labels.font||'normal 9px "Sans Serif"';this.labels.fontpx=harryTools.fontPixSize(this.labels.font);this.autoscale=!1===a.autoscale?!1:!0;this.mouseover=!1===a.mouseover?!1:
harryTools.merge({radius:5,linewidth:this.linewidth,circle:"#888",font:'normal 10px "Sans Serif"',color:"#fff",bullet:"#888",border:"#fff",axis:!1,text:"%v"},a.mouseover);this.legends=!1===a.legends?!1:harryTools.merge({x:5,y:5,color:"#666",border2:"#fff",background:"rgba(255,255,255,0.5)",font:'10px "Sans Serif"'},a.legends);if(a.margins)this.margins=a.margins;else if(/pie/.test(this.mode)){var b=this.labels.x?2*this.labels.fontpx:0;this.margins=[b,b,b,b]}else{var b=this.labels.fontpx,c=Math.floor(this.labels.fontpx/
2);this.margins=[this.labels.y?c:0,this.labels.y?4*b:1,this.labels.x?2+b:1,this.labels.x?c:0]}this.grid=a.grid||{};this.grid.color=this.grid.color||"#a0a0a0";this.grid.x=this.grid.x||[0,100];/none|false/.test(this.grid.x)&&(this.grid.x=[]);this.grid.y=this.grid.y||[0,25,50,75,100];/none|false/.test(this.grid.y)&&(this.grid.y=[]);"string"==typeof a.title&&(a.title={text:a.title});this.title=a.title?harryTools.merge({font:'bold 12px "Sans Serif"',color:"rgba(4,4,4,0.3)",x:this.margins[3]+2,y:this.margins[0]+
2,z:"top"},a.title):!1;this.gc=this.canvas.getContext("2d");a.datas&&this.addDataSets(a.datas);this.rx=this.margins[3]+0.5;this.ry=this.margins[0]+0.5;this.rw=Math.max(this.w-this.margins[1]-this.margins[3],0);this.rh=Math.max(this.h-this.margins[0]-this.margins[2],0);this.rx2=this.rx+this.rw;this.ry2=this.ry+this.rh;this.overpie={n:!1};this.cls().draw()};
harry.prototype={clear:function(){this.dataset=[];this.dmin=4294967295;this.dmax=0;return this},setMode:function(a){this.mode=a||"line";return this},addDataSets:function(a){if(a.constructor==Array&&"object"==typeof a[0])for(var b=0,c=a.length;b<c;++b)this.addDataSet(a[b]);else this.addDataSet(a);return this},addDataSet:function(a){var b,c=a.values||a,f=a.labels||[],e={val:[],lab:[],len:0,sum:0,avg:0,max:0,min:0xffffffffffff,tit:a.title||"dataset#"+(this.dataset.length+1),col:a.color||harryTools.COLORS[this.dataset.length%
harryTools.COLORS.length]};for(b in c)if(a=parseFloat(c[b],10),e.val.push(null==c[b]?null:a),e.lab.push(f[b]||b),e.sum+=a,a>e.max&&(e.max=a),a<e.min)e.min=a;e.len=e.val.length;e.avg=e.len?e.sum/e.len:0;this.dataset.push(e);this.dlen=this.dataset.length;if(1==this.dlen)this.dmin=e.min,this.dsum=this.dmax=this.autoscale?harryTools.scaleUp(e.max):e.max;else{this.dmin=Math.min(e.min,this.dmin);this.dmax=Math.max(e.max,this.dmax);b=this.dsum=0;for(c=this.dataset[0].val.length;b<c;++b){for(a=f=0;a<this.dataset.length;++a)f+=
this.dataset[a].val[b]||0;f>this.dsum&&(this.dsum=this.autoscale?harryTools.scaleUp(f):f)}}return this},draw:function(a,b){this.mode=(a||this.mode).toLowerCase();var c=this.mode.split(/:/),f=this,e=c[0]+"Over";this.drawGrid().drawYLabels();if(this.title&&"top"==this.title.z)this[c[0]](1==c.length?!1:c[1]).drawTitle();else this.drawTitle()[c[0]](1==c.length?!1:c[1]);this.drawLegends();if(!b)if(this.canvas.onmouseover=this.canvas.onmousemove=this.canvas.onmouseout=void 0,this.overpie.n=!1,this.mouseover&&
this[c[0]+"Over"]){this.imgdata=this.gc.getImageData(0,0,this.w,this.h);if(this.mousepos)f[e](f.mousepos.x,f.mousepos.y,c[1]);this.canvas.onmouseover=function(a){f.mousepos=harryTools.mouseXY(a)};this.canvas.onmousemove=function(a){f.mousepos&&("pie"!=c[0]&&f.gc.putImageData(f.imgdata,0,0),f.mousepos=harryTools.mouseXY(a||window.event),f[e](f.mousepos.x,f.mousepos.y,c[1]))};this.canvas.onmouseout=function(){f.mousepos=void 0;f.gc.putImageData(f.imgdata,0,0)}}else this.mousepos=void 0;return this},
cls:function(){this.gc.clearRect(0,0,this.w,this.h);this.bg&&(this.gc.fillStyle=this.bg,this.gc.fillRect(0,0,this.w,this.h));return this},drawTitle:function(){this.title&&this.gc.font&&(this.gc.font=this.title.font,this.gc.textAlign="left",this.gc.textBaseline="top",this.gc.fillStyle=this.title.color,this.gc.fillText(this.title.text,this.title.x,this.title.y));return this},drawGrid:function(){if(/chart|line|curve/.test(this.mode)){var a,b,c;this.gc.lineWidth=this.grid.linewidth||1;this.gc.strokeStyle=
this.grid.color;if(this.grid.x){a=0;for(b=this.grid.x.length;a<b;++a)c=this.rx+Math.round(this.rw*this.grid.x[a]/100),this.gc.beginPath(),this.gc.moveTo(c,this.ry),this.gc.lineTo(c,this.ry2),this.gc.stroke()}if(this.grid.y){a=0;for(b=this.grid.y.length;a<b;++a)c=this.ry2-Math.round(this.rh*this.grid.y[a]/100),this.gc.beginPath(),this.gc.moveTo(this.rx,c),this.gc.lineTo(this.rx2,c),this.gc.stroke()}}return this},drawYLabels:function(){if(this.dlen&&(this.labels.y&&this.gc.font)&&/chart|line|curve/.test(this.mode)){var a=
/\:[r|s]/.test(this.mode)?this.dsum:this.dmax,b,c,f,e,m,g=10>a?100:100>a?10:1,h=Math.floor(this.labels.fontpx/2.5);this.gc.font=this.labels.font;this.gc.fillStyle=this.labels.color;this.gc.textAlign="left";b=0;for(c=this.labels.y.length;b<c;++b)f=this.rx2+1,e=this.ry2-Math.round(this.rh*this.labels.y[b]/100),m=Math.round(g*a*this.labels.y[b]/100)/g,this.gc.fillText(m,f,e+h)}return this},drawXLabel:function(a,b,c,f,e){this.gc.font&&(this.labels.x&&0==a%this.labels.x)&&(a=this.dataset[0].lab[a]||a,
this.gc.font=this.labels.font,this.gc.fillStyle=this.labels.color,this.gc.textAlign=f||"center",this.gc.textBaseline=e||"alphabetic",this.gc.fillText(a,b,c));this.labels.marks&&(this.gc.save(),this.gc.lineWidth=1,this.gc.moveTo(b,this.ry2),this.gc.lineTo(b,this.ry2+this.labels.marks),this.gc.strokeStyle=this.labels.color,this.gc.stroke(),this.gc.restore());return this},drawLegends:function(){if(!1!==this.legends&&1<this.dlen){this.gc.save();this.gc.font=this.legends.font;var a,b,c;c=0;var f=harryTools.fontPixSize(this.mouseover.font)+
3,e=f-3,m=this.dlen,g=3+f*m,h=this.legends.x,j=this.legends.y;for(a=0;a<m;++a)if((b=this.gc.measureText(this.dataset[a].tit)).width>c)c=b.width;b=9+e+c;this.gc.lineWidth=1;if(c=this.legends.background)this.gc.fillStyle=c,this.gc.fillRect(h,j,b,g);if(c=this.legends.border)this.gc.strokeStyle=c,this.gc.strokeRect(h,j,b,g);a=0;for(b=j+3;a<m;++a,b+=f){d=this.dataset[a];this.gc.fillStyle=d.col;this.gc.fillRect(h+3,b,e,e);if(c=this.legends.border2)this.gc.strokeStyle=c,this.gc.strokeRect(h+3,b,e,e);this.gc.textAlign=
"left";this.gc.textBaseline="top";this.gc.fillStyle=this.legends.color;this.gc.fillText(d.tit,h+6+e,b)}this.gc.restore()}return this},drawBullet:function(a,b,c,f,e,m,g){this.gc.save();this.gc.font=this.mouseover.font;var h,j,i=0,k=this.dataset[m].lab[e];j="function"==typeof this.mouseover.text?this.mouseover.text(e,f,k,a,b):this.mouseover.text.replace("%v",f).replace("%l",k).replace("%n",e);var e=j.split(/\n|\\n/),f=harryTools.fontPixSize(this.mouseover.font)+3,k=3+e.length*f,l=Math.floor(k/2);if(j){for(h in e)if((j=
this.gc.measureText(e[h]).width+6)>i)i=j;if(g)g=a+c-i/2,g<this.rx&&(g=this.rx),h=g+i,h>this.rx2&&(h=this.rx2-1,g=h-i),b+=k/2,b>this.ry2&&(b=this.ry2-1),a=b-k;else{g=a+c;h=g+i;if(h>=this.rx2||m%2&&0<a-c-i)h=a-c,g=h-i;b+=l;a=b-k;b>=this.rh?(b=this.rh-0.5,a=b-k):0>a&&(a=1.5,b=a+k)}this.gc.beginPath();this.gc.moveTo(g,b);this.gc.lineTo(h,b);this.gc.lineTo(h,a);this.gc.lineTo(g,a);this.gc.closePath();this.gc.fillStyle=this.mouseover.bullet;this.gc.fill();this.gc.lineWidth=1;this.gc.lineJoin="round";this.gc.strokeStyle=
this.mouseover.border;this.gc.stroke();this.gc.textAlign="left";this.gc.textBaseline="top";this.gc.fillStyle=this.mouseover.color;h=0;for(a+=3;h<e.length;++h,a+=f)this.gc.fillText(e[h],g+3,a)}this.gc.restore();return this},pie:function(){var a=this.dlen;this.overpoints=[];if(a){var b=0,c=[],f=[],e=2*Math.PI,m=[],g=/percent/.test(this.labels.x);if(1<a){for(var h=0,b=a,a=0;a<b;a++)h+=this.dataset[a].avg;if(h)for(a=0;a<b;a++)c[a]=this.dataset[a].avg/h*e,f[a]=this.dataset[a].col,m.push(g?Math.round(100*
this.dataset[a].avg/h)+"%":this.dataset[a].avg.toString())}else if(h=this.dataset[0],h.sum){b=h.len;for(a=0;a<b;a++)c[a]=h.val[a]/h.sum*e,f[a]=harryTools.COLORS[a%harryTools.COLORS.length],m.push(g?Math.round(100*h.val[a]/h.sum)+"%":h.val[a].toString())}var e=this.rx+Math.round(this.rw/2),g=this.ry+Math.round(this.rh/2),h=Math.min(this.rh/2,this.rw/2)-1,j=h+1*this.labels.fontpx,i,k,l,n=1.5*Math.PI,p,o,r,s,q=this.overpie.n;this.overpie={r:h,x:e,y:g,n:q};this.gc.lineWidth=this.linewidth;this.gc.lineJoin=
"miter";for(a=0;a<b;a++)p=n+c[a],o=(n+p)/2,this.overpoints.push({a:n%(2*Math.PI),n:a}),a===q?(i=e+10*Math.cos(o),k=g+10*Math.sin(o)):(i=e,k=g),l=this.getGradient(f[a]),this.gc.beginPath(),this.gc.moveTo(i,k),this.gc.arc(i,k,h,n,p,!1),this.gc.closePath(),l&&(this.gc.fillStyle=l,this.gc.fill()),this.gc.strokeStyle=f[a],this.gc.stroke(),a===q?(r=i+j/2*Math.cos(o),s=k+j/2*Math.sin(o)):this.drawXLabel(m[a],i+j*Math.cos(o),k+j*Math.sin(o),"center","middle"),n=p;!1!==q&&this.drawBullet(r,s,0,m[q],q,0,!0);
this.overpoints.sort(function(a,b){return a.a-b.a})}return this},pieOver:function(a,b){var c,f=0;if(Math.sqrt(Math.pow(a-this.overpie.x,2)+Math.pow(b-this.overpie.y,2))<=this.overpie.r){c=Math.PI-Math.atan2(this.overpie.y-b,a-this.overpie.x);for(c=(c+3*Math.PI)%(2*Math.PI);f<this.overpoints.length&&c>this.overpoints[f].a;)f++;0>--f&&(f=this.overpoints.length-1);this.overpie.n=this.overpoints[f].n;this.cls().draw("pie",!0)}else!1!==this.overpie.n&&(this.overpie.n=!1,this.cls().draw("pie",!0));return this},
chart:function(a){var b=this.dlen;this.overpoints=[];if(b){var c,f,e=this.dataset[0].len,m=1<b?4:0,g=a?1:b,h=e&&b?(this.rw-m*(e-1))/e/g-1:0;0>h&&(h=0);var j,i,k,l=this.rx,n,p=a?this.dsum?this.rh/this.dsum:0:this.dmax?this.rh/this.dmax:0;this.gc.lineWidth=this.linewidth;this.gc.lineJoin="miter";for(f=0;f<b;f++)this.overpoints.push({x:[],y:[],v:[],nds:f});for(c=0;c<e;c++){this.drawXLabel(c,l+(h+1)*g/2,this.h-1);k=this.ry2;for(f=0;f<b;f++){j=this.dataset[f];y0=a?k:this.ry2;k=y0-Math.round(p*j.val[c]);
i=Math.round(l);n=Math.round(l+h);if(null!==j.val[c]){this.gc.beginPath();this.gc.moveTo(i,y0);this.gc.lineTo(i,k);this.gc.lineTo(n,k);this.gc.lineTo(n,y0);this.gc.closePath();if(i=this.getGradient(j.col))this.gc.fillStyle=i,this.gc.fill();this.gc.strokeStyle=j.col;this.gc.stroke()}this.overpoints[f].x.push(0.5+Math.floor(l+h/2));this.overpoints[f].y.push(k);this.overpoints[f].v.push(j.val[c]);a||(l+=h+1)}l+=a?h+1+m:m}}return this},chartOver:function(a,b){return this.lineOver(a,b)},curve:function(a){return this.line(a,
!0)},curveOver:function(a,b,c){return this.lineOver(a,b,c,!0)},line:function(a,b){var c=this.dlen,f=a?this.dsum?this.rh/this.dsum:0:this.dmax?this.rh/this.dmax:0,e,m,g,h,j,i,k=function(a,c,e,f,g,h){for(var i,j,k,l,m,n;g<=h;)if(null===f[g])g++;else if(b){i=c[g];j=e[g];for(g++;g<=h&&null===f[g];)g++;g>h?a.lineTo(i,j):(k=(i+c[g])/2,l=(j+e[g])/2,m=(i+k)/2,n=(j+l)/2,a.quadraticCurveTo(i,j,m,n),m=(k+c[g])/2,n=(l+e[g])/2,a.quadraticCurveTo(k,l,m,n))}else a.lineTo(c[g],e[g]),g++};this.gc.lineWidth=this.linewidth;
this.gc.lineJoin=this.linejoin;for(this.overpoints=[];e=this.dataset[--c];)if(1<(i=e.val.length)){var l=[],n=[];for(g=0;g<i;++g){j=0;if(a)for(h=0;h<=c;h++)j+=this.dataset[h].val[g];else j=e.val[g];l.push(this.rx+Math.round(g*(this.rw/(i-1))));n.push(this.ry2-Math.round(f*j))}this.overpoints.push({x:l,y:n,v:this.dataset[c].val,nds:c});g--;l.push(this.rx+Math.round(g*(this.rw/(i-1))));n.push(this.ry2-Math.round(f*j));for(g=0;null===e.val[g];)g++;for(h=i-1;null===e.val[h];)h--;if(g<=h&&(m=this.getGradient(e.col)))this.gc.beginPath(),
this.gc.moveTo(l[g],this.ry2),this.gc.lineTo(l[g],n[g]),k(this.gc,l,n,e.val,g,h),this.gc.lineTo(l[h],this.ry2),this.gc.closePath(),this.gc.fillStyle=m,this.gc.fill();this.gc.strokeStyle=e.col;this.gc.beginPath();this.gc.moveTo(l[g],n[g]);k(this.gc,l,n,e.val,g,h);this.gc.stroke();if(0==c)for(g=0;g<i;++g)this.drawXLabel(g,l[g],this.h);if(this.radiuspoint){this.gc.fillStyle=e.col;for(g=0;g<i;++g)void 0!=e.val[g]&&(this.gc.beginPath(),this.gc.arc(l[g],n[g],this.radiuspoint,0,2*Math.PI),this.gc.closePath(),
this.gc.fill())}}return this},lineOver:function(a,b){var c,f=!1,e,m,g=this.mouseover.linewidth||1;if(this.overpoints.length){e=this.overpoints[0];for(c=0;c<e.x.length;++c)if(void 0!=e.v[c]&&(Math.abs(a-e.x[c])<m||!1===f))m=Math.abs(a-e.x[c]),f=c;if(!1!==f)for(c=0;c<this.overpoints.length;++c)if(e=this.overpoints[c],void 0!=e.v[f]){this.gc.beginPath();this.gc.lineWidth=g;this.gc.arc(e.x[f],e.y[f],this.mouseover.radius,0,2*Math.PI);0==this.mouseover.linewidth?(this.gc.fillStyle=this.mouseover.circle,
this.gc.fill()):(this.gc.strokeStyle=this.mouseover.circle,this.gc.stroke());if(this.mouseover.axis){this.gc.lineWidth=1;if(/x/i.test(this.mouseover.axis)){for(b=e.y[f]+this.mouseover.radius;b<this.ry2;)this.gc.moveTo(e.x[f],b),b+=2,b>this.ry2&&(b=this.ry2),this.gc.lineTo(e.x[f],b),b+=2;this.gc.stroke()}if(/y/i.test(this.mouseover.axis)){for(a=e.x[f]+this.mouseover.radius;a<this.rx2;)this.gc.moveTo(a,e.y[f]),a+=2,a>this.rx2&&(a=this.rx2),this.gc.lineTo(a,e.y[f]),a+=2;this.gc.stroke()}}this.drawBullet(e.x[f],
e.y[f],g/2+1+this.mouseover.radius,e.v[f],f,e.nds,!1)}}return this},getFillMode:function(){return"a"==this.fill?(this.opacity=1,/\:river/.test(this.mode)?"v":/line/.test(this.mode)||/curve/.test(this.mode)?1<this.dlen?"n":"v":/chart/.test(this.mode)?1<this.dlen?"s":"v":/pie/.test(this.mode.test)?"r":"s"):this.fill},getGradient:function(a){var b=!1;switch(this.getFillMode()){case "s":b=harryTools.calcColor(a,0,this.opacity);break;case "l":b=harryTools.calcColor(a,21,this.opacity);break;case "d":b=
harryTools.calcColor(a,-21,this.opacity);break;case "v":b=this.gc.createLinearGradient(0,this.ry2,0,this.ry);b.addColorStop(0,harryTools.calcColor(a,-48,this.opacity));b.addColorStop(1,harryTools.calcColor(a,48,this.opacity));this.gc.fillStyle=b;break;case "h":b=this.gc.createLinearGradient(this.rx,0,this.rx2,0);b.addColorStop(0,harryTools.calcColor(a,-48,this.opacity));b.addColorStop(1,harryTools.calcColor(a,48,this.opacity));this.gc.fillStyle=b;break;case "r":b=this.gc.createRadialGradient(this.rx2,
this.ry2,0,this.rx,this.ry2,1),b.addColorStop(1,harryTools.calcColor(a,-48,this.opacity)),b.addColorStop(0,harryTools.calcColor(a,48,this.opacity)),this.gc.fillStyle=b}return b}};var plotter=function(a){return new harry(a)};