// harry plotter 0.8
// ~L~ nikomomo@gmail.com 2009-2012
// https://github.com/nikopol/Harry-Plotter
var harry=function(g){var S="#88a4d7 #d685c9 #86d685 #ffc34f #93c2ea #f28989 #f9eb8a".split(" "),D=function(b,a,h){var c,b=b&&b.constructor==Array&&3==b.length?b:(c=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(b))?[parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10)]:(c=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(b))?[2.55*parseFloat(c[1]),2.55*parseFloat(c[2]),2.55*parseFloat(c[3])]:(c=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(b))?[parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],16)]:(c=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(b))?[parseInt(c[1]+c[1],16),parseInt(c[2]+c[2],16),parseInt(c[3]+c[3],16)]:[0,0,0];"array"!=typeof a&&(a=[a,a,a]);for(c=0;3>c;++c)b[c]=Math.max(Math.min(b[c]+a[c],255),0);return void 0!=h?"rgba("+b.join(",")+","+h+")":"rgb("+b.join(",")+")"},O=function(b){var a=b.match(/\d+px/i);return a?parseInt(a,10):(a=b.match(/[0-9\.]+em/i))?Math.floor(16*parseFloat(a)):(a=b.match(/\d+pt/i))?Math.floor(1.3333*
parseInt(a,10)):10},ga=function(b){var a=Math.floor(b).toString(),h=parseInt(a.substr(0,1),10);return h*parseFloat("1E"+(a.length-1))==b?b:(h+1)*parseFloat("1E"+(a.length-1))},P=function(a,d){if("object"==typeof d)for(var h in d)a[h]=d[h];return a},ha=function(a){a=a||window.event;if("offsetX"in a)return{x:a.offsetX,y:a.offsetY};for(var d=a.target,a={x:a.pageX,y:a.pageY};d.offsetParent;)a.x-=d.offsetLeft,a.y-=d.offsetTop,d=d.offsetParent;return a},e;if(g.canvas)e=document.getElementById(g.canvas);
else{e=g.container;var M=g.width||300,Y=g.height||150,T=document.createElement("canvas"),U;T.setAttribute("width",M+"px");T.setAttribute("height",Y+"px");e&&(U="string"==typeof e?document.getElementById(e):e);U||(U=document.body);U.appendChild(T);e=T}var x=e,F=x.width,L=x.height,a=x.getContext("2d"),Z,ia=g.background,v=g.mode||"line",ja=(g.fill||"a")[0].toLowerCase().replace(/[^nasvhrdl]/,"a"),s=parseFloat(g.opacity)||1,V=parseInt(g.linewidth,10)||1,sa=g.linejoin||"miter",ka=parseInt(g.radiuspoint,
10)||0,la=!1===g.autoscale?!1:!0,m=P({color:"#a0a0a0",font:'normal 9px "Sans Serif"',marks:0,ypos:"right"},g.labels),k=!1===g.mouseover?!1:P({radius:5,linewidth:V,circle:"#888",font:'normal 10px "Sans Serif"',color:"#fff",bullet:"rgba(99,99,99,0.8)",axis:!1,text:"%v"},g.mouseover),A,o=[],N=!1,ma,$,aa;g.margins?e=g.margins:(M=v,e=O(m.font),/pie/.test(M)?(e=m.x?2*e:!1===k?0:15,e=[e,e,e,e]):(M=Math.floor(e/2),Y=m.marks,e=[m.y?M:0,m.y&&/right/i.test(m.ypos)?4*e:m.x?e:1,m.x?3+e+Y:m.y?e:1,m.y&&/left/i.test(m.ypos)?
4*e:m.x?M:0]));var t=P({color:"#a0a0a0",x:[0,100],y:[0,25,50,75,100]},g.grid),B=g.title?P({font:'bold 12px "Sans Serif"',color:"rgba(4,4,4,0.3)",x:e[3]+2.5,y:e[0]+2.5,z:"top"},g.title):!1,u=!1===g.legends?!1:P({x:e[3]+2.5,y:e[0]+2.5+(g.title&&!g.title.x?2+O(B.font):0),color:"#666",font:'10px "Sans Serif"'},g.legends),r=[],ba,G,y=0,E,z,Q,H,C,I,p,R,na=function(a){var d,h=a.values||a,c=a.labels||[],i={val:[],lab:[],len:0,sum:0,avg:0,max:0,min:0xffffffffffff,tit:a.title||"dataset#"+(r.length+1),col:a.color||
S[r.length%S.length]};for(d in h){a=parseFloat(h[d]);i.val.push(h[d]==null?null:a);i.lab.push(c[d]||d);i.sum=i.sum+a;if(a>i.max)i.max=a;if(a<i.min)i.min=a}i.len=i.val.length;i.avg=i.len?i.sum/i.len:0;r.push(i);y=r.length;if(y==1){ba=i.min;E=G=la?ga(i.max):i.max}else{ba=Math.min(i.min,ba);G=Math.max(i.max,G);d=E=0;for(h=r[0].val.length;d<h;++d){for(a=c=0;a<r.length;++a)c=c+(r[a].val[d]||0);c>E&&(E=la?ga(c):c)}}},oa=function(a){if(a instanceof Array&&typeof a[0]=="object")for(var d=0,h=a.length;d<h;++d)na(a[d]);
else na(a)},ca=function(b){var d,h;if(ja=="a"){s=1;h=/\:river/.test(v)?"v":/line/.test(v)||/curve/.test(v)?y>1?"n":"v":/chart/.test(v)?y>1?"s":"v":/pie/.test(v.test)?"r":"s"}else h=ja;switch(h){case "s":d=D(b,0,s);break;case "l":d=D(b,21,s);break;case "d":d=D(b,-21,s);break;case "v":d=a.createLinearGradient(0,p,0,Q);d.addColorStop(0,D(b,-48,s));d.addColorStop(1,D(b,48,s));break;case "h":d=a.createLinearGradient(z,0,I,0);d.addColorStop(0,D(b,-48,s));d.addColorStop(1,D(b,48,s));break;case "r":d=a.createRadialGradient(I,
p,0,z,p,1);d.addColorStop(1,D(b,-48,s));d.addColorStop(0,D(b,48,s))}return d?a.fillStyle=d:false},J=function(b){if(b&&a.hasOwnProperty("shadowBlur")){b=b.split(/[ ,;:-]/);a.shadowOffsetX=parseInt(b[0]||1,10);a.shadowOffsetY=parseInt(b[1]||1,10);a.shadowBlur=parseInt(b[2]||1,10);a.shadowColor=b[3]||"#000"}},K=function(){if(a.hasOwnProperty("clearShadow"))a.clearShadow();else if(a.hasOwnProperty("shadowBlur")){a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;a.shadowColor="rgba(0,0,0,0)"}},pa=function(){if(B){J(B.shadow);
a.font=B.font;a.textAlign="left";a.textBaseline="top";a.fillStyle=B.color;a.fillText(B.text,B.x,B.y);K()}},da=function(b,d,h,c,i){if(m.x&&b%m.x==0){b=r[0].lab[b]||b;J(m.shadow);a.font=m.font;a.fillStyle=m.color;a.textAlign=c||"center";a.textBaseline=i||"alphabetic";a.fillText(b,d,h);K()}if(m.marks){a.save();a.lineWidth=1;a.moveTo(d,p);a.lineTo(d,p+m.marks);a.strokeStyle=m.color;a.stroke();a.restore()}},ra=function(b,d){a.save();a.font=k.font;var h,c,i,j=b.length,f,w,n=0,l=0,W=O(k.font),e=W/2,m=W+
3,g,q,o=F;q=0;g=L;var qa=0;b.sort(function(a,b){return parseInt(b.v,10)-parseInt(a.v,10)});for(c=0;c<j;c++){f=b[c];i=r[f.nds].lab[f.n];w=r[f.nds].tit;if(i=typeof k.text=="function"?k.text(f.n,f.v,i,f.x,f.y):k.text.replace("%v",f.v).replace("%l",i).replace("%n",f.n).replace("%t",w)){f.lines=i.split(/\n|\\n/);f.h=f.lines.length*m;f.h2=Math.floor(f.h/2);f.w=0;for(h in f.lines)if((i=a.measureText(f.lines[h]).width+6)>f.w)f.w=i;if(f.w>l)l=f.w;n=n+f.h;f.r++;o>f.x-f.r&&(o=f.x-f.r);q<f.x+f.r&&(q=f.x+f.r);
if(g>f.y)g=f.y;if(qa<f.y)qa=f.y}}j>1&&(l=l+(6+W));if(n){n=n+3;if(d){q=o+(q-o)/2-l/2;q+l>F&&(q=F-1-l)}else q+l>=F&&(q=o-l);q<1&&(q=1);q=Math.floor(q)+0.5;h=q+l;c=g+n/2+n/2;c>p&&(c=p-1);c=Math.floor(c)+0.5;f=c-n;a.beginPath();a.moveTo(q,c);a.lineTo(h,c);a.lineTo(h,f);a.lineTo(q,f);a.closePath();if(k.bullet){J(k.shadowbox);a.strokStyle="";a.fillStyle=k.bullet;a.fill();K()}if(k.border){a.lineWidth=1;a.lineJoin="round";a.strokeStyle=k.border;a.stroke()}a.textAlign="left";a.textBaseline="top";g=f+3;for(c=
0;c<j;c++){f=b[c];n=q+3;if(j>1){a.beginPath();a.arc(n+e,g+e,e,0,2*Math.PI);a.fillStyle=r[f.nds].col;a.fill();n=n+(W+3)}J(k.shadow);a.fillStyle=k.color;for(h=0;h<f.lines.length;++h,g=g+m)a.fillText(f.lines[h],n,g);K()}}a.restore()},fa={line:function(b,d){var h=y,c=b?E?C/E:0:G?C/G:0,i,j,f,w,n,l=function(a,b,c,h,f,i){for(var j,e,g,n,w,l;f<=i;)if(h[f]===null)f++;else if(d){j=b[f];e=c[f];for(f++;f<=i&&h[f]===null;)f++;if(f>i)a.lineTo(j,e);else{g=(j+b[f])/2;n=(e+c[f])/2;w=(j+g)/2;l=(e+n)/2;a.quadraticCurveTo(j,
e,w,l);w=(g+b[f])/2;l=(n+c[f])/2;a.quadraticCurveTo(g,n,w,l)}}else{a.lineTo(b[f],c[f]);f++}};a.lineWidth=V;a.lineJoin=sa;for(o=[];i=r[--h];)if((n=i.val.length)>1){var e=[],g=[];for(j=0;j<n;++j){w=0;if(b)for(f=0;f<=h;f++)w=w+r[f].val[j];else w=i.val[j];e.push(z+Math.round(j*(H/(n-1))));g.push(p-Math.round(c*w))}o.push({x:e,y:g,v:r[h].val,nds:h});j--;e.push(z+Math.round(j*(H/(n-1))));g.push(p-Math.round(c*w));for(j=0;i.val[j]===null;)j++;for(f=n-1;i.val[f]===null;)f--;if(j<=f&&ca(i.col)){a.beginPath();
a.moveTo(e[j],p);a.lineTo(e[j],g[j]);l(a,e,g,i.val,j,f);a.lineTo(e[f],p);a.closePath();a.fill()}a.strokeStyle=i.col;a.beginPath();a.moveTo(e[j],g[j]);l(a,e,g,i.val,j,f);a.stroke();if(h==0)for(j=0;j<n;++j)da(j,e[j],L-1);if(ka){a.fillStyle=i.col;for(j=0;j<n;++j)if(i.val[j]!=void 0){a.beginPath();a.arc(e[j],g[j],ka,0,2*Math.PI);a.closePath();a.fill()}}}},curve:function(a){fa.line(a,true)},chart:function(b){var d=y;o=[];if(d){var h,c,i=r[0].len,j=d>1?4:0,f=b?1:d,e=i&&d?(H-j*(i-1))/i/f-1:0,g,l,m,k=z,ea,
t,q=b?E?C/E:0:G?C/G:0;e<0&&(e=0);a.lineWidth=V;a.lineJoin="miter";for(c=0;c<d;c++)o.push({x:[],y:[],v:[],nds:c});for(h=0;h<i;h++){da(h,k+(e+1)*f/2,L-1);l=p;for(c=0;c<d;c++){g=r[c];m=b?l:p;l=m-Math.round(q*g.val[h]);ea=Math.round(k);t=Math.round(k+e);if(g.val[h]!==null){a.beginPath();a.moveTo(ea,m);a.lineTo(ea,l);a.lineTo(t,l);a.lineTo(t,m);a.closePath();ca(g.col)&&a.fill();a.strokeStyle=g.col;a.stroke()}o[c].x.push(0.5+Math.floor(k+e/2));o[c].y.push(l);o[c].v.push(g.val[h]);b||(k=k+(e+1))}k=k+(b?
e+1+j:j)}}},pie:function(){var b=y;o=[];if(b){var d=0,h=[],c=[],i=Math.PI*2,j=[],f=[];if(b>1){for(var e=0,d=b,b=0;b<d;b++)e=e+r[b].sum;if(e)for(b=0;b<d;b++){h[b]=r[b].sum/e*i;c[b]=r[b].col;j.push(r[b].sum);f.push(Math.round(100*r[b].sum/e))}}else{e=r[0];if(e.sum){d=e.len;for(b=0;b<d;b++){h[b]=e.val[b]/e.sum*i;c[b]=S[b%S.length];j.push(e.val[b]);f.push(Math.round(100*e.val[b]/e.sum))}}}var i=z+Math.round(H/2),e=Q+Math.round(C/2),g=Math.min(C/2,H/2)-1,l=g+m.fontpx,k,p,t=Math.PI*1.5,u,q,v,x,s=N;ma=g;
$=i;aa=e;N=s;a.lineWidth=V;a.lineJoin="miter";for(b=0;b<d;b++){u=t+h[b];q=(t+u)/2;o.push({a:t%(2*Math.PI),n:b});if(b===s){k=i+Math.cos(q)*10;p=e+Math.sin(q)*10}else{k=i;p=e}a.beginPath();a.moveTo(k,p);a.arc(k,p,g,t,u,false);a.closePath();ca(c[b])&&a.fill();a.strokeStyle=c[b];a.stroke();if(b===s){v=k+l/2*Math.cos(q);x=p+l/2*Math.sin(q)}else da(j[b],k+l*Math.cos(q),p+l*Math.sin(q),"center","middle");t=u}s!==false&&ra([{x:v,y:x,r:0,v:j[s]+" ("+f[s]+"%)",n:s,nds:0}],true);o.sort(function(a,b){return a.a-
b.a})}}},X={line:function(b){var d,h=false,c,e,j=k.linewidth||1,f=[];if(o.length){c=o[0];for(d=0;d<c.x.length;++d)if(c.v[d]!=void 0&&(Math.abs(b-c.x[d])<e||h===false)){e=Math.abs(b-c.x[d]);h=d}if(h!==false){for(d=0;d<o.length;++d){c=o[d];if(c.v[h]!=void 0){if(k.border2){a.beginPath();a.lineWidth=j+2;a.arc(c.x[h],c.y[h],k.radius,0,2*Math.PI);if(k.linewidth==0){a.fillStyle=k.border2;a.fill()}else{a.strokeStyle=k.border2;a.stroke()}}a.beginPath();a.lineWidth=j;a.arc(c.x[h],c.y[h],k.radius,0,2*Math.PI);
if(k.linewidth==0){a.fillStyle=k.circle;a.fill()}else{a.strokeStyle=k.circle;a.stroke()}if(k.axis){a.lineWidth=1;if(/x/i.test(k.axis)){for(b=c.y[h]+k.radius;b<p;){a.moveTo(c.x[h],b);b=b+2;b>p&&(b=p);a.lineTo(c.x[h],b);b=b+2}a.stroke()}if(/y/i.test(k.axis)){for(b=c.x[h]+k.radius;b<I;){a.moveTo(b,c.y[h]);b=b+2;b>I&&(b=I);a.lineTo(b,c.y[h]);b=b+2}a.stroke()}}f.push({x:c.x[h],y:c.y[h],r:j/2+1+k.radius,v:c.v[h],n:h,nds:c.nds})}}ra(f)}}},chart:function(a,d){X.line(a,d)},curve:function(a,d,e){X.line(a,d,
e,true)},pie:function(a,d){var e,c=0;if(Math.sqrt(Math.pow(a-$,2)+Math.pow(d-aa,2))<=ma){e=Math.PI-Math.atan2(aa-d,a-$);for(e=(e+3*Math.PI)%(2*Math.PI);c<o.length&&e>o[c].a;)c++;--c<0&&(c=o.length-1);N=o[c].n;R(true)}else if(N!==false){N=false;R(true)}}};R=function(b){var d=v.split(/:/),e=d[0],c=d[1]||false;a.clearRect(0,0,F,L);if(ia){a.fillStyle=ia;a.fillRect(0,0,F,L)}if(/chart|line|curve/.test(v)){var i,j;a.lineWidth=t.linewidth||1;a.strokeStyle=t.color;if(t.x){d=0;for(i=t.x.length;d<i;++d){j=z+
Math.round(H*t.x[d]/100);a.beginPath();a.moveTo(j,Q);a.lineTo(j,p);a.stroke()}}if(t.y){d=0;for(i=t.y.length;d<i;++d){j=p-Math.round(C*t.y[d]/100);a.beginPath();a.moveTo(z,j);a.lineTo(I,j);a.stroke()}}}if(y&&m.y&&/chart|line|curve/.test(v)){var d=/\:[r|s]/.test(v)?E:G,f,g,n,l=d<10?100:d<100?10:1;J(m.shadow);a.font=m.font;a.fillStyle=m.color;a.textBaseline="middle";i=0;for(j=m.y.length;i<j;++i){g=p-Math.round(C*m.y[i]/100);n=Math.round(l*d*m.y[i]/100)/l;if(/right/i.test(m.ypos)){f=I+1;a.textAlign="left";
a.fillText(n,f,g)}if(/left/i.test(m.ypos)){f=z-2;a.textAlign="right";a.fillText(n,f,g)}}K()}if(B&&B.z=="top"){fa[e](c);pa()}else{pa();fa[e](c)}if(u!==false&&y>1){a.save();a.font=u.font;var o;n=0;i=O(u.font)+3;j=i-3;f=y;o=3+i*f;g=u.x;for(var s=u.y,d=0;d<f;++d)if((l=a.measureText(r[d].tit)).width>n)n=l.width;l=9+j+n;a.lineWidth=1;if(n=u.background){J(u.shadowbox);a.fillStyle=n;a.fillRect(g,s,l,o);K()}if(n=u.border){a.strokeStyle=n;a.strokeRect(g,s,l,o)}d=0;for(l=s+3;d<f;++d,l=l+i){o=r[d];J(u.shadow);
a.fillStyle=o.col;a.fillRect(g+3,l,j,j);K();if(n=u.border2){a.strokeStyle=n;a.strokeRect(g+3,l,j,j)}J(u.shadow);a.textAlign="left";a.textBaseline="top";a.fillStyle=u.color;a.fillText(o.tit,g+6+j,l);K()}a.restore()}if(!b){x.onmouseover=x.onmousemove=x.onmouseout=void 0;N=false;if(k){Z=a.getImageData(0,0,F,L);if(A)X[e](A.x,A.y,c);x.onmouseover=function(a){A=ha(a)};x.onmousemove=function(b){if(A){e!="pie"&&a.putImageData(Z,0,0);A=ha(b);X[e](A.x,A.y,c)}};x.onmouseout=function(){A=void 0;a.putImageData(Z,
0,0)}}else A=void 0}};m.fontpx=O(m.font);/none|false/.test(t.x)&&(t.x=[]);/none|false/.test(t.y)&&(t.y=[]);z=e[3]+0.5;Q=e[0]+0.5;H=Math.max(F-e[1]-e[3],0);C=Math.max(L-e[0]-e[2],0);I=z+H;p=Q+C;g.datas&&oa(g.datas);R();return{canvas:x,data:r,clear:function(){r=[];y=0;return this},load:function(a){oa(a);return this},cls:function(){return this},draw:function(a){a&&(v=a.toLowerCase());R();return this}}},plotter=harry;
