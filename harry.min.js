// harry plotter 0.6
// ~L~ nikomomo@gmail.com 2009-2012
// https://github.com/nikopol/Harry-Plotter
var harryTools={COLORS:"#88a4d7 #d685c9 #86d685 #ffc34f #93c2ea #f28989 #f9eb8a".split(" "),count:0,getRGB:function(a){var b;return a&&a.constructor==Array&&3==a.length?a:(b=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(a))?[parseInt(b[1],10),parseInt(b[2],10),parseInt(b[3],10)]:(b=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(a))?[2.55*parseFloat(b[1]),2.55*parseFloat(b[2]),2.55*parseFloat(b[3])]:(b=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(a))?
[parseInt(b[1],16),parseInt(b[2],16),parseInt(b[3],16)]:(b=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(a))?[parseInt(b[1]+b[1],16),parseInt(b[2]+b[2],16),parseInt(b[3]+b[3],16)]:[0,0,0]},calcColor:function(a,b,d){a=harryTools.getRGB(a);"array"!=typeof b&&(b=[b,b,b]);for(var f=0;3>f;++f)a[f]=Math.max(Math.min(a[f]+b[f],255),0);return void 0!=d?"rgba("+a.join(",")+","+d+")":"rgb("+a.join(",")+")"},fontPixSize:function(a){var b=a.match(/\d+px/i);return b?parseInt(b,10):(b=a.match(/[0-9\.]+em/i))?
Math.floor(16*parseFloat(b,10)):(b=a.match(/\d+pt/i))?Math.floor(1.3333*parseInt(b,10)):10},scaleUp:function(a){var b=Math.floor(a).toString(),d=parseInt(b.substr(0,1));return d*parseFloat("1E"+(b.length-1))==a?a:(d+1)*parseFloat("1E"+(b.length-1))}},harry=function(a){this.clear();a.canvas?this.canvas=document.getElementById(a.canvas):(this.canvas=document.createElement("canvas"),a.id&&this.canvas.setAttribute("id",a.id),document.getElementById(a.container).appendChild(this.canvas),this.canvas.setAttribute("width",
(a.width||300)+"px"),this.canvas.setAttribute("height",(a.height||150)+"px"));this.w=this.canvas.width;this.h=this.canvas.height;this.id=a.id||"harry"+ ++harryTools.count;this.setMode(a.mode);this.fill=(a.fill||"auto")[0].toLowerCase().replace(/[^nasvhr]/,"a");this.opacity=parseFloat(a.opacity,10)||1;this.linewidth=parseInt(a.linewidth,10)||1;this.linejoin=a.linejoin||"miter";this.radiuspoint=parseInt(a.radiuspoint,10)||0;this.labels=a.labels||{};this.labels.color=this.labels.color||"#a0a0a0";this.labels.font=
this.labels.font||'normal 9px "Sans Serif"';this.labels.fontpx=harryTools.fontPixSize(this.labels.font);this.labels.stepx=this.labels.stepx||1;this.margins=a.margins||[0,0,0,0];this.autoscale=!1===a.autoscale?!1:!0;!1===a.mouseover?this.mouseover=!1:(a.mouseover=a.mouseover||{},this.mouseover={radius:a.mouseover.radius||5,linewidth:void 0!=a.mouseover.linewidth?a.mouseover.linewidth:this.linewidth,circle:a.mouseover.circle||"#888",font:a.mouseover.font||'normal 10px "Sans Serif"',color:a.mouseover.color||
"#fff",bullet:a.mouseover.bullet||"#888",border:a.mouseover.border||"#fff",axis:a.mouseover.axis||!1,text:a.mouseover.text||"%v"});if(!a.margins)if(/pie/.test(this.mode)){var b=this.labels.x?this.labels.fontpx:0;this.margins=[b,b,b,b]}else{var b=this.labels.fontpx,d=Math.floor(this.labels.fontpx/2);this.margins=[this.labels.y?d:0,this.labels.y?4*b:1,this.labels.x?2+b:1,this.labels.x?d:0]}this.grid=a.grid||{};this.grid.color=this.grid.color||"#a0a0a0";this.grid.x=this.grid.x||[0,100];/none|false/.test(this.grid.x)&&
(this.grid.x=[]);this.grid.y=this.grid.y||[0,25,50,75,100];/none|false/.test(this.grid.y)&&(this.grid.y=[]);if(this.title=a.title||!1)if("string"==typeof this.title&&(this.title={text:this.title}),this.title.font||(this.title.font='bold 12px "Sans Serif","Trebuchet MS"'),this.title.color||(this.title.color="rgba(4,4,4,0.3)"),this.title.x||(this.title.x=this.margins[3]+2),this.title.y||(this.title.y=this.margins[0]+2),!this.title.z)this.title.z="top";this.gc=this.canvas.getContext("2d");a.datas&&this.addDataSets(a.datas);
this.rx=this.margins[3]+0.5;this.ry=this.margins[0]+0.5;this.rw=Math.max(this.w-this.margins[1]-this.margins[3],0);this.rh=Math.max(this.h-this.margins[0]-this.margins[2],0);this.rx2=this.rx+this.rw;this.ry2=this.ry+this.rh;this.draw()};
harry.prototype={clear:function(){this.dataset=[];this.dmin=4294967295;this.dmax=0;return this},setMode:function(a){this.mode=a||"line";return this},addDataSets:function(a){if(a.constructor==Array&&"object"==typeof a[0])for(var b=0,d=a.length;b<d;++b)this.addDataSet(a[b]);else this.addDataSet(a);return this},addDataSet:function(a){var b,d=a.values||a,f=a.labels||[],e={val:[],lab:[],len:0,sum:0,avg:0,max:0,min:0xffffffffffff,tit:a.title||"dataset#"+(this.dataset.length+1),col:a.color||harryTools.COLORS[this.dataset.length%
harryTools.COLORS.length]};for(b in d)if(a=parseFloat(d[b],10),e.val.push(null==d[b]?null:a),e.lab.push(f[b]||b),e.sum+=a,a>e.max&&(e.max=a),a<e.min)e.min=a;e.len=e.val.length;e.avg=e.len?e.sum/e.len:0;this.dataset.push(e);this.dlen=this.dataset.length;if(1==this.dlen)this.dmin=e.min,this.dsum=this.dmax=this.autoscale?harryTools.scaleUp(e.max):e.max;else{this.dmin=Math.min(e.min,this.dmin);this.dmax=Math.max(e.max,this.dmax);b=this.dsum=0;for(d=this.dataset[0].val.length;b<d;++b){for(a=f=0;a<this.dataset.length;++a)f+=
this.dataset[a].val[b]||0;f>this.dsum&&(this.dsum=this.autoscale?harryTools.scaleUp(f):f)}}return this},draw:function(a){this.mode=(a||this.mode).toLowerCase();var b=this.mode.split(/:/);this.drawGrid().drawYLabels();if(this.title&&"top"==this.title.z)this[b[0]](1==b.length?!1:b[1]).drawTitle();else this.drawTitle()[b[0]](1==b.length?!1:b[1]);if(this.mouseover&&this[b[0]+"Over"]){var d=this;this.imgdata=this.gc.getImageData(0,0,this.w,this.h);if(void 0!=this.mousepos)d[b[0]+"Over"](d.mousepos.x,d.mousepos.y,
b[1]);this.canvas.onmouseover=function(){d.canvas.onmousemove=function(a){a=a||window.event;d.gc.putImageData(d.imgdata,0,0);d.mousepos={x:void 0!=a.offsetX&&a.offsetX||void 0!=a.layerX&&a.layerX||void 0!=a.clientX&&a.clientX,y:void 0!=a.offsetY&&a.offsetY||void 0!=a.layerY&&a.layerY||void 0!=a.clientY&&a.clientY};d[b[0]+"Over"](d.mousepos.x,d.mousepos.y,b[1])}};this.canvas.onmouseout=function(){d.mousepos=void 0;d.canvas.onmousemove=null;d.gc.putImageData(d.imgdata,0,0)}}return this},cls:function(){this.gc.clearRect(0,
0,this.w,this.h);return this},drawTitle:function(){this.title&&this.gc.font&&(this.gc.font=this.title.font,this.gc.textAlign="left",this.gc.textBaseline="top",this.gc.fillStyle=this.title.color,this.gc.fillText(this.title.text,this.title.x,this.title.y));return this},drawGrid:function(){if(/chart|line|curve/.test(this.mode)){var a,b,d;this.gc.lineWidth=this.grid.linewidth||1;this.gc.strokeStyle=this.grid.color;if(this.grid.x){a=0;for(b=this.grid.x.length;a<b;++a)d=this.rx+Math.round(this.rw*this.grid.x[a]/
100),this.gc.beginPath(),this.gc.moveTo(d,this.ry),this.gc.lineTo(d,this.ry2),this.gc.stroke()}if(this.grid.y){a=0;for(b=this.grid.y.length;a<b;++a)d=this.ry2-Math.round(this.rh*this.grid.y[a]/100),this.gc.beginPath(),this.gc.moveTo(this.rx,d),this.gc.lineTo(this.rx2,d),this.gc.stroke()}}return this},drawYLabels:function(){if(this.dlen&&this.labels.y&&this.gc.font)if(/chart|line|curve/.test(this.mode)){var a=/\:[r|s]/.test(this.mode)?this.dsum:this.dmax,b,d,f,e,j,c=10>a?100:100>a?10:1,g=Math.floor(this.labels.fontpx/
2.5);this.gc.font=this.labels.font;this.gc.fillStyle=this.labels.color;this.gc.textAlign="left";b=0;for(d=this.labels.y.length;b<d;++b)f=this.rx2+1,e=this.ry2-Math.round(this.rh*this.labels.y[b]/100),j=Math.round(c*a*this.labels.y[b]/100)/c,this.gc.fillText(j,f,e+g)}else/pie/.test(this.mode);return this},drawXLabel:function(a,b,d,f,e){this.gc.font&&(this.labels.x&&0==a%this.labels.x)&&(a=this.dataset[0].lab[a]||a,this.gc.font=this.labels.font,this.gc.fillStyle=this.labels.color,this.gc.textAlign=
f||"center",this.gc.textBaseline=e||"alphabetic",this.gc.fillText(a,b,d));return this},drawBullet:function(a,b,d,f,e,j){this.gc.font=this.mouseover.font;var c,g,i=0,h=this.dataset[j].lab[e];c="function"==typeof this.mouseover.text?this.mouseover.text(e,f,h,a,b):this.mouseover.text.replace("%v",f).replace("%l",h).replace("%n",e);var e=c.split(/\n|\\n/),f=harryTools.fontPixSize(this.mouseover.font)+3,h=3+e.length*f,l=Math.floor(h/2);if(c){for(g in e)c=this.gc.measureText(e[g]).width+6,c>i&&(i=c);c=
a+d;g=c+i;if(g>=this.rw||j%2&&0<a-d-i)g=a-d,c=g-i;b+=l;a=b-h;b>=this.rh?(b=this.rh-0.5,a=b-h):0>a&&(a=1.5,b=a+h);this.gc.beginPath();this.gc.moveTo(c,b);this.gc.lineTo(g,b);this.gc.lineTo(g,a);this.gc.lineTo(c,a);this.gc.closePath();this.gc.fillStyle=this.mouseover.bullet;this.gc.fill();this.gc.lineWidth=1;this.gc.lineJoin="round";this.gc.strokeStyle=this.mouseover.border;this.gc.stroke();this.gc.textAlign="left";this.gc.textBaseline="top";this.gc.fillStyle=this.mouseover.color;g=0;for(a+=3;g<e.length;++g,
a+=f)this.gc.fillText(e[g],c+3-1,a)}return this},pie:function(){var a=this.dlen;if(a){var b=0,d=[],f=[],e=2*Math.PI,j=[],c=/percent/.test(this.labels.x);if(1<a){for(var g=0,b=a,a=0;a<b;a++)g+=this.dataset[a].avg;if(g)for(a=0;a<b;a++)d[a]=this.dataset[a].avg/g*e,f[a]=this.dataset[a].col,j.push(c?Math.round(100*this.dataset[a].avg/g)+"%":this.dataset[a].avg.toString())}else if(g=this.dataset[0],g.sum){b=g.len;for(a=0;a<b;a++)d[a]=g.val[a]/g.sum*e,f[a]=harryTools.COLORS[a%harryTools.COLORS.length],j.push(c?
Math.round(100*g.val[a]/g.sum)+"%":g.val[a].toString())}var e=this.rx+Math.round(this.rw/2),c=this.ry+Math.round(this.rh/2),g=Math.min(this.rh/2,this.rw/2)-1,i=g+0.7*this.labels.fontpx,h,l=-Math.PI/2,m;this.gc.lineWidth=this.linewidth;this.gc.lineJoin="miter";for(a=0;a<b;a++)m=l+d[a],h=this.getGradient(f[a]),this.gc.beginPath(),this.gc.moveTo(e,c),this.gc.arc(e,c,g,l,m,!1),this.gc.closePath(),h&&(this.gc.fillStyle=h,this.gc.fill()),this.gc.strokeStyle=f[a],this.gc.stroke(),h=(l+m)/2,this.drawXLabel(j[a],
e+i*Math.cos(h),c+i*Math.sin(h),"center","middle"),l=m}return this},chart:function(a){var b=this.dlen;this.overpoints=[];if(b){var d,f,e=this.dataset[0].len,j=1<b?4:0,c=a?1:b,g=e&&b?(this.rw-j*(e-1))/e/c-1:0;0>g&&(g=0);var i,h,l,m=this.rx,o,k=a?this.dsum?this.rh/this.dsum:0:this.dmax?this.rh/this.dmax:0;this.gc.lineWidth=this.linewidth;this.gc.lineJoin="miter";for(f=0;f<b;f++)this.overpoints.push({x:[],y:[],v:[],nds:f});for(d=0;d<e;d++){this.drawXLabel(d,m+(g+1)*c/2,this.h-1);l=this.ry2;for(f=0;f<
b;f++){i=this.dataset[f];y0=a?l:this.ry2;l=y0-Math.round(k*i.val[d]);h=Math.round(m);o=Math.round(m+g);this.gc.beginPath();this.gc.moveTo(h,y0);this.gc.lineTo(h,l);this.gc.lineTo(o,l);this.gc.lineTo(o,y0);this.gc.closePath();if(h=this.getGradient(i.col))this.gc.fillStyle=h,this.gc.fill();this.gc.strokeStyle=i.col;this.gc.stroke();this.overpoints[f].x.push(0.5+Math.floor(m+g/2));this.overpoints[f].y.push(l);this.overpoints[f].v.push(i.val[d]);a||(m+=g+1)}m+=a?g+1+j:j}}return this},chartOver:function(a,
b){return this.lineOver(a,b)},curve:function(a){return this.line(a,!0)},curveOver:function(a,b,d){return this.lineOver(a,b,d,!0)},line:function(a,b){var d=this.dlen,f=a?this.dsum?this.rh/this.dsum:0:this.dmax?this.rh/this.dmax:0,e,j,c,g,i,h,l;this.gc.lineWidth=this.linewidth;this.gc.lineJoin=this.linejoin;for(this.overpoints=[];e=this.dataset[--d];)if(1<(i=e.val.length)){var m,o,k=[],n=[];for(c=0;c<i;++c){g=0;if(a)for(j=0;j<=d;j++)g+=this.dataset[j].val[c];else g=e.val[c];k.push(this.rx+Math.round(c*
(this.rw/(i-1))));n.push(this.ry2-Math.round(f*g))}this.overpoints.push({x:k,y:n,v:this.dataset[d].val,nds:d});c--;k.push(this.rx+Math.round(c*(this.rw/(i-1))));n.push(this.ry2-Math.round(f*g));if(j=this.getGradient(e.col)){this.gc.beginPath();this.gc.moveTo(this.rx,this.ry2);this.gc.lineTo(k[0],n[0]);if(b)for(c=1;c<=i;++c)h=(k[c-1]+k[c])/2,l=(n[c-1]+n[c])/2,m=(k[c-1]+h)/2,o=(n[c-1]+l)/2,this.gc.quadraticCurveTo(k[c-1],n[c-1],m,o),m=(h+k[c])/2,o=(l+n[c])/2,this.gc.quadraticCurveTo(h,l,m,o);else for(c=
0;c<i;++c)this.gc.lineTo(k[c],n[c]);this.gc.lineTo(this.rx2,this.ry2);this.gc.closePath();this.gc.fillStyle=j;this.gc.fill()}this.gc.strokeStyle=e.col;this.gc.beginPath();this.gc.moveTo(k[0],n[0]);0==d&&this.drawXLabel(0,k[0],this.h);if(b)for(c=1;c<=i;++c)h=(k[c-1]+k[c])/2,l=(n[c-1]+n[c])/2,m=(k[c-1]+h)/2,o=(n[c-1]+l)/2,this.gc.quadraticCurveTo(k[c-1],n[c-1],m,o),m=(h+k[c])/2,o=(l+n[c])/2,this.gc.quadraticCurveTo(h,l,m,o),0==d&&c<i&&this.drawXLabel(c,k[c],this.h);else for(c=1;c<=i;++c)this.gc.lineTo(k[c-
1],n[c-1]),0==d&&c<i&&this.drawXLabel(c,k[c],this.h);this.gc.stroke();if(this.radiuspoint){this.gc.fillStyle=e.col;for(c=0;c<i;++c)void 0!=e.val[c]&&(this.gc.beginPath(),this.gc.arc(k[c],n[c],this.radiuspoint,0,2*Math.PI),this.gc.closePath(),this.gc.fill())}}return this},lineOver:function(a,b){var d,f=!1,e,j,c=this.mouseover.linewidth||1;if(this.overpoints.length){e=this.overpoints[0];for(d=0;d<e.x.length;++d)if(void 0!=e.v[d]&&(Math.abs(a-e.x[d])<j||!1===f))j=Math.abs(a-e.x[d]),f=d;if(!1!==f)for(d=
0;d<this.overpoints.length;++d)if(e=this.overpoints[d],void 0!=e.v[f]){this.gc.beginPath();this.gc.lineWidth=c;this.gc.arc(e.x[f],e.y[f],this.mouseover.radius,0,2*Math.PI);0==this.mouseover.linewidth?(this.gc.fillStyle=this.mouseover.circle,this.gc.fill()):(this.gc.strokeStyle=this.mouseover.circle,this.gc.stroke());if(this.mouseover.axis){this.gc.lineWidth=1;if(/x/i.test(this.mouseover.axis)){for(b=e.y[f]+this.mouseover.radius;b<this.ry2;)this.gc.moveTo(e.x[f],b),b+=2,b>this.ry2&&(b=this.ry2),this.gc.lineTo(e.x[f],
b),b+=2;this.gc.stroke()}if(/y/i.test(this.mouseover.axis)){for(a=e.x[f]+this.mouseover.radius;a<this.rx2;)this.gc.moveTo(a,e.y[f]),a+=2,a>this.rx2&&(a=this.rx2),this.gc.lineTo(a,e.y[f]),a+=2;this.gc.stroke()}}this.drawBullet(e.x[f],e.y[f],3+this.mouseover.radius,e.v[f],f,e.nds)}}},getFillMode:function(){return"a"==this.fill?(this.opacity=1,/\:river/.test(this.mode)?"v":/line/.test(this.mode)||/curve/.test(this.mode)?1<this.dlen?"n":"v":/chart/.test(this.mode)?1<this.dlen?"s":"v":/pie/.test(this.mode.test)?
"r":"s"):this.fill},getGradient:function(a){var b=!1;switch(this.getFillMode()){case "s":b=harryTools.calcColor(a,21,this.opacity);break;case "v":b=this.gc.createLinearGradient(0,this.ry2,0,this.ry);b.addColorStop(0,harryTools.calcColor(a,-48,this.opacity));b.addColorStop(1,harryTools.calcColor(a,48,this.opacity));this.gc.fillStyle=b;break;case "h":b=this.gc.createLinearGradient(this.rx,0,this.rx2,0);b.addColorStop(0,harryTools.calcColor(a,-48,this.opacity));b.addColorStop(1,harryTools.calcColor(a,
48,this.opacity));this.gc.fillStyle=b;break;case "r":b=this.gc.createRadialGradient(this.rx2,this.ry2,0,this.rx,this.ry2,1),b.addColorStop(1,harryTools.calcColor(a,-48,this.opacity)),b.addColorStop(0,harryTools.calcColor(a,48,this.opacity)),this.gc.fillStyle=b}return b}};var plotter=function(a){return new harry(a)};