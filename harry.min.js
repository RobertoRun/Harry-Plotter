// harry plotter 0.6
// ~L~ nikomomo@gmail.com 2009-2012
// https://github.com/nikopol/Harry-Plotter
var harryTools={COLORS:"#88a4d7 #d685c9 #86d685 #ffc34f #93c2ea #f28989 #f9eb8a".split(" "),count:0,getRGB:function(a){var b;return a&&a.constructor==Array&&3==a.length?a:(b=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(a))?[parseInt(b[1],10),parseInt(b[2],10),parseInt(b[3],10)]:(b=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(a))?[2.55*parseFloat(b[1]),2.55*parseFloat(b[2]),2.55*parseFloat(b[3])]:(b=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(a))?
[parseInt(b[1],16),parseInt(b[2],16),parseInt(b[3],16)]:(b=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(a))?[parseInt(b[1]+b[1],16),parseInt(b[2]+b[2],16),parseInt(b[3]+b[3],16)]:[0,0,0]},calcColor:function(a,b,c){a=harryTools.getRGB(a);"array"!=typeof b&&(b=[b,b,b]);for(var f=0;3>f;++f)a[f]=Math.max(Math.min(a[f]+b[f],255),0);return void 0!=c?"rgba("+a.join(",")+","+c+")":"rgb("+a.join(",")+")"},fontPixSize:function(a){var b=a.match(/\d+px/i);return b?parseInt(b,10):(b=a.match(/[0-9\.]+em/i))?
Math.floor(16*parseFloat(b,10)):(b=a.match(/\d+pt/i))?Math.floor(1.3333*parseInt(b,10)):10},scaleUp:function(a){var b=Math.floor(a).toString(),c=parseInt(b.substr(0,1));return c*parseFloat("1E"+(b.length-1))==a?a:(c+1)*parseFloat("1E"+(b.length-1))}},harry=function(a){this.clear();a.canvas?this.canvas=document.getElementById(a.canvas):(this.canvas=document.createElement("canvas"),a.id&&this.canvas.setAttribute("id",a.id),document.getElementById(a.container).appendChild(this.canvas),this.canvas.setAttribute("width",
(a.width||300)+"px"),this.canvas.setAttribute("height",(a.height||150)+"px"));this.w=this.canvas.width;this.h=this.canvas.height;this.id=a.id||"harry"+ ++harryTools.count;this.setMode(a.mode);this.fill=(a.fill||"auto")[0].toLowerCase().replace(/[^nasvhr]/,"a");this.opacity=parseFloat(a.opacity,10)||1;this.linewidth=parseInt(a.linewidth,10)||1;this.linejoin=a.linejoin||"miter";this.radiuspoint=parseInt(a.radiuspoint,10)||0;this.labels=a.labels||{};this.labels.color=this.labels.color||"#a0a0a0";this.labels.font=
this.labels.font||'normal 9px "Sans Serif"';this.labels.fontpx=harryTools.fontPixSize(this.labels.font);this.labels.stepx=this.labels.stepx||1;this.margins=a.margins||[0,0,0,0];this.autoscale=!1===a.autoscale?!1:!0;!1===a.mouseover?this.mouseover=!1:(a.mouseover=a.mouseover||{},this.mouseover={radius:a.mouseover.radius||5,linewidth:void 0!=a.mouseover.linewidth?a.mouseover.linewidth:this.linewidth,circle:a.mouseover.circle||"#888",font:a.mouseover.font||'normal 10px "Sans Serif"',color:a.mouseover.color||
"#fff",bullet:a.mouseover.bullet||"#888",border:a.mouseover.border||"#fff",axis:a.mouseover.axis||!1,text:a.mouseover.text||"%v"});if(!a.margins)if(/pie/.test(this.mode)){var b=this.labels.x?this.labels.fontpx:0;this.margins=[b,b,b,b]}else{var b=this.labels.fontpx,c=Math.floor(this.labels.fontpx/2);this.margins=[this.labels.y?c:0,this.labels.y?4*b:1,this.labels.x?2+b:1,this.labels.x?c:0]}this.grid=a.grid||{};this.grid.color=this.grid.color||"#a0a0a0";this.grid.x=this.grid.x||[0,100];/none|false/.test(this.grid.x)&&
(this.grid.x=[]);this.grid.y=this.grid.y||[0,25,50,75,100];/none|false/.test(this.grid.y)&&(this.grid.y=[]);if(this.title=a.title||!1)if("string"==typeof this.title&&(this.title={text:this.title}),this.title.font||(this.title.font='bold 12px "Sans Serif","Trebuchet MS"'),this.title.color||(this.title.color="rgba(4,4,4,0.3)"),this.title.x||(this.title.x=this.margins[3]+2),this.title.y||(this.title.y=this.margins[0]+2),!this.title.z)this.title.z="top";this.gc=this.canvas.getContext("2d");a.datas&&this.addDataSets(a.datas);
this.rx=this.margins[3]+0.5;this.ry=this.margins[0]+0.5;this.rw=Math.max(this.w-this.margins[1]-this.margins[3],0);this.rh=Math.max(this.h-this.margins[0]-this.margins[2],0);this.rx2=this.rx+this.rw;this.ry2=this.ry+this.rh;this.draw()};
harry.prototype={clear:function(){this.dataset=[];this.dmin=4294967295;this.dmax=0;return this},setMode:function(a){this.mode=a||"line";return this},addDataSets:function(a){if(a.constructor==Array&&"object"==typeof a[0])for(var b=0,c=a.length;b<c;++b)this.addDataSet(a[b]);else this.addDataSet(a);return this},addDataSet:function(a){var b,c=a.values||a,f=a.labels||[],d={val:[],lab:[],len:0,sum:0,avg:0,max:0,min:0xffffffffffff,tit:a.title||"dataset#"+(this.dataset.length+1),col:a.color||harryTools.COLORS[this.dataset.length%
harryTools.COLORS.length]};for(b in c)if(a=parseFloat(c[b],10),d.val.push(null==c[b]?null:a),d.lab.push(f[b]||b),d.sum+=a,a>d.max&&(d.max=a),a<d.min)d.min=a;d.len=d.val.length;d.avg=d.len?d.sum/d.len:0;this.dataset.push(d);this.dlen=this.dataset.length;if(1==this.dlen)this.dmin=d.min,this.dsum=this.dmax=this.autoscale?harryTools.scaleUp(d.max):d.max;else{this.dmin=Math.min(d.min,this.dmin);this.dmax=Math.max(d.max,this.dmax);b=this.dsum=0;for(c=this.dataset[0].val.length;b<c;++b){for(a=f=0;a<this.dataset.length;++a)f+=
this.dataset[a].val[b]||0;f>this.dsum&&(this.dsum=this.autoscale?harryTools.scaleUp(f):f)}}return this},draw:function(a){this.mode=(a||this.mode).toLowerCase();var b=this.mode.split(/:/);this.drawGrid().drawYLabels();if(this.title&&"top"==this.title.z)this[b[0]](1==b.length?!1:b[1]).drawTitle();else this.drawTitle()[b[0]](1==b.length?!1:b[1]);if(this.mouseover&&this[b[0]+"Over"]){var c=this;this.imgdata=this.gc.getImageData(0,0,this.w,this.h);if(void 0!=this.mousepos)c[b[0]+"Over"](c.mousepos.x,c.mousepos.y,
b[1]);this.canvas.onmouseover=function(){c.canvas.onmousemove=function(a){a=a||window.event;c.gc.putImageData(c.imgdata,0,0);c.mousepos={x:void 0!=a.offsetX&&a.offsetX||void 0!=a.layerX&&a.layerX||void 0!=a.clientX&&a.clientX,y:void 0!=a.offsetY&&a.offsetY||void 0!=a.layerY&&a.layerY||void 0!=a.clientY&&a.clientY};c[b[0]+"Over"](c.mousepos.x,c.mousepos.y,b[1])}};this.canvas.onmouseout=function(){c.mousepos=void 0;c.canvas.onmousemove=null;c.gc.putImageData(c.imgdata,0,0)}}return this},cls:function(){this.gc.clearRect(0,
0,this.w,this.h);return this},drawTitle:function(){this.title&&this.gc.font&&(this.gc.font=this.title.font,this.gc.textAlign="left",this.gc.textBaseline="top",this.gc.fillStyle=this.title.color,this.gc.fillText(this.title.text,this.title.x,this.title.y));return this},drawGrid:function(){if(/chart|line|curve/.test(this.mode)){var a,b,c;this.gc.lineWidth=this.grid.linewidth||1;this.gc.strokeStyle=this.grid.color;if(this.grid.x){a=0;for(b=this.grid.x.length;a<b;++a)c=this.rx+Math.round(this.rw*this.grid.x[a]/
100),this.gc.beginPath(),this.gc.moveTo(c,this.ry),this.gc.lineTo(c,this.ry2),this.gc.stroke()}if(this.grid.y){a=0;for(b=this.grid.y.length;a<b;++a)c=this.ry2-Math.round(this.rh*this.grid.y[a]/100),this.gc.beginPath(),this.gc.moveTo(this.rx,c),this.gc.lineTo(this.rx2,c),this.gc.stroke()}}return this},drawYLabels:function(){if(this.dlen&&this.labels.y&&this.gc.font)if(/chart|line|curve/.test(this.mode)){var a=/\:[r|s]/.test(this.mode)?this.dsum:this.dmax,b,c,f,d,e,h=10>a?100:100>a?10:1,g=Math.floor(this.labels.fontpx/
2.5);this.gc.font=this.labels.font;this.gc.fillStyle=this.labels.color;this.gc.textAlign="left";b=0;for(c=this.labels.y.length;b<c;++b)f=this.rx2+1,d=this.ry2-Math.round(this.rh*this.labels.y[b]/100),e=Math.round(h*a*this.labels.y[b]/100)/h,this.gc.fillText(e,f,d+g)}else/pie/.test(this.mode);return this},drawXLabel:function(a,b,c,f,d){this.gc.font&&(this.labels.x&&0==a%this.labels.x)&&(a=this.dataset[0].lab[a]||a,this.gc.font=this.labels.font,this.gc.fillStyle=this.labels.color,this.gc.textAlign=
f||"center",this.gc.textBaseline=d||"alphabetic",this.gc.fillText(a,b,c));return this},drawBullet:function(a,b,c,f,d,e){this.gc.font=this.mouseover.font;var h,g,k=0,i=this.dataset[e].lab[d];h="function"==typeof this.mouseover.text?this.mouseover.text(d,f,i,a,b):this.mouseover.text.replace("%v",f).replace("%l",i).replace("%n",d);var d=h.split(/\n|\\n/),f=harryTools.fontPixSize(this.mouseover.font)+3,i=3+d.length*f,l=Math.floor(i/2);if(h){for(g in d)h=this.gc.measureText(d[g]).width+6,h>k&&(k=h);h=
a+c;g=h+k;if(g>=this.rw||e%2&&0<a-c-k)g=a-c,h=g-k;b+=l;a=b-i;b>=this.rh?(b=this.rh-0.5,a=b-i):0>a&&(a=1.5,b=a+i);this.gc.beginPath();this.gc.moveTo(h,b);this.gc.lineTo(g,b);this.gc.lineTo(g,a);this.gc.lineTo(h,a);this.gc.closePath();this.gc.fillStyle=this.mouseover.bullet;this.gc.fill();this.gc.lineWidth=1;this.gc.lineJoin="round";this.gc.strokeStyle=this.mouseover.border;this.gc.stroke();this.gc.textAlign="left";this.gc.textBaseline="top";this.gc.fillStyle=this.mouseover.color;g=0;for(a+=3;g<d.length;++g,
a+=f)this.gc.fillText(d[g],h+3,a)}return this},pie:function(){var a=this.dlen;if(a){var b=0,c=[],f=[],d=2*Math.PI,e=[],h=/percent/.test(this.labels.x);if(1<a){for(var g=0,b=a,a=0;a<b;a++)g+=this.dataset[a].avg;if(g)for(a=0;a<b;a++)c[a]=this.dataset[a].avg/g*d,f[a]=this.dataset[a].col,e.push(h?Math.round(100*this.dataset[a].avg/g)+"%":this.dataset[a].avg.toString())}else if(g=this.dataset[0],g.sum){b=g.len;for(a=0;a<b;a++)c[a]=g.val[a]/g.sum*d,f[a]=harryTools.COLORS[a%harryTools.COLORS.length],e.push(h?
Math.round(100*g.val[a]/g.sum)+"%":g.val[a].toString())}var d=this.rx+Math.round(this.rw/2),h=this.ry+Math.round(this.rh/2),g=Math.min(this.rh/2,this.rw/2)-1,k=g+0.7*this.labels.fontpx,i,l=-Math.PI/2,m;this.gc.lineWidth=this.linewidth;this.gc.lineJoin="miter";for(a=0;a<b;a++)m=l+c[a],i=this.getGradient(f[a]),this.gc.beginPath(),this.gc.moveTo(d,h),this.gc.arc(d,h,g,l,m,!1),this.gc.closePath(),i&&(this.gc.fillStyle=i,this.gc.fill()),this.gc.strokeStyle=f[a],this.gc.stroke(),i=(l+m)/2,this.drawXLabel(e[a],
d+k*Math.cos(i),h+k*Math.sin(i),"center","middle"),l=m}return this},chart:function(a){var b=this.dlen;this.overpoints=[];if(b){var c,f,d=this.dataset[0].len,e=1<b?4:0,h=a?1:b,g=d&&b?(this.rw-e*(d-1))/d/h-1:0;0>g&&(g=0);var k,i,l,m=this.rx,j,n=a?this.dsum?this.rh/this.dsum:0:this.dmax?this.rh/this.dmax:0;this.gc.lineWidth=this.linewidth;this.gc.lineJoin="miter";for(f=0;f<b;f++)this.overpoints.push({x:[],y:[],v:[],nds:f});for(c=0;c<d;c++){this.drawXLabel(c,m+(g+1)*h/2,this.h-1);l=this.ry2;for(f=0;f<
b;f++){k=this.dataset[f];if(k.val[c]){y0=a?l:this.ry2;l=y0-Math.round(n*k.val[c]);i=Math.round(m);j=Math.round(m+g);this.gc.beginPath();this.gc.moveTo(i,y0);this.gc.lineTo(i,l);this.gc.lineTo(j,l);this.gc.lineTo(j,y0);this.gc.closePath();if(i=this.getGradient(k.col))this.gc.fillStyle=i,this.gc.fill();this.gc.strokeStyle=k.col;this.gc.stroke();this.overpoints[f].x.push(0.5+Math.floor(m+g/2));this.overpoints[f].y.push(l);this.overpoints[f].v.push(k.val[c])}a||(m+=g+1)}m+=a?g+1+e:e}}return this},chartOver:function(a,
b){return this.lineOver(a,b)},curve:function(a){return this.line(a,!0)},curveOver:function(a,b,c){return this.lineOver(a,b,c,!0)},line:function(a,b){var c=this.dlen,f=a?this.dsum?this.rh/this.dsum:0:this.dmax?this.rh/this.dmax:0,d,e,h,g,k;this.gc.lineWidth=this.linewidth;this.gc.lineJoin=this.linejoin;for(this.overpoints=[];d=this.dataset[--c];)if(1<(k=d.val.length)){var i,l,m,j=[],n=[],o;for(e=0;e<k;++e){g=0;if(a)for(h=0;h<=c;h++)g+=this.dataset[h].val[e];else g=d.val[e];j.push(this.rx+Math.round(e*
(this.rw/(k-1))));n.push(this.ry2-Math.round(f*g))}this.overpoints.push({x:j,y:n,v:this.dataset[c].val,nds:c});e--;j.push(this.rx+Math.round(e*(this.rw/(k-1))));n.push(this.ry2-Math.round(f*g));if(e=this.getGradient(d.col)){this.gc.fillStyle=e;o=!1;for(e=0;e<k;++e)null===d.val[e]?o&&(this.gc.lineTo(j[e-1],this.ry2),this.gc.closePath(),this.gc.fill(),o=!1):o?null===d.val[e+1]||!b?this.gc.lineTo(j[e],n[e]):(l=(j[e]+j[e+1])/2,m=(n[e]+n[e+1])/2,h=(j[e]+l)/2,i=(n[e]+m)/2,this.gc.quadraticCurveTo(j[e],
n[e],h,i),h=(l+j[e+1])/2,i=(m+n[e+1])/2,this.gc.quadraticCurveTo(l,m,h,i)):(this.gc.beginPath(),this.gc.moveTo(j[e],this.ry2),this.gc.lineTo(j[e],n[e]),o=!0);o&&(this.gc.lineTo(j[e-1],this.ry2),this.gc.closePath(),this.gc.fill())}this.gc.strokeStyle=d.col;this.gc.beginPath();o=!1;for(e=0;e<k;++e)null===d.val[e]?o=!1:o?null===d.val[e+1]||!b?this.gc.lineTo(j[e],n[e]):(l=(j[e]+j[e+1])/2,m=(n[e]+n[e+1])/2,h=(j[e]+l)/2,i=(n[e]+m)/2,this.gc.quadraticCurveTo(j[e],n[e],h,i),h=(l+j[e+1])/2,i=(m+n[e+1])/2,
this.gc.quadraticCurveTo(l,m,h,i)):(o=!0,this.gc.moveTo(j[e],n[e]));this.gc.stroke();if(0==c)for(e=0;e<k;++e)this.drawXLabel(e,j[e],this.h);if(this.radiuspoint){this.gc.fillStyle=d.col;for(e=0;e<k;++e)void 0!=d.val[e]&&(this.gc.beginPath(),this.gc.arc(j[e],n[e],this.radiuspoint,0,2*Math.PI),this.gc.closePath(),this.gc.fill())}}return this},lineOver:function(a,b){var c,f=!1,d,e,h=this.mouseover.linewidth||1;if(this.overpoints.length){d=this.overpoints[0];for(c=0;c<d.x.length;++c)if(void 0!=d.v[c]&&
(Math.abs(a-d.x[c])<e||!1===f))e=Math.abs(a-d.x[c]),f=c;if(!1!==f)for(c=0;c<this.overpoints.length;++c)if(d=this.overpoints[c],void 0!=d.v[f]){this.gc.beginPath();this.gc.lineWidth=h;this.gc.arc(d.x[f],d.y[f],this.mouseover.radius,0,2*Math.PI);0==this.mouseover.linewidth?(this.gc.fillStyle=this.mouseover.circle,this.gc.fill()):(this.gc.strokeStyle=this.mouseover.circle,this.gc.stroke());if(this.mouseover.axis){this.gc.lineWidth=1;if(/x/i.test(this.mouseover.axis)){for(b=d.y[f]+this.mouseover.radius;b<
this.ry2;)this.gc.moveTo(d.x[f],b),b+=2,b>this.ry2&&(b=this.ry2),this.gc.lineTo(d.x[f],b),b+=2;this.gc.stroke()}if(/y/i.test(this.mouseover.axis)){for(a=d.x[f]+this.mouseover.radius;a<this.rx2;)this.gc.moveTo(a,d.y[f]),a+=2,a>this.rx2&&(a=this.rx2),this.gc.lineTo(a,d.y[f]),a+=2;this.gc.stroke()}}this.drawBullet(d.x[f],d.y[f],h/2+1+this.mouseover.radius,d.v[f],f,d.nds)}}},getFillMode:function(){return"a"==this.fill?(this.opacity=1,/\:river/.test(this.mode)?"v":/line/.test(this.mode)||/curve/.test(this.mode)?
1<this.dlen?"n":"v":/chart/.test(this.mode)?1<this.dlen?"s":"v":/pie/.test(this.mode.test)?"r":"s"):this.fill},getGradient:function(a){var b=!1;switch(this.getFillMode()){case "s":b=harryTools.calcColor(a,21,this.opacity);break;case "v":b=this.gc.createLinearGradient(0,this.ry2,0,this.ry);b.addColorStop(0,harryTools.calcColor(a,-48,this.opacity));b.addColorStop(1,harryTools.calcColor(a,48,this.opacity));this.gc.fillStyle=b;break;case "h":b=this.gc.createLinearGradient(this.rx,0,this.rx2,0);b.addColorStop(0,
harryTools.calcColor(a,-48,this.opacity));b.addColorStop(1,harryTools.calcColor(a,48,this.opacity));this.gc.fillStyle=b;break;case "r":b=this.gc.createRadialGradient(this.rx2,this.ry2,0,this.rx,this.ry2,1),b.addColorStop(1,harryTools.calcColor(a,-48,this.opacity)),b.addColorStop(0,harryTools.calcColor(a,48,this.opacity)),this.gc.fillStyle=b}return b}};var plotter=function(a){return new harry(a)};