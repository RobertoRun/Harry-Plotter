// harry plotter 0.8
// ~L~ nikomomo@gmail.com 2009-2012
// https://github.com/nikopol/Harry-Plotter
var harry=function(g){var R="#88a4d7 #d685c9 #86d685 #ffc34f #93c2ea #f28989 #f9eb8a".split(" "),C=function(b,a,e){var c,b=b&&b.constructor==Array&&3==b.length?b:(c=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(b))?[parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10)]:(c=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(b))?[2.55*parseFloat(c[1]),2.55*parseFloat(c[2]),2.55*parseFloat(c[3])]:(c=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(b))?
[parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],16)]:(c=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(b))?[parseInt(c[1]+c[1],16),parseInt(c[2]+c[2],16),parseInt(c[3]+c[3],16)]:[0,0,0];"array"!=typeof a&&(a=[a,a,a]);for(c=0;3>c;++c)b[c]=Math.max(Math.min(b[c]+a[c],255),0);return void 0!=e?"rgba("+b.join(",")+","+e+")":"rgb("+b.join(",")+")"},N=function(b){var a=b.match(/\d+px/i);return a?parseInt(a,10):(a=b.match(/[0-9\.]+em/i))?Math.floor(16*parseFloat(a,10)):(a=b.match(/\d+pt/i))?Math.floor(1.3333*
parseInt(a,10)):10},ga=function(a){var d=Math.floor(a).toString(),e=parseInt(d.substr(0,1));return e*parseFloat("1E"+(d.length-1))==a?a:(e+1)*parseFloat("1E"+(d.length-1))},O=function(a,d){if("object"==typeof d)for(var e in d)a[e]=d[e];return a},ha=function(a){a=a||window.event;if("offsetX"in a)return{x:a.offsetX,y:a.offsetY};for(var d=a.target,a={x:a.pageX,y:a.pageY};d.offsetParent;)a.x-=d.offsetLeft,a.y-=d.offsetTop,d=d.offsetParent;return a},j;if(g.canvas)j=document.getElementById(g.canvas);else{j=
g.container;var S=g.width||300,X=g.height||150,T=document.createElement("canvas");T.setAttribute("width",S+"px");T.setAttribute("height",X+"px");(j?document.getElementById(j):document.body).appendChild(T);j=T}var w=j,F=w.width,G=w.height,a=w.getContext("2d"),Y,ia=g.background,x=g.mode||"line",ja=(g.fill||"a")[0].toLowerCase().replace(/[^nasvhrdl]/,"a"),q=parseFloat(g.opacity,10)||1,U=parseInt(g.linewidth,10)||1,sa=g.linejoin||"miter",ka=parseInt(g.radiuspoint,10)||0,la=!1===g.autoscale?!1:!0,i=O({color:"#a0a0a0",
font:'normal 9px "Sans Serif"',marks:0},g.labels),m=!1===g.mouseover?!1:O({radius:5,linewidth:U,circle:"#888",font:'normal 10px "Sans Serif"',color:"#fff",bullet:"rgba(99,99,99,0.8)",border:"#fff",axis:!1,text:"%v"},g.mouseover),z,s=[],L=!1,ma,Z,$,u=!1===g.legends?!1:O({x:5,y:5,color:"#666",border2:"#fff",background:"rgba(255,255,255,0.5)",font:'10px "Sans Serif"'},g.legends);g.margins?j=g.margins:/pie/.test(G.mode)?(j=i.x?2*N(i.font):!1===m?0:10,j=[j,j,j,j]):(j=N(i.font),S=Math.floor(j/2),X=i.marks,
j=[i.y?S:0,i.y?4*j:1,i.x?2+j+X:1,i.x?S:0]);var t=O({color:"#a0a0a0",x:[0,100],y:[0,25,50,75,100]},g.grid),D=g.title?O({font:'bold 12px "Sans Serif"',color:"rgba(4,4,4,0.3)",x:j[3]+2,y:j[0]+2,z:"top"},"string"==typeof g.title?{text:g.title}:g.title):!1,r=[],aa,H,y=0,E,A,P,I,B,J,o,Q,na=function(a){var d,e=a.values||a,c=a.labels||[],f={val:[],lab:[],len:0,sum:0,avg:0,max:0,min:0xffffffffffff,tit:a.title||"dataset#"+(r.length+1),col:a.color||R[r.length%R.length]};for(d in e){a=parseFloat(e[d],10);f.val.push(e[d]==
null?null:a);f.lab.push(c[d]||d);f.sum=f.sum+a;if(a>f.max)f.max=a;if(a<f.min)f.min=a}f.len=f.val.length;f.avg=f.len?f.sum/f.len:0;r.push(f);y=r.length;if(y==1){aa=f.min;E=H=la?ga(f.max):f.max}else{aa=Math.min(f.min,aa);H=Math.max(f.max,H);d=E=0;for(e=r[0].val.length;d<e;++d){for(a=c=0;a<r.length;++a)c=c+(r[a].val[d]||0);c>E&&(E=la?ga(c):c)}}},oa=function(a){if(a instanceof Array&&typeof a[0]=="object")for(var d=0,e=a.length;d<e;++d)na(a[d]);else na(a)},ba=function(b){var d,e;if(ja=="a"){q=1;e=/\:river/.test(x)?
"v":/line/.test(x)||/curve/.test(x)?y>1?"n":"v":/chart/.test(x)?y>1?"s":"v":/pie/.test(x.test)?"r":"s"}else e=ja;switch(e){case "s":d=C(b,0,q);break;case "l":d=C(b,21,q);break;case "d":d=C(b,-21,q);break;case "v":d=a.createLinearGradient(0,o,0,P);d.addColorStop(0,C(b,-48,q));d.addColorStop(1,C(b,48,q));break;case "h":d=a.createLinearGradient(A,0,J,0);d.addColorStop(0,C(b,-48,q));d.addColorStop(1,C(b,48,q));break;case "r":d=a.createRadialGradient(J,o,0,A,o,1);d.addColorStop(1,C(b,-48,q));d.addColorStop(0,
C(b,48,q))}return d?a.fillStyle=d:false},K=function(b){if(b&&a.hasOwnProperty("shadowBlur")){b=b.split(/[ ,;:-]/);a.shadowOffsetX=parseInt(b[0]||1,10);a.shadowOffsetY=parseInt(b[1]||1,10);a.shadowBlur=parseInt(b[2]||1,10);a.shadowColor=b[3]||"#000"}},M=function(){if(a.hasOwnProperty("clearShadow"))a.clearShadow();else if(a.hasOwnProperty("shadowBlur")){a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;a.shadowColor="rgba(0,0,0,0)"}},pa=function(){if(D){K(D.shadow);a.font=D.font;a.textAlign="left";
a.textBaseline="top";a.fillStyle=D.color;a.fillText(D.text,D.x,D.y);M()}},ca=function(b,d,e,c,f){if(i.x&&b%i.x==0){b=r[0].lab[b]||b;K(i.shadow);a.font=i.font;a.fillStyle=i.color;a.textAlign=c||"center";a.textBaseline=f||"alphabetic";a.fillText(b,d,e);a.unsetShadow()}if(i.marks){a.save();a.lineWidth=1;a.moveTo(d,o);a.lineTo(d,o+i.marks);a.strokeStyle=i.color;a.stroke();a.restore()}},ra=function(b,d){a.save();a.font=m.font;var e,c,f,k=b.length,h,v,l=0,n=0,V=N(m.font),da=V/2,g=V+3,i,p,j=F;p=0;i=G;var qa=
0;b.sort(function(a,b){return parseInt(b.v,10)-parseInt(a.v,10)});for(c=0;c<k;c++){h=b[c];f=r[h.nds].lab[h.n];v=r[h.nds].tit;if(f=typeof m.text=="function"?m.text(h.n,h.v,f,h.x,h.y):m.text.replace("%v",h.v).replace("%l",f).replace("%n",h.n).replace("%t",v)){h.lines=f.split(/\n|\\n/);h.h=h.lines.length*g;h.h2=Math.floor(h.h/2);h.w=0;for(e in h.lines)if((f=a.measureText(h.lines[e]).width+6)>h.w)h.w=f;if(h.w>n)n=h.w;l=l+h.h;h.r++;j>h.x-h.r&&(j=h.x-h.r);p<h.x+h.r&&(p=h.x+h.r);if(i>h.y)i=h.y;if(qa<h.y)qa=
h.y}}k>1&&(n=n+(6+V));if(l){l=l+3;if(d){p=j+(p-j)/2-n/2;p+n>F&&(p=F-1-n)}else p+n>=F&&(p=j-n);p<1&&(p=1);p=Math.floor(p)+0.5;e=p+n;c=i+l/2+l/2;c>o&&(c=o-1);c=Math.floor(c)+0.5;h=c-l;a.beginPath();a.moveTo(p,c);a.lineTo(e,c);a.lineTo(e,h);a.lineTo(p,h);a.closePath();K(m.shadowbox);a.fillStyle=m.bullet;a.fill();M();a.lineWidth=1;a.lineJoin="round";a.strokeStyle=m.border;a.stroke();a.textAlign="left";a.textBaseline="top";i=h+3-1;for(c=0;c<k;c++){h=b[c];l=p+3-1;if(k>1){a.beginPath();a.arc(l+da,i+da,da,
0,2*Math.PI);a.fillStyle=r[h.nds].col;a.fill();l=l+(V+3)}K(m.shadow);a.fillStyle=m.color;for(e=0;e<h.lines.length;++e,i=i+g)a.fillText(h.lines[e],l,i);M()}}a.restore()},fa={line:function(b,d){var e=y,c=b?E?B/E:0:H?B/H:0,f,k,h,v,l,n=function(a,b,c,f,e,h){for(var k,i,v,l,g,n;e<=h;)if(f[e]===null)e++;else if(d){k=b[e];i=c[e];for(e++;e<=h&&f[e]===null;)e++;if(e>h)a.lineTo(k,i);else{v=(k+b[e])/2;l=(i+c[e])/2;g=(k+v)/2;n=(i+l)/2;a.quadraticCurveTo(k,i,g,n);g=(v+b[e])/2;n=(l+c[e])/2;a.quadraticCurveTo(v,
l,g,n)}}else{a.lineTo(b[e],c[e]);e++}};a.lineWidth=U;a.lineJoin=sa;for(s=[];f=r[--e];)if((l=f.val.length)>1){var i=[],g=[];for(k=0;k<l;++k){v=0;if(b)for(h=0;h<=e;h++)v=v+r[h].val[k];else v=f.val[k];i.push(A+Math.round(k*(I/(l-1))));g.push(o-Math.round(c*v))}s.push({x:i,y:g,v:r[e].val,nds:e});k--;i.push(A+Math.round(k*(I/(l-1))));g.push(o-Math.round(c*v));for(k=0;f.val[k]===null;)k++;for(h=l-1;f.val[h]===null;)h--;if(k<=h&&ba(f.col)){a.beginPath();a.moveTo(i[k],o);a.lineTo(i[k],g[k]);n(a,i,g,f.val,
k,h);a.lineTo(i[h],o);a.closePath();a.fill()}a.strokeStyle=f.col;a.beginPath();a.moveTo(i[k],g[k]);n(a,i,g,f.val,k,h);a.stroke();if(e==0)for(k=0;k<l;++k)ca(k,i[k],G);if(ka){a.fillStyle=f.col;for(k=0;k<l;++k)if(f.val[k]!=void 0){a.beginPath();a.arc(i[k],g[k],ka,0,2*Math.PI);a.closePath();a.fill()}}}},curve:function(a){fa.line(a,true)},chart:function(b){var d=y;s=[];if(d){var e,c,f=r[0].len,k=d>1?4:0,h=b?1:d,i=f&&d?(I-k*(f-1))/f/h-1:0,l,g,j,m=A,ea,t,p=b?E?B/E:0:H?B/H:0;i<0&&(i=0);a.lineWidth=U;a.lineJoin=
"miter";for(c=0;c<d;c++)s.push({x:[],y:[],v:[],nds:c});for(e=0;e<f;e++){ca(e,m+(i+1)*h/2,G-1);g=o;for(c=0;c<d;c++){l=r[c];j=b?g:o;g=j-Math.round(p*l.val[e]);ea=Math.round(m);t=Math.round(m+i);if(l.val[e]!==null){a.beginPath();a.moveTo(ea,j);a.lineTo(ea,g);a.lineTo(t,g);a.lineTo(t,j);a.closePath();ba(l.col)&&a.fill();a.strokeStyle=l.col;a.stroke()}s[c].x.push(0.5+Math.floor(m+i/2));s[c].y.push(g);s[c].v.push(l.val[e]);b||(m=m+(i+1))}m=m+(b?i+1+k:k)}}},pie:function(){var b=y;s=[];if(b){var d=0,e=[],
c=[],f=Math.PI*2,k=[],h=[];if(b>1){for(var g=0,d=b,b=0;b<d;b++)g=g+r[b].sum;if(g)for(b=0;b<d;b++){e[b]=r[b].sum/g*f;c[b]=r[b].col;k.push(r[b].sum);h.push(Math.round(100*r[b].sum/g))}}else{g=r[0];if(g.sum){d=g.len;for(b=0;b<d;b++){e[b]=g.val[b]/g.sum*f;c[b]=R[b%R.length];k.push(g.val[b]);h.push(Math.round(100*g.val[b]/g.sum))}}}var f=A+Math.round(I/2),g=P+Math.round(B/2),l=Math.min(B/2,I/2)-1,j=l+i.fontpx,m,o,t=Math.PI*1.5,u,p,w,x,q=L;ma=l;Z=f;$=g;L=q;a.lineWidth=U;a.lineJoin="miter";for(b=0;b<d;b++){u=
t+e[b];p=(t+u)/2;s.push({a:t%(2*Math.PI),n:b});if(b===q){m=f+Math.cos(p)*10;o=g+Math.sin(p)*10}else{m=f;o=g}a.beginPath();a.moveTo(m,o);a.arc(m,o,l,t,u,false);a.closePath();ba(c[b])&&a.fill();a.strokeStyle=c[b];a.stroke();if(b===q){w=m+j/2*Math.cos(p);x=o+j/2*Math.sin(p)}else ca(k[b],m+j*Math.cos(p),o+j*Math.sin(p),"center","middle");t=u}q!==false&&ra([{x:w,y:x,r:0,v:k[q]+" ("+h[q]+"%)",n:q,nds:0}],true);s.sort(function(a,b){return a.a-b.a})}}},W={line:function(b,d){var e,c=false,f,g,h=m.linewidth||
1,i=[];if(s.length){f=s[0];for(e=0;e<f.x.length;++e)if(f.v[e]!=void 0&&(Math.abs(b-f.x[e])<g||c===false)){g=Math.abs(b-f.x[e]);c=e}if(c!==false){for(e=0;e<s.length;++e){f=s[e];if(f.v[c]!=void 0){if(m.border){a.beginPath();a.lineWidth=h+2;a.arc(f.x[c],f.y[c],m.radius,0,2*Math.PI);if(m.linewidth==0){a.fillStyle=m.border;a.fill()}else{a.strokeStyle=m.border;a.stroke()}}a.beginPath();a.lineWidth=h;a.arc(f.x[c],f.y[c],m.radius,0,2*Math.PI);if(m.linewidth==0){a.fillStyle=m.circle;a.fill()}else{a.strokeStyle=
m.circle;a.stroke()}if(m.axis){a.lineWidth=1;if(/x/i.test(m.axis)){for(d=f.y[c]+m.radius;d<o;){a.moveTo(f.x[c],d);d=d+2;d>o&&(d=o);a.lineTo(f.x[c],d);d=d+2}a.stroke()}if(/y/i.test(m.axis)){for(b=f.x[c]+m.radius;b<J;){a.moveTo(b,f.y[c]);b=b+2;b>J&&(b=J);a.lineTo(b,f.y[c]);b=b+2}a.stroke()}}i.push({x:f.x[c],y:f.y[c],r:h/2+1+m.radius,v:f.v[c],n:c,nds:f.nds})}}ra(i)}}},chart:function(a,d){W.line(a,d)},curve:function(a,d,e){W.line(a,d,e,true)},pie:function(a,d){var e,c=0;if(Math.sqrt(Math.pow(a-Z,2)+Math.pow(d-
$,2))<=ma){e=Math.PI-Math.atan2($-d,a-Z);for(e=(e+3*Math.PI)%(2*Math.PI);c<s.length&&e>s[c].a;)c++;--c<0&&(c=s.length-1);L=s[c].n;Q(true)}else if(L!==false){L=false;Q(true)}}};Q=function(b){var d=x.split(/:/),e=d[0],c=d[1]||false;a.clearRect(0,0,F,G);if(ia){a.fillStyle=ia;a.fillRect(0,0,F,G)}if(/chart|line|curve/.test(x)){var f,g;a.lineWidth=t.linewidth||1;a.strokeStyle=t.color;if(t.x){d=0;for(f=t.x.length;d<f;++d){g=A+Math.round(I*t.x[d]/100);a.beginPath();a.moveTo(g,P);a.lineTo(g,o);a.stroke()}}if(t.y){d=
0;for(f=t.y.length;d<f;++d){g=o-Math.round(B*t.y[d]/100);a.beginPath();a.moveTo(A,g);a.lineTo(J,g);a.stroke()}}}if(y&&i.y&&/chart|line|curve/.test(x)){var d=/\:[r|s]/.test(x)?E:H,h,j,l,n=d<10?100:d<100?10:1,q=Math.floor(i.fontpx/2.5);K(i.shadow);a.font=i.font;a.fillStyle=i.color;a.textAlign="left";f=0;for(g=i.y.length;f<g;++f){h=J+1;j=o-Math.round(B*i.y[f]/100);l=Math.round(n*d*i.y[f]/100)/n;a.fillText(l,h,j+q)}M()}if(D&&D.z=="top"){fa[e](c);pa()}else{pa();fa[e](c)}if(u!==false&&y>1){a.save();a.font=
u.font;l=0;f=N(u.font)+3;g=f-3;h=y;q=3+f*h;j=u.x;for(var s=u.y,d=0;d<h;++d)if((n=a.measureText(r[d].tit)).width>l)l=n.width;n=9+g+l;a.lineWidth=1;if(l=u.background){a.save();a.fillStyle=l;a.fillRect(j,s,n,q)}if(l=u.border){a.strokeStyle=l;a.strokeRect(j,s,n,q)}d=0;for(n=s+3;d<h;++d,n=n+f){q=r[d];K(u.shadowbox);a.fillStyle=q.col;a.fillRect(j+3,n,g,g);M();if(l=u.border2){a.strokeStyle=l;a.strokeRect(j+3,n,g,g)}K(u.shadow);a.textAlign="left";a.textBaseline="top";a.fillStyle=u.color;a.fillText(q.tit,
j+6+g,n);M()}a.restore()}if(!b){w.onmouseover=w.onmousemove=w.onmouseout=void 0;L=false;if(m){Y=a.getImageData(0,0,F,G);if(z)W[e](z.x,z.y,c);w.onmouseover=function(a){z=ha(a)};w.onmousemove=function(b){if(z){e!="pie"&&a.putImageData(Y,0,0);z=ha(b);W[e](z.x,z.y,c)}};w.onmouseout=function(){z=void 0;a.putImageData(Y,0,0)}}else z=void 0}};i.fontpx=N(i.font);/none|false/.test(t.x)&&(t.x=[]);/none|false/.test(t.y)&&(t.y=[]);A=j[3]+0.5;P=j[0]+0.5;I=Math.max(F-j[1]-j[3],0);B=Math.max(G-j[0]-j[2],0);J=A+
I;o=P+B;g.datas&&oa(g.datas);Q();return{canvas:w,data:r,clear:function(){r=[];y=0;return this},load:function(a){oa(a);return this},cls:function(){return this},draw:function(a){a&&(x=a.toLowerCase());Q();return this}}},plotter=function(g){return harry(g)};