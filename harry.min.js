// harry plotter 0.7
// ~L~ nikomomo@gmail.com 2009-2012
// https://github.com/nikopol/Harry-Plotter
var harryTools={COLORS:"#88a4d7 #d685c9 #86d685 #ffc34f #93c2ea #f28989 #f9eb8a".split(" "),count:0,getRGB:function(a){var b;return a&&a.constructor==Array&&3==a.length?a:(b=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(a))?[parseInt(b[1],10),parseInt(b[2],10),parseInt(b[3],10)]:(b=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(a))?[2.55*parseFloat(b[1]),2.55*parseFloat(b[2]),2.55*parseFloat(b[3])]:(b=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(a))?
[parseInt(b[1],16),parseInt(b[2],16),parseInt(b[3],16)]:(b=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(a))?[parseInt(b[1]+b[1],16),parseInt(b[2]+b[2],16),parseInt(b[3]+b[3],16)]:[0,0,0]},calcColor:function(a,b,c){a=harryTools.getRGB(a);"array"!=typeof b&&(b=[b,b,b]);for(var e=0;3>e;++e)a[e]=Math.max(Math.min(a[e]+b[e],255),0);return void 0!=c?"rgba("+a.join(",")+","+c+")":"rgb("+a.join(",")+")"},fontPixSize:function(a){var b=a.match(/\d+px/i);return b?parseInt(b,10):(b=a.match(/[0-9\.]+em/i))?
Math.floor(16*parseFloat(b,10)):(b=a.match(/\d+pt/i))?Math.floor(1.3333*parseInt(b,10)):10},scaleUp:function(a){var b=Math.floor(a).toString(),c=parseInt(b.substr(0,1));return c*parseFloat("1E"+(b.length-1))==a?a:(c+1)*parseFloat("1E"+(b.length-1))},merge:function(a,b){if("object"==typeof b)for(var c in b)a[c]=b[c];return a},mouseXY:function(a){return{x:void 0!=a.offsetX&&a.offsetX||void 0!=a.layerX&&a.layerX||void 0!=a.clientX&&a.clientX,y:void 0!=a.offsetY&&a.offsetY||void 0!=a.layerY&&a.layerY||
void 0!=a.clientY&&a.clientY}}},harry=function(a){this.clear();a.canvas?this.canvas=document.getElementById(a.canvas):(this.canvas=document.createElement("canvas"),a.id&&this.canvas.setAttribute("id",a.id),document.getElementById(a.container).appendChild(this.canvas),this.canvas.setAttribute("width",(a.width||300)+"px"),this.canvas.setAttribute("height",(a.height||150)+"px"));this.w=this.canvas.width;this.h=this.canvas.height;this.id=a.id||"harry"+ ++harryTools.count;this.bg=a.background;this.setMode(a.mode);
this.fill=(a.fill||"a")[0].toLowerCase().replace(/[^nasvhrdl]/,"a");this.opacity=parseFloat(a.opacity,10)||1;this.linewidth=parseInt(a.linewidth,10)||1;this.linejoin=a.linejoin||"miter";this.radiuspoint=parseInt(a.radiuspoint,10)||0;this.autoscale=!1===a.autoscale?!1:!0;this.labels=harryTools.merge({color:"#a0a0a0",font:'normal 9px "Sans Serif"',marks:0},a.labels);this.labels.fontpx=harryTools.fontPixSize(this.labels.font);this.mouseover=!1===a.mouseover?!1:harryTools.merge({radius:5,linewidth:this.linewidth,
circle:"#888",font:'normal 10px "Sans Serif"',color:"#fff",bullet:"rgba(99,99,99,0.8)",border:"#fff",axis:!1,text:"%v"},a.mouseover);this.legends=!1===a.legends?!1:harryTools.merge({x:5,y:5,color:"#666",border2:"#fff",background:"rgba(255,255,255,0.5)",font:'10px "Sans Serif"'},a.legends);if(a.margins)this.margins=a.margins;else if(/pie/.test(this.mode)){var b=this.labels.x?2*this.labels.fontpx:0;this.margins=[b,b,b,b]}else{var b=this.labels.fontpx,c=Math.floor(this.labels.fontpx/2),e=this.labels.marks;
this.margins=[this.labels.y?c:0,this.labels.y?4*b:1,this.labels.x?2+b+e:1,this.labels.x?c:0]}this.grid=a.grid||{};this.grid.color=this.grid.color||"#a0a0a0";this.grid.x=this.grid.x||[0,100];/none|false/.test(this.grid.x)&&(this.grid.x=[]);this.grid.y=this.grid.y||[0,25,50,75,100];/none|false/.test(this.grid.y)&&(this.grid.y=[]);"string"==typeof a.title&&(a.title={text:a.title});this.title=a.title?harryTools.merge({font:'bold 12px "Sans Serif"',color:"rgba(4,4,4,0.3)",x:this.margins[3]+2,y:this.margins[0]+
2,z:"top"},a.title):!1;this.gc=this.canvas.getContext("2d");a.datas&&this.addDataSets(a.datas);this.rx=this.margins[3]+0.5;this.ry=this.margins[0]+0.5;this.rw=Math.max(this.w-this.margins[1]-this.margins[3],0);this.rh=Math.max(this.h-this.margins[0]-this.margins[2],0);this.rx2=this.rx+this.rw;this.ry2=this.ry+this.rh;this.overpie={n:!1};this.cls().draw()};
harry.prototype={clear:function(){this.dataset=[];this.dmin=4294967295;this.dmax=0;return this},setMode:function(a){this.mode=a||"line";return this},addDataSets:function(a){if(a.constructor==Array&&"object"==typeof a[0])for(var b=0,c=a.length;b<c;++b)this.addDataSet(a[b]);else this.addDataSet(a);return this},addDataSet:function(a){var b,c=a.values||a,e=a.labels||[],f={val:[],lab:[],len:0,sum:0,avg:0,max:0,min:0xffffffffffff,tit:a.title||"dataset#"+(this.dataset.length+1),col:a.color||harryTools.COLORS[this.dataset.length%
harryTools.COLORS.length]};for(b in c)if(a=parseFloat(c[b],10),f.val.push(null==c[b]?null:a),f.lab.push(e[b]||b),f.sum+=a,a>f.max&&(f.max=a),a<f.min)f.min=a;f.len=f.val.length;f.avg=f.len?f.sum/f.len:0;this.dataset.push(f);this.dlen=this.dataset.length;if(1==this.dlen)this.dmin=f.min,this.dsum=this.dmax=this.autoscale?harryTools.scaleUp(f.max):f.max;else{this.dmin=Math.min(f.min,this.dmin);this.dmax=Math.max(f.max,this.dmax);b=this.dsum=0;for(c=this.dataset[0].val.length;b<c;++b){for(a=e=0;a<this.dataset.length;++a)e+=
this.dataset[a].val[b]||0;e>this.dsum&&(this.dsum=this.autoscale?harryTools.scaleUp(e):e)}}return this},draw:function(a,b){this.mode=(a||this.mode).toLowerCase();var c=this.mode.split(/:/),e=this,f=c[0]+"Over";this.drawGrid().drawYLabels();if(this.title&&"top"==this.title.z)this[c[0]](1==c.length?!1:c[1]).drawTitle();else this.drawTitle()[c[0]](1==c.length?!1:c[1]);this.drawLegends();if(!b)if(this.canvas.onmouseover=this.canvas.onmousemove=this.canvas.onmouseout=void 0,this.overpie.n=!1,this.mouseover&&
this[c[0]+"Over"]){this.imgdata=this.gc.getImageData(0,0,this.w,this.h);if(this.mousepos)e[f](e.mousepos.x,e.mousepos.y,c[1]);this.canvas.onmouseover=function(a){e.mousepos=harryTools.mouseXY(a)};this.canvas.onmousemove=function(a){e.mousepos&&("pie"!=c[0]&&e.gc.putImageData(e.imgdata,0,0),e.mousepos=harryTools.mouseXY(a||window.event),e[f](e.mousepos.x,e.mousepos.y,c[1]))};this.canvas.onmouseout=function(){e.mousepos=void 0;e.gc.putImageData(e.imgdata,0,0)}}else this.mousepos=void 0;return this},
cls:function(){this.gc.clearRect(0,0,this.w,this.h);this.bg&&(this.gc.fillStyle=this.bg,this.gc.fillRect(0,0,this.w,this.h));return this},drawTitle:function(){this.title&&this.gc.font&&(this.gc.font=this.title.font,this.gc.textAlign="left",this.gc.textBaseline="top",this.gc.fillStyle=this.title.color,this.gc.fillText(this.title.text,this.title.x,this.title.y));return this},drawGrid:function(){if(/chart|line|curve/.test(this.mode)){var a,b,c;this.gc.lineWidth=this.grid.linewidth||1;this.gc.strokeStyle=
this.grid.color;if(this.grid.x){a=0;for(b=this.grid.x.length;a<b;++a)c=this.rx+Math.round(this.rw*this.grid.x[a]/100),this.gc.beginPath(),this.gc.moveTo(c,this.ry),this.gc.lineTo(c,this.ry2),this.gc.stroke()}if(this.grid.y){a=0;for(b=this.grid.y.length;a<b;++a)c=this.ry2-Math.round(this.rh*this.grid.y[a]/100),this.gc.beginPath(),this.gc.moveTo(this.rx,c),this.gc.lineTo(this.rx2,c),this.gc.stroke()}}return this},drawYLabels:function(){if(this.dlen&&(this.labels.y&&this.gc.font)&&/chart|line|curve/.test(this.mode)){var a=
/\:[r|s]/.test(this.mode)?this.dsum:this.dmax,b,c,e,f,m,h=10>a?100:100>a?10:1,g=Math.floor(this.labels.fontpx/2.5);this.gc.font=this.labels.font;this.gc.fillStyle=this.labels.color;this.gc.textAlign="left";b=0;for(c=this.labels.y.length;b<c;++b)e=this.rx2+1,f=this.ry2-Math.round(this.rh*this.labels.y[b]/100),m=Math.round(h*a*this.labels.y[b]/100)/h,this.gc.fillText(m,e,f+g)}return this},drawXLabel:function(a,b,c,e,f){this.gc.font&&(this.labels.x&&0==a%this.labels.x)&&(a=this.dataset[0].lab[a]||a,
this.gc.font=this.labels.font,this.gc.fillStyle=this.labels.color,this.gc.textAlign=e||"center",this.gc.textBaseline=f||"alphabetic",this.gc.fillText(a,b,c));this.labels.marks&&(this.gc.save(),this.gc.lineWidth=1,this.gc.moveTo(b,this.ry2),this.gc.lineTo(b,this.ry2+this.labels.marks),this.gc.strokeStyle=this.labels.color,this.gc.stroke(),this.gc.restore());return this},drawLegends:function(){if(!1!==this.legends&&1<this.dlen){this.gc.save();this.gc.font=this.legends.font;var a,b,c;c=0;var e=harryTools.fontPixSize(this.legends.font)+
3,f=e-3,m=this.dlen,h=3+e*m,g=this.legends.x,j=this.legends.y;for(a=0;a<m;++a)if((b=this.gc.measureText(this.dataset[a].tit)).width>c)c=b.width;b=9+f+c;this.gc.lineWidth=1;if(c=this.legends.background)this.gc.fillStyle=c,this.gc.fillRect(g,j,b,h);if(c=this.legends.border)this.gc.strokeStyle=c,this.gc.strokeRect(g,j,b,h);a=0;for(b=j+3;a<m;++a,b+=e){d=this.dataset[a];this.gc.fillStyle=d.col;this.gc.fillRect(g+3,b,f,f);if(c=this.legends.border2)this.gc.strokeStyle=c,this.gc.strokeRect(g+3,b,f,f);this.gc.textAlign=
"left";this.gc.textBaseline="top";this.gc.fillStyle=this.legends.color;this.gc.fillText(d.tit,g+6+f,b)}this.gc.restore()}return this},drawBullet:function(a,b,c,e,f,m,h){this.gc.save();this.gc.font=this.mouseover.font;var g,j,k=0,l=this.dataset[m].lab[f],i=this.dataset[m].tit;j="function"==typeof this.mouseover.text?this.mouseover.text(f,e,l,a,b):this.mouseover.text.replace("%v",e).replace("%l",l).replace("%n",f).replace("%t",i);f=j.split(/\n|\\n/);e=harryTools.fontPixSize(this.mouseover.font)+3;l=
3+f.length*e;i=Math.floor(l/2);if(j){for(g in f)if((j=this.gc.measureText(f[g]).width+6)>k)k=j;if(h)h=a+c-k/2,h<this.rx&&(h=this.rx),g=h+k,g>this.rx2&&(g=this.rx2-1,h=g-k),b+=l/2,b>this.ry2&&(b=this.ry2-1),a=b-l;else{h=a+c;g=h+k;if(g>=this.rx2||m%2&&0<a-c-k)g=a-c,h=g-k;b+=i;a=b-l;b>=this.rh?(b=this.rh-0.5,a=b-l):0>a&&(a=1.5,b=a+l)}this.gc.beginPath();this.gc.moveTo(h,b);this.gc.lineTo(g,b);this.gc.lineTo(g,a);this.gc.lineTo(h,a);this.gc.closePath();this.gc.fillStyle=this.mouseover.bullet;this.gc.fill();
this.gc.lineWidth=1;this.gc.lineJoin="round";this.gc.strokeStyle=this.mouseover.border;this.gc.stroke();this.gc.textAlign="left";this.gc.textBaseline="top";this.gc.fillStyle=this.mouseover.color;g=0;for(a+=3;g<f.length;++g,a+=e)this.gc.fillText(f[g],h+3,a)}this.gc.restore();return this},pie:function(){var a=this.dlen;this.overpoints=[];if(a){var b=0,c=[],e=[],f=2*Math.PI,m=[],h=[];if(1<a){for(var g=0,b=a,a=0;a<b;a++)g+=this.dataset[a].sum;if(g)for(a=0;a<b;a++)c[a]=this.dataset[a].sum/g*f,e[a]=this.dataset[a].col,
m.push(this.dataset[a].sum),h.push(Math.round(100*this.dataset[a].sum/g))}else if(g=this.dataset[0],g.sum){b=g.len;for(a=0;a<b;a++)c[a]=g.val[a]/g.sum*f,e[a]=harryTools.COLORS[a%harryTools.COLORS.length],m.push(g.val[a]),h.push(Math.round(100*g.val[a]/g.sum))}var f=this.rx+Math.round(this.rw/2),g=this.ry+Math.round(this.rh/2),j=Math.min(this.rh/2,this.rw/2)-1,k=j+this.labels.fontpx,l,i,n,o=1.5*Math.PI,r,p,s,t,q=this.overpie.n;this.overpie={r:j,x:f,y:g,n:q};this.gc.lineWidth=this.linewidth;this.gc.lineJoin=
"miter";for(a=0;a<b;a++)r=o+c[a],p=(o+r)/2,this.overpoints.push({a:o%(2*Math.PI),n:a}),a===q?(l=f+10*Math.cos(p),i=g+10*Math.sin(p)):(l=f,i=g),n=this.getGradient(e[a]),this.gc.beginPath(),this.gc.moveTo(l,i),this.gc.arc(l,i,j,o,r,!1),this.gc.closePath(),n&&(this.gc.fillStyle=n,this.gc.fill()),this.gc.strokeStyle=e[a],this.gc.stroke(),a===q?(s=l+k/2*Math.cos(p),t=i+k/2*Math.sin(p)):this.drawXLabel(m[a],l+k*Math.cos(p),i+k*Math.sin(p),"center","middle"),o=r;!1!==q&&this.drawBullet(s,t,0,m[q]+" ("+h[q]+
"%)",q,0,!0);this.overpoints.sort(function(a,b){return a.a-b.a})}return this},pieOver:function(a,b){var c,e=0;if(Math.sqrt(Math.pow(a-this.overpie.x,2)+Math.pow(b-this.overpie.y,2))<=this.overpie.r){c=Math.PI-Math.atan2(this.overpie.y-b,a-this.overpie.x);for(c=(c+3*Math.PI)%(2*Math.PI);e<this.overpoints.length&&c>this.overpoints[e].a;)e++;0>--e&&(e=this.overpoints.length-1);this.overpie.n=this.overpoints[e].n;this.cls().draw("pie",!0)}else!1!==this.overpie.n&&(this.overpie.n=!1,this.cls().draw("pie",
!0));return this},chart:function(a){var b=this.dlen;this.overpoints=[];if(b){var c,e,f=this.dataset[0].len,m=1<b?4:0,h=a?1:b,g=f&&b?(this.rw-m*(f-1))/f/h-1:0;0>g&&(g=0);var j,k,l,i=this.rx,n,o=a?this.dsum?this.rh/this.dsum:0:this.dmax?this.rh/this.dmax:0;this.gc.lineWidth=this.linewidth;this.gc.lineJoin="miter";for(e=0;e<b;e++)this.overpoints.push({x:[],y:[],v:[],nds:e});for(c=0;c<f;c++){this.drawXLabel(c,i+(g+1)*h/2,this.h-1);l=this.ry2;for(e=0;e<b;e++){j=this.dataset[e];y0=a?l:this.ry2;l=y0-Math.round(o*
j.val[c]);k=Math.round(i);n=Math.round(i+g);if(null!==j.val[c]){this.gc.beginPath();this.gc.moveTo(k,y0);this.gc.lineTo(k,l);this.gc.lineTo(n,l);this.gc.lineTo(n,y0);this.gc.closePath();if(k=this.getGradient(j.col))this.gc.fillStyle=k,this.gc.fill();this.gc.strokeStyle=j.col;this.gc.stroke()}this.overpoints[e].x.push(0.5+Math.floor(i+g/2));this.overpoints[e].y.push(l);this.overpoints[e].v.push(j.val[c]);a||(i+=g+1)}i+=a?g+1+m:m}}return this},chartOver:function(a,b){return this.lineOver(a,b)},curve:function(a){return this.line(a,
!0)},curveOver:function(a,b,c){return this.lineOver(a,b,c,!0)},line:function(a,b){var c=this.dlen,e=a?this.dsum?this.rh/this.dsum:0:this.dmax?this.rh/this.dmax:0,f,m,h,g,j,k,l=function(a,c,e,f,g,h){for(var i,j,k,l,m,n;g<=h;)if(null===f[g])g++;else if(b){i=c[g];j=e[g];for(g++;g<=h&&null===f[g];)g++;g>h?a.lineTo(i,j):(k=(i+c[g])/2,l=(j+e[g])/2,m=(i+k)/2,n=(j+l)/2,a.quadraticCurveTo(i,j,m,n),m=(k+c[g])/2,n=(l+e[g])/2,a.quadraticCurveTo(k,l,m,n))}else a.lineTo(c[g],e[g]),g++};this.gc.lineWidth=this.linewidth;
this.gc.lineJoin=this.linejoin;for(this.overpoints=[];f=this.dataset[--c];)if(1<(k=f.val.length)){var i=[],n=[];for(h=0;h<k;++h){j=0;if(a)for(g=0;g<=c;g++)j+=this.dataset[g].val[h];else j=f.val[h];i.push(this.rx+Math.round(h*(this.rw/(k-1))));n.push(this.ry2-Math.round(e*j))}this.overpoints.push({x:i,y:n,v:this.dataset[c].val,nds:c});h--;i.push(this.rx+Math.round(h*(this.rw/(k-1))));n.push(this.ry2-Math.round(e*j));for(h=0;null===f.val[h];)h++;for(g=k-1;null===f.val[g];)g--;if(h<=g&&(m=this.getGradient(f.col)))this.gc.beginPath(),
this.gc.moveTo(i[h],this.ry2),this.gc.lineTo(i[h],n[h]),l(this.gc,i,n,f.val,h,g),this.gc.lineTo(i[g],this.ry2),this.gc.closePath(),this.gc.fillStyle=m,this.gc.fill();this.gc.strokeStyle=f.col;this.gc.beginPath();this.gc.moveTo(i[h],n[h]);l(this.gc,i,n,f.val,h,g);this.gc.stroke();if(0==c)for(h=0;h<k;++h)this.drawXLabel(h,i[h],this.h);if(this.radiuspoint){this.gc.fillStyle=f.col;for(h=0;h<k;++h)void 0!=f.val[h]&&(this.gc.beginPath(),this.gc.arc(i[h],n[h],this.radiuspoint,0,2*Math.PI),this.gc.closePath(),
this.gc.fill())}}return this},lineOver:function(a,b){var c,e=!1,f,m,h=this.mouseover.linewidth||1;if(this.overpoints.length){f=this.overpoints[0];for(c=0;c<f.x.length;++c)if(void 0!=f.v[c]&&(Math.abs(a-f.x[c])<m||!1===e))m=Math.abs(a-f.x[c]),e=c;if(!1!==e)for(c=0;c<this.overpoints.length;++c)if(f=this.overpoints[c],void 0!=f.v[e]){this.mouseover.border&&(this.gc.beginPath(),this.gc.lineWidth=h+2,this.gc.arc(f.x[e],f.y[e],this.mouseover.radius,0,2*Math.PI),0==this.mouseover.linewidth?(this.gc.fillStyle=
this.mouseover.border,this.gc.fill()):(this.gc.strokeStyle=this.mouseover.border,this.gc.stroke()));this.gc.beginPath();this.gc.lineWidth=h;this.gc.arc(f.x[e],f.y[e],this.mouseover.radius,0,2*Math.PI);0==this.mouseover.linewidth?(this.gc.fillStyle=this.mouseover.circle,this.gc.fill()):(this.gc.strokeStyle=this.mouseover.circle,this.gc.stroke());if(this.mouseover.axis){this.gc.lineWidth=1;if(/x/i.test(this.mouseover.axis)){for(b=f.y[e]+this.mouseover.radius;b<this.ry2;)this.gc.moveTo(f.x[e],b),b+=
2,b>this.ry2&&(b=this.ry2),this.gc.lineTo(f.x[e],b),b+=2;this.gc.stroke()}if(/y/i.test(this.mouseover.axis)){for(a=f.x[e]+this.mouseover.radius;a<this.rx2;)this.gc.moveTo(a,f.y[e]),a+=2,a>this.rx2&&(a=this.rx2),this.gc.lineTo(a,f.y[e]),a+=2;this.gc.stroke()}}this.drawBullet(f.x[e],f.y[e],h/2+1+this.mouseover.radius,f.v[e],e,f.nds,!1)}}return this},getFillMode:function(){return"a"==this.fill?(this.opacity=1,/\:river/.test(this.mode)?"v":/line/.test(this.mode)||/curve/.test(this.mode)?1<this.dlen?"n":
"v":/chart/.test(this.mode)?1<this.dlen?"s":"v":/pie/.test(this.mode.test)?"r":"s"):this.fill},getGradient:function(a){var b=!1;switch(this.getFillMode()){case "s":b=harryTools.calcColor(a,0,this.opacity);break;case "l":b=harryTools.calcColor(a,21,this.opacity);break;case "d":b=harryTools.calcColor(a,-21,this.opacity);break;case "v":b=this.gc.createLinearGradient(0,this.ry2,0,this.ry);b.addColorStop(0,harryTools.calcColor(a,-48,this.opacity));b.addColorStop(1,harryTools.calcColor(a,48,this.opacity));
this.gc.fillStyle=b;break;case "h":b=this.gc.createLinearGradient(this.rx,0,this.rx2,0);b.addColorStop(0,harryTools.calcColor(a,-48,this.opacity));b.addColorStop(1,harryTools.calcColor(a,48,this.opacity));this.gc.fillStyle=b;break;case "r":b=this.gc.createRadialGradient(this.rx2,this.ry2,0,this.rx,this.ry2,1),b.addColorStop(1,harryTools.calcColor(a,-48,this.opacity)),b.addColorStop(0,harryTools.calcColor(a,48,this.opacity)),this.gc.fillStyle=b}return b}};var plotter=function(a){return new harry(a)};