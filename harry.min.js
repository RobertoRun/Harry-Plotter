// harry plotter 0.8
// ~L~ nikomomo@gmail.com 2009-2012
// https://github.com/nikopol/Harry-Plotter
var harry=function(i){var Y="#88a4d7 #d685c9 #86d685 #ffc34f #93c2ea #f28989 #f9eb8a".split(" "),G=function(b,a,f){var d,b=b&&b.constructor==Array&&3==b.length?b:(d=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(b))?[parseInt(d[1],10),parseInt(d[2],10),parseInt(d[3],10)]:(d=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(b))?[2.55*parseFloat(d[1]),2.55*parseFloat(d[2]),2.55*parseFloat(d[3])]:(d=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(b))?[parseInt(d[1],16),parseInt(d[2],16),parseInt(d[3],16)]:(d=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(b))?[parseInt(d[1]+d[1],16),parseInt(d[2]+d[2],16),parseInt(d[3]+d[3],16)]:[0,0,0];"array"!=typeof a&&(a=[a,a,a]);for(d=0;3>d;++d)b[d]=Math.max(Math.min(b[d]+a[d],255),0);return void 0!=f?"rgba("+b.join(",")+","+f+")":"rgb("+b.join(",")+")"},T=function(b){var a=b.match(/\d+px/i);return a?parseInt(a,10):(a=b.match(/[0-9\.]+em/i))?Math.floor(16*parseFloat(a)):(a=b.match(/\d+pt/i))?Math.floor(1.3333*
parseInt(a,10)):10},la=function(b){var a=Math.floor(b).toString(),f=parseInt(a.substr(0,1),10);return f*parseFloat("1E"+(a.length-1))==b?b:(f+1)*parseFloat("1E"+(a.length-1))},U=function(a,c){if("object"==typeof c)for(var f in c)a[f]=c[f];return a},ma=function(a){a=a||window.event;if("offsetX"in a)return{x:a.offsetX,y:a.offsetY};for(var c=a.target,a={x:a.pageX,y:a.pageY};c.offsetParent;)a.x-=c.offsetLeft,a.y-=c.offsetTop,c=c.offsetParent;return a},g;if(i.canvas)g=document.getElementById(i.canvas);
else{g=i.container;var R=i.width||300,da=i.height||150,Z=document.createElement("canvas"),$;Z.setAttribute("width",R+"px");Z.setAttribute("height",da+"px");g&&($="string"==typeof g?document.getElementById(g):g);$||($=document.body);$.appendChild(Z);g=Z}var B=g,I=B.width,P=B.height,a=B.getContext("2d"),ea,na=i.background,z=i.mode||"line",oa=(i.fill||"a")[0].toLowerCase().replace(/[^nasvhrdl]+/g,"a"),C=parseFloat(i.opacity)||1,aa=parseInt(i.linewidth,10)||1,ya=i.linejoin||"miter",pa=parseInt(i.radiuspoint,
10)||0,qa=i.autoscale&&/top/i.test(i.autoscale),fa=i.autoscale&&/bot/i.test(i.autoscale),k=U({color:"#a0a0a0",font:'normal 9px "Sans Serif"',marks:0,ypos:"right"},i.labels),m=!1===i.mouseover?!1:U({radius:5,linewidth:aa,circle:"#888",font:'normal 10px "Sans Serif"',color:"#fff",bullet:"rgba(99,99,99,0.8)",axis:!1,text:"%v"},i.mouseover),D,x=[],S=!1,ra,ga,ha;i.margins?g=i.margins:(R=z,g=T(k.font),/pie/.test(R)?(g=k.x?2*g:!1===m?0:15,g=[g,g,g,g]):(R=Math.floor(g/2),da=k.marks,g=[k.y?R:0,k.y&&/r/i.test(k.ypos)?
4*g:k.x?g:1,k.x?3+g+da:k.y?g:1,k.y&&/l/i.test(k.ypos)?4*g:k.x?R:0]));var E=g,w=U({color:"#a0a0a0",x:[0,100],y:[0,25,50,75,100]},i.grid),F=i.title?U({font:'bold 12px "Sans Serif"',color:"rgba(4,4,4,0.3)",x:E[3]+2,y:E[0]+2,z:"top"},i.title):!1,y=!1===i.legends?!1:U({x:E[3]+2,y:E[0]+2+(i.title&&!i.title.x?2+T(F.font):0),color:"#666",font:'10px "Sans Serif"'},i.legends),sa,q=[],Q,t,p=0,J,K,V,A,W,L,H,M,r,X,ba=function(){var a,c,f,d;p=q.length;sa=/\:[rs]/.test(z);Q=t=!1;K=J=V=0;if(p){for(a=0;a<p;a++)c=
q[a],Q=!1===Q?c.min:Math.min(c.min,Q),t=!1===t?c.max:Math.max(c.max,t);qa&&(t=la(t));if(sa){a=0;for(f=q[0].len;a<f;++a){for(c=d=0;c<p;++c)d+=q[c].val[a]||0;d>J&&(J=qa?la(d):d)}K=fa?J-Q:J}else J=t,K=fa?t-Q:t;V=fa?Q:0}k.fontpx=T(k.font);/none|false/.test(w.x)&&(w.x=[]);/none|false/.test(w.y)&&(w.y=[]);A=E[3];W=E[0];L=Math.max(I-E[1]-E[3],0);H=Math.max(P-E[0]-E[2],0);M=A+L;r=W+H},ta=function(a){var c,f=a.values||a,d=a.labels||[],j={val:[],lab:[],len:0,sum:0,avg:0,max:0,min:0xffffffffffff,tit:a.title||
"dataset#"+(q.length+1),col:a.color||Y[q.length%Y.length]};for(c in f)a=parseFloat(f[c]),j.val.push(null==f[c]?null:a),j.lab.push(d[c]||c),j.sum+=a,a>j.max&&(j.max=a),a<j.min&&(j.min=a);j.len=j.val.length;j.avg=j.len?j.sum/j.len:0;q.push(j)},ua=function(a){if(a instanceof Array&&"object"==typeof a[0])for(var c=0,f=a.length;c<f;++c)ta(a[c]);else ta(a);ba()},ia=function(b){var c,f;"a"==oa?(C=1,f=/\:river/.test(z)?"v":/line/.test(z)||/curve/.test(z)?1<p?"n":"v":/chart/.test(z)?1<p?"s":"v":/pie/.test(z.test)?
"r":"s"):f=oa;switch(f){case "s":c=G(b,0,C);break;case "l":c=G(b,21,C);break;case "d":c=G(b,-21,C);break;case "v":c=a.createLinearGradient(0,r,0,W);c.addColorStop(0,G(b,-48,C));c.addColorStop(1,G(b,48,C));break;case "h":c=a.createLinearGradient(A,0,M,0);c.addColorStop(0,G(b,-48,C));c.addColorStop(1,G(b,48,C));break;case "r":c=a.createRadialGradient(M,r,0,A,r,1),c.addColorStop(1,G(b,-48,C)),c.addColorStop(0,G(b,48,C))}return c?a.fillStyle=c:!1},N=function(b){b&&a.hasOwnProperty("shadowBlur")&&(b=b.split(/[ ,;:-]/),
a.shadowOffsetX=parseInt(b[0]||1,10),a.shadowOffsetY=parseInt(b[1]||1,10),a.shadowBlur=parseInt(b[2]||1,10),a.shadowColor=b[3]||"#000")},O=function(){a.hasOwnProperty("clearShadow")?a.clearShadow():a.hasOwnProperty("shadowBlur")&&(a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0)},va=function(){F&&(N(F.shadow),a.font=F.font,a.textAlign="left",a.textBaseline="top",a.fillStyle=F.color,a.fillText(F.text,F.x,F.y),O())},ja=function(b,c,f,d,j){a.save();k.x&&0==b%k.x&&(b=q[0].lab[b]||b,N(k.shadow),a.font=
k.font,a.fillStyle=k.color,a.textAlign=d||"center",a.textBaseline=j||"alphabetic",a.fillText(b,c,f),O());k.marks&&(a.lineWidth=1,a.beginPath(),a.moveTo(c,r),a.lineTo(c,r+k.marks),a.strokeStyle=k.color,a.stroke());a.restore()},xa=function(b,c){a.save();a.font=m.font;var f,d,j,h=b.length,e,u,l=0,v=0,n=T(m.font),k=Math.floor(n/2),i=n+3,g,s,p=I;s=0;g=P;var wa=0;b.sort(function(a,b){return parseInt(b.v,10)-parseInt(a.v,10)});for(d=0;d<h;d++)if(e=b[d],j=q[e.nds].lab[e.n],u=q[e.nds].tit,j="function"==typeof m.text?
m.text(e.n,e.v,j,e.x,e.y):m.text.replace("%v",e.v).replace("%l",j).replace("%n",e.n).replace("%t",u).replace("%p",e.pct)){e.lines=j.split(/\n|\\n/);e.h=e.lines.length*i;e.h2=Math.floor(e.h/2);e.w=0;for(f in e.lines)if((j=a.measureText(e.lines[f]).width+6)>e.w)e.w=j;e.w>v&&(v=e.w);l+=e.h;e.r++;p>e.x-e.r&&(p=e.x-e.r);s<e.x+e.r&&(s=e.x+e.r);g>e.y&&(g=e.y);wa<e.y&&(wa=e.y)}1<h&&(v+=6+n);if(l){l+=3;c?(s=p+(s-p)/2-v/2,s+v>I&&(s=I-1-v)):s+v>=I&&(s=p-v);1>s&&(s=1);s=Math.floor(s);f=s+v;d=g+l/2+l/2;d>r&&(d=
r-1);d=Math.floor(d);e=d-l;a.beginPath();a.moveTo(s,d);a.lineTo(f,d);a.lineTo(f,e);a.lineTo(s,e);a.closePath();m.bullet&&(N(m.shadowbox),a.strokStyle="",a.fillStyle=m.bullet,a.fill(),O());m.border&&(a.lineWidth=1,a.lineJoin="round",a.strokeStyle=m.border,a.stroke());a.textAlign="left";a.textBaseline="top";g=e+3;for(d=0;d<h;d++){e=b[d];l=s+3;1<h&&(a.beginPath(),a.arc(l+k,g+k,k,0,2*Math.PI),a.fillStyle=q[e.nds].col,a.fill(),l+=n+3);N(m.shadow);a.fillStyle=m.color;for(f=0;f<e.lines.length;++f,g+=i)a.fillText(e.lines[f],
l,g);O()}}a.restore()},ka={line:function(b,c){var f=p,d=K?H/K:0,j,h,e,u,l,k=function(a,b,d,f,e,h){for(var j,u,l,g,k,n;e<=h;)if(null===f[e])e++;else if(c){j=b[e];u=d[e];for(e++;e<=h&&null===f[e];)e++;e>h?a.lineTo(j,u):(l=(j+b[e])/2,g=(u+d[e])/2,k=(j+l)/2,n=(u+g)/2,a.quadraticCurveTo(j,u,k,n),k=(l+b[e])/2,n=(g+d[e])/2,a.quadraticCurveTo(l,g,k,n))}else a.lineTo(b[e],d[e]),e++};a.lineWidth=aa;a.lineJoin=ya;for(x=[];j=q[--f];)if(1<(l=j.len)){var n=[],g=[];for(h=0;h<l;++h){u=0;if(b)for(e=0;e<=f;e++)u+=
q[e].val[h]-V;else u=j.val[h]-V;n.push(A+Math.round(h*(L/(l-1))));g.push(r-Math.round(d*u))}x.push({x:n,y:g,v:q[f].val,nds:f});h--;n.push(A+Math.round(h*(L/(l-1))));g.push(r-Math.round(d*u));for(h=0;null===j.val[h];)h++;for(e=l-1;null===j.val[e];)e--;h<=e&&ia(j.col)&&(a.beginPath(),a.moveTo(n[h],r),a.lineTo(n[h],g[h]),k(a,n,g,j.val,h,e),a.lineTo(n[e],r),a.closePath(),a.fill());a.strokeStyle=j.col;a.beginPath();a.moveTo(n[h],g[h]);k(a,n,g,j.val,h,e);a.stroke();if(0==f)for(h=0;h<l;++h)ja(h,n[h],P-3);
if(pa){a.fillStyle=j.col;for(h=0;h<l;++h)void 0!=j.val[h]&&(a.beginPath(),a.arc(n[h],g[h],pa,0,2*Math.PI),a.closePath(),a.fill())}}},curve:function(a){ka.line(a,!0)},chart:function(b){x=[];if(p){var c,f,d=q[0].len,j=1<p?4:0,h=b?1:p,e=d&&p?(L-j*(d-1))/d/h-1:0,u,l,g,k=A,i,m,w=b?J?H/J:0:t?H/t:0;0>e&&(e=0);a.lineWidth=aa;a.lineJoin="miter";for(f=0;f<p;f++)x.push({x:[],y:[],v:[],nds:f});for(c=0;c<d;c++){ja(c,k+(e+1)*h/2,P-3);l=r;for(f=0;f<p;f++)u=q[f],g=b?l:r,l=g-Math.round(w*u.val[c]),i=Math.round(k),
m=Math.round(k+e),null!==u.val[c]&&(a.beginPath(),a.moveTo(i,g),a.lineTo(i,l),a.lineTo(m,l),a.lineTo(m,g),a.closePath(),ia(u.col)&&a.fill(),a.strokeStyle=u.col,a.stroke()),x[f].x.push(Math.floor(k+e/2)),x[f].y.push(l),x[f].v.push(u.val[c]),b||(k+=e+1);k+=b?e+1+j:j}}},pie:function(){x=[];if(p){var b,c=0,f=[],d=[],j=2*Math.PI,h=[],e=[];if(1<p){var g=0;for(b=0;b<p;b++)g+=q[b].sum;if(g){b=0;for(c=p;b<p;b++)f[b]=q[b].sum/g*j,d[b]=q[b].col,h.push(q[b].sum),e.push(Math.round(100*q[b].sum/g))}}else if(g=
q[0],g.sum){c=g.len;for(b=0;b<c;b++)f[b]=g.val[b]/g.sum*j,d[b]=Y[b%Y.length],h.push(g.val[b]),e.push(Math.round(100*g.val[b]/g.sum))}var j=A+Math.round(L/2),g=W+Math.round(H/2),l=Math.min(H/2,L/2)-1,i=l+k.fontpx,n,m,r=1.5*Math.PI,w,s,y,z,t=S;ra=l;ga=j;ha=g;S=t;a.lineWidth=aa;a.lineJoin="miter";for(b=0;b<c;b++)w=r+f[b],s=(r+w)/2,x.push({a:r%(2*Math.PI),n:b}),b===t?(n=j+10*Math.cos(s),m=g+10*Math.sin(s)):(n=j,m=g),a.beginPath(),a.moveTo(n,m),a.arc(n,m,l,r,w,!1),a.closePath(),ia(d[b])&&a.fill(),a.strokeStyle=
d[b],a.stroke(),b===t?(y=n+i/2*Math.cos(s),z=m+i/2*Math.sin(s)):ja(h[b],n+i*Math.cos(s),m+i*Math.sin(s),"center","middle"),r=w;!1!==t&&xa([{x:y,y:z,r:0,v:h[t],pct:e[t]+"%",n:t,nds:1<p?t:0}],!0);x.sort(function(a,b){return a.a-b.a})}}},ca={line:function(b){var c,f=!1,d,g,h=m.linewidth||1,e=[];if(x.length){d=x[0];for(c=0;c<d.x.length;++c)if(void 0!=d.v[c]&&(Math.abs(b-d.x[c])<g||!1===f))g=Math.abs(b-d.x[c]),f=c;if(!1!==f){for(c=0;c<x.length;++c)if(d=x[c],void 0!=d.v[f]){m.border2&&(a.beginPath(),a.lineWidth=
h+2,a.arc(d.x[f],d.y[f],m.radius,0,2*Math.PI),0==m.linewidth?(a.fillStyle=m.border2,a.fill()):(a.strokeStyle=m.border2,a.stroke()));a.beginPath();a.lineWidth=h;a.arc(d.x[f],d.y[f],m.radius,0,2*Math.PI);0==m.linewidth?(a.fillStyle=m.circle,a.fill()):(a.strokeStyle=m.circle,a.stroke());if(m.axis){a.lineWidth=1;if(/x/i.test(m.axis)){for(b=d.y[f]+m.radius;b<r;)a.moveTo(d.x[f],b),b+=2,b>r&&(b=r),a.lineTo(d.x[f],b),b+=2;a.stroke()}if(/y/i.test(m.axis)){for(b=d.x[f]+m.radius;b<M;)a.moveTo(b,d.y[f]),b+=2,
b>M&&(b=M),a.lineTo(b,d.y[f]),b+=2;a.stroke()}}e.push({x:d.x[f],y:d.y[f],r:h/2+1+m.radius,v:d.v[f],n:f,nds:d.nds})}xa(e)}}},chart:function(a,c){ca.line(a,c)},curve:function(a,c,f){ca.line(a,c,f,!0)},pie:function(a,c){var f,d=0;if(Math.sqrt(Math.pow(a-ga,2)+Math.pow(c-ha,2))<=ra){f=Math.PI-Math.atan2(ha-c,a-ga);for(f=(f+3*Math.PI)%(2*Math.PI);d<x.length&&f>x[d].a;)d++;0>--d&&(d=x.length-1);S=x[d].n;X(!0)}else!1!==S&&(S=!1,X(!0))}};X=function(b){var c=z.split(/:/),f=c[0],d=c[1]||!1;a.clearRect(-1,-1,
I+1,P+1);na&&(a.fillStyle=na,a.fillRect(-1,-1,I+1,P+1));if(/chart|line|curve/.test(z)){var g,h;a.lineWidth=w.linewidth||1;a.strokeStyle=w.color;if(w.x){c=0;for(g=w.x.length;c<g;++c)h=A+Math.round(L*w.x[c]/100),a.beginPath(),a.moveTo(h,W),a.lineTo(h,r),a.stroke()}if(w.y){c=0;for(g=w.y.length;c<g;++c)h=r-Math.round(H*w.y[c]/100),a.beginPath(),a.moveTo(A,h),a.lineTo(M,h),a.stroke()}}if(p&&k.y&&/chart|line|curve/.test(z)){var e,i,l=10>K?100:100>K?10:1;N(k.shadow);a.font=k.font;a.fillStyle=k.color;a.textBaseline=
"middle";c=0;for(g=k.y.length;c<g;++c)e=r-Math.round(H*k.y[c]/100),i=V+K*k.y[c]/100,i=Math.round(l*i)/l,/r/i.test(k.ypos)&&(h=M+1,a.textAlign="left",a.fillText(i,h,e)),/l/i.test(k.ypos)&&(h=A-2,a.textAlign="right",a.fillText(i,h,e));O()}F&&"top"==F.z?(ka[f](d),va()):(va(),ka[f](d));if(!1!==y&&1<p){a.save();a.font=y.font;var v,n,l=0;g=T(y.font)+3;h=g-3;e=p;n=3+g*e;i=y.x;for(var t=y.y,c=0;c<e;++c)if((v=a.measureText(q[c].tit)).width>l)l=v.width;v=9+h+l;a.lineWidth=1;if(l=y.background)N(y.shadowbox),
a.fillStyle=l,a.fillRect(i,t,v,n),O();if(l=y.border)a.strokeStyle=l,a.strokeRect(i,t,v,n);c=0;for(v=t+3;c<e;++c,v+=g){n=q[c];N(y.shadow);a.fillStyle=n.col;a.fillRect(i+3,v,h,h);O();if(l=y.border2)a.strokeStyle=l,a.strokeRect(i+3,v,h,h);N(y.shadow);a.textAlign="left";a.textBaseline="top";a.fillStyle=y.color;a.fillText(n.tit,i+6+h,v);O()}a.restore()}if(!b)if(B.onmouseover=B.onmousemove=B.onmouseout=void 0,S=!1,m){ea=a.getImageData(0,0,I,P);if(D)ca[f](D.x,D.y,d);B.onmouseover=function(a){D=ma(a)};B.onmousemove=
function(b){D&&("pie"!=f&&a.putImageData(ea,0,0),D=ma(b),ca[f](D.x,D.y,d))};B.onmouseout=function(){D=void 0;a.putImageData(ea,0,0)}}else D=void 0};a.translate(0.5,0.5);i.datas?ua(i.datas):ba();X();return{canvas:B,data:q,clear:function(){q=[];p=0;ba();return this},load:function(a){ua(a);return this},cls:function(){return this},draw:function(a){a&&(z=a.toLowerCase(),ba());X();return this}}},plotter=harry;
