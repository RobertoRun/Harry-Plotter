// harry plotter 0.8
// ~L~ nikomomo@gmail.com 2009-2012
// https://github.com/nikopol/Harry-Plotter
var harry=function(e){var S="#88a4d7 #d685c9 #86d685 #ffc34f #93c2ea #f28989 #f9eb8a".split(" "),E=function(b,a,g){var c,b=b&&b.constructor==Array&&3==b.length?b:(c=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(b))?[parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10)]:(c=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(b))?[2.55*parseFloat(c[1]),2.55*parseFloat(c[2]),2.55*parseFloat(c[3])]:(c=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(b))?
[parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],16)]:(c=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(b))?[parseInt(c[1]+c[1],16),parseInt(c[2]+c[2],16),parseInt(c[3]+c[3],16)]:[0,0,0];"array"!=typeof a&&(a=[a,a,a]);for(c=0;3>c;++c)b[c]=Math.max(Math.min(b[c]+a[c],255),0);return void 0!=g?"rgba("+b.join(",")+","+g+")":"rgb("+b.join(",")+")"},O=function(b){var a=b.match(/\d+px/i);return a?parseInt(a,10):(a=b.match(/[0-9\.]+em/i))?Math.floor(16*parseFloat(a)):(a=b.match(/\d+pt/i))?Math.floor(1.3333*
parseInt(a,10)):10},ga=function(b){var a=Math.floor(b).toString(),g=parseInt(a.substr(0,1),10);return g*parseFloat("1E"+(a.length-1))==b?b:(g+1)*parseFloat("1E"+(a.length-1))},P=function(a,d){if("object"==typeof d)for(var g in d)a[g]=d[g];return a},ha=function(a){a=a||window.event;if("offsetX"in a)return{x:a.offsetX,y:a.offsetY};for(var d=a.target,a={x:a.pageX,y:a.pageY};d.offsetParent;)a.x-=d.offsetLeft,a.y-=d.offsetTop,d=d.offsetParent;return a},k;if(e.canvas)k=document.getElementById(e.canvas);
else{k=e.container;var T=e.width||300,Y=e.height||150,U=document.createElement("canvas");U.setAttribute("width",T+"px");U.setAttribute("height",Y+"px");(k?document.getElementById(k):document.body).appendChild(U);k=U}var y=k,G=y.width,H=y.height,a=y.getContext("2d"),Z,ia=e.background,u=e.mode||"line",ja=(e.fill||"a")[0].toLowerCase().replace(/[^nasvhrdl]/,"a"),w=parseFloat(e.opacity)||1,V=parseInt(e.linewidth,10)||1,sa=e.linejoin||"miter",ka=parseInt(e.radiuspoint,10)||0,la=!1===e.autoscale?!1:!0,
i=P({color:"#a0a0a0",font:'normal 9px "Sans Serif"',marks:0,ypos:"right"},e.labels),l=!1===e.mouseover?!1:P({radius:5,linewidth:V,circle:"#888",font:'normal 10px "Sans Serif"',color:"#fff",bullet:"rgba(99,99,99,0.8)",border:"#fff",axis:!1,text:"%v"},e.mouseover),B,o=[],N=!1,ma,$,aa;e.margins?k=e.margins:(k=O(i.font),/pie/.test(H.mode)?(k=i.x?2*k:!1===l?0:15,k=[k,k,k,k]):(T=Math.floor(k/2),Y=i.marks,k=[i.y?T:0,i.y&&/right/i.test(i.ypos)?4*k:i.x?k:1,i.x?3+k+Y:i.y?k:1,i.y&&/left/i.test(i.ypos)?4*k:i.x?
T:0]));var s=P({color:"#a0a0a0",x:[0,100],y:[0,25,50,75,100]},e.grid),C=e.title?P({font:'bold 12px "Sans Serif"',color:"rgba(4,4,4,0.3)",x:k[3]+2.5,y:k[0]+2.5,z:"top"},e.title):!1,v=!1===e.legends?!1:P({x:k[3]+2.5,y:k[0]+2.5+(e.title&&!e.title.x?2+O(C.font):0),color:"#666",border2:"#fff",font:'10px "Sans Serif"'},e.legends),q=[],ba,I,z=0,F,A,Q,J,D,K,r,R,na=function(a){var d,g=a.values||a,c=a.labels||[],j={val:[],lab:[],len:0,sum:0,avg:0,max:0,min:0xffffffffffff,tit:a.title||"dataset#"+(q.length+1),
col:a.color||S[q.length%S.length]};for(d in g){a=parseFloat(g[d]);j.val.push(g[d]==null?null:a);j.lab.push(c[d]||d);j.sum=j.sum+a;if(a>j.max)j.max=a;if(a<j.min)j.min=a}j.len=j.val.length;j.avg=j.len?j.sum/j.len:0;q.push(j);z=q.length;if(z==1){ba=j.min;F=I=la?ga(j.max):j.max}else{ba=Math.min(j.min,ba);I=Math.max(j.max,I);d=F=0;for(g=q[0].val.length;d<g;++d){for(a=c=0;a<q.length;++a)c=c+(q[a].val[d]||0);c>F&&(F=la?ga(c):c)}}},oa=function(a){if(a instanceof Array&&typeof a[0]=="object")for(var d=0,g=
a.length;d<g;++d)na(a[d]);else na(a)},ca=function(b){var d,g;if(ja=="a"){w=1;g=/\:river/.test(u)?"v":/line/.test(u)||/curve/.test(u)?z>1?"n":"v":/chart/.test(u)?z>1?"s":"v":/pie/.test(u.test)?"r":"s"}else g=ja;switch(g){case "s":d=E(b,0,w);break;case "l":d=E(b,21,w);break;case "d":d=E(b,-21,w);break;case "v":d=a.createLinearGradient(0,r,0,Q);d.addColorStop(0,E(b,-48,w));d.addColorStop(1,E(b,48,w));break;case "h":d=a.createLinearGradient(A,0,K,0);d.addColorStop(0,E(b,-48,w));d.addColorStop(1,E(b,48,
w));break;case "r":d=a.createRadialGradient(K,r,0,A,r,1);d.addColorStop(1,E(b,-48,w));d.addColorStop(0,E(b,48,w))}return d?a.fillStyle=d:false},L=function(b){if(b&&a.hasOwnProperty("shadowBlur")){b=b.split(/[ ,;:-]/);a.shadowOffsetX=parseInt(b[0]||1,10);a.shadowOffsetY=parseInt(b[1]||1,10);a.shadowBlur=parseInt(b[2]||1,10);a.shadowColor=b[3]||"#000"}},M=function(){if(a.hasOwnProperty("clearShadow"))a.clearShadow();else if(a.hasOwnProperty("shadowBlur")){a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=
0;a.shadowColor="rgba(0,0,0,0)"}},pa=function(){if(C){L(C.shadow);a.font=C.font;a.textAlign="left";a.textBaseline="top";a.fillStyle=C.color;a.fillText(C.text,C.x,C.y);M()}},da=function(b,d,g,c,j){if(i.x&&b%i.x==0){b=q[0].lab[b]||b;L(i.shadow);a.font=i.font;a.fillStyle=i.color;a.textAlign=c||"center";a.textBaseline=j||"alphabetic";a.fillText(b,d,g);M()}if(i.marks){a.save();a.lineWidth=1;a.moveTo(d,r);a.lineTo(d,r+i.marks);a.strokeStyle=i.color;a.stroke();a.restore()}},ra=function(b,d){a.save();a.font=
l.font;var g,c,j,h=b.length,f,x,m=0,n=0,W=O(l.font),i=W/2,k=W+3,e,p,o=G;p=0;e=H;var qa=0;b.sort(function(a,b){return parseInt(b.v,10)-parseInt(a.v,10)});for(c=0;c<h;c++){f=b[c];j=q[f.nds].lab[f.n];x=q[f.nds].tit;if(j=typeof l.text=="function"?l.text(f.n,f.v,j,f.x,f.y):l.text.replace("%v",f.v).replace("%l",j).replace("%n",f.n).replace("%t",x)){f.lines=j.split(/\n|\\n/);f.h=f.lines.length*k;f.h2=Math.floor(f.h/2);f.w=0;for(g in f.lines)if((j=a.measureText(f.lines[g]).width+6)>f.w)f.w=j;if(f.w>n)n=f.w;
m=m+f.h;f.r++;o>f.x-f.r&&(o=f.x-f.r);p<f.x+f.r&&(p=f.x+f.r);if(e>f.y)e=f.y;if(qa<f.y)qa=f.y}}h>1&&(n=n+(6+W));if(m){m=m+3;if(d){p=o+(p-o)/2-n/2;p+n>G&&(p=G-1-n)}else p+n>=G&&(p=o-n);p<1&&(p=1);p=Math.floor(p)+0.5;g=p+n;c=e+m/2+m/2;c>r&&(c=r-1);c=Math.floor(c)+0.5;f=c-m;a.beginPath();a.moveTo(p,c);a.lineTo(g,c);a.lineTo(g,f);a.lineTo(p,f);a.closePath();L(l.shadowbox);a.fillStyle=l.bullet;a.fill();M();a.lineWidth=1;a.lineJoin="round";a.strokeStyle=l.border;a.stroke();a.textAlign="left";a.textBaseline=
"top";e=f+3;for(c=0;c<h;c++){f=b[c];m=p+3;if(h>1){a.beginPath();a.arc(m+i,e+i,i,0,2*Math.PI);a.fillStyle=q[f.nds].col;a.fill();m=m+(W+3)}L(l.shadow);a.fillStyle=l.color;for(g=0;g<f.lines.length;++g,e=e+k)a.fillText(f.lines[g],m,e);M()}}a.restore()},fa={line:function(b,d){var g=z,c=b?F?D/F:0:I?D/I:0,j,h,f,x,m,n=function(a,b,c,g,f,j){for(var h,e,i,m,x,n;f<=j;)if(g[f]===null)f++;else if(d){h=b[f];e=c[f];for(f++;f<=j&&g[f]===null;)f++;if(f>j)a.lineTo(h,e);else{i=(h+b[f])/2;m=(e+c[f])/2;x=(h+i)/2;n=(e+
m)/2;a.quadraticCurveTo(h,e,x,n);x=(i+b[f])/2;n=(m+c[f])/2;a.quadraticCurveTo(i,m,x,n)}}else{a.lineTo(b[f],c[f]);f++}};a.lineWidth=V;a.lineJoin=sa;for(o=[];j=q[--g];)if((m=j.val.length)>1){var e=[],i=[];for(h=0;h<m;++h){x=0;if(b)for(f=0;f<=g;f++)x=x+q[f].val[h];else x=j.val[h];e.push(A+Math.round(h*(J/(m-1))));i.push(r-Math.round(c*x))}o.push({x:e,y:i,v:q[g].val,nds:g});h--;e.push(A+Math.round(h*(J/(m-1))));i.push(r-Math.round(c*x));for(h=0;j.val[h]===null;)h++;for(f=m-1;j.val[f]===null;)f--;if(h<=
f&&ca(j.col)){a.beginPath();a.moveTo(e[h],r);a.lineTo(e[h],i[h]);n(a,e,i,j.val,h,f);a.lineTo(e[f],r);a.closePath();a.fill()}a.strokeStyle=j.col;a.beginPath();a.moveTo(e[h],i[h]);n(a,e,i,j.val,h,f);a.stroke();if(g==0)for(h=0;h<m;++h)da(h,e[h],H-1);if(ka){a.fillStyle=j.col;for(h=0;h<m;++h)if(j.val[h]!=void 0){a.beginPath();a.arc(e[h],i[h],ka,0,2*Math.PI);a.closePath();a.fill()}}}},curve:function(a){fa.line(a,true)},chart:function(b){var d=z;o=[];if(d){var g,c,j=q[0].len,h=d>1?4:0,f=b?1:d,e=j&&d?(J-
h*(j-1))/j/f-1:0,i,n,k,l=A,ea,s,p=b?F?D/F:0:I?D/I:0;e<0&&(e=0);a.lineWidth=V;a.lineJoin="miter";for(c=0;c<d;c++)o.push({x:[],y:[],v:[],nds:c});for(g=0;g<j;g++){da(g,l+(e+1)*f/2,H-1);n=r;for(c=0;c<d;c++){i=q[c];k=b?n:r;n=k-Math.round(p*i.val[g]);ea=Math.round(l);s=Math.round(l+e);if(i.val[g]!==null){a.beginPath();a.moveTo(ea,k);a.lineTo(ea,n);a.lineTo(s,n);a.lineTo(s,k);a.closePath();ca(i.col)&&a.fill();a.strokeStyle=i.col;a.stroke()}o[c].x.push(0.5+Math.floor(l+e/2));o[c].y.push(n);o[c].v.push(i.val[g]);
b||(l=l+(e+1))}l=l+(b?e+1+h:h)}}},pie:function(){var b=z;o=[];if(b){var d=0,g=[],c=[],j=Math.PI*2,h=[],f=[];if(b>1){for(var e=0,d=b,b=0;b<d;b++)e=e+q[b].sum;if(e)for(b=0;b<d;b++){g[b]=q[b].sum/e*j;c[b]=q[b].col;h.push(q[b].sum);f.push(Math.round(100*q[b].sum/e))}}else{e=q[0];if(e.sum){d=e.len;for(b=0;b<d;b++){g[b]=e.val[b]/e.sum*j;c[b]=S[b%S.length];h.push(e.val[b]);f.push(Math.round(100*e.val[b]/e.sum))}}}var j=A+Math.round(J/2),e=Q+Math.round(D/2),m=Math.min(D/2,J/2)-1,n=m+i.fontpx,k,l,r=Math.PI*
1.5,s,p,v,y,u=N;ma=m;$=j;aa=e;N=u;a.lineWidth=V;a.lineJoin="miter";for(b=0;b<d;b++){s=r+g[b];p=(r+s)/2;o.push({a:r%(2*Math.PI),n:b});if(b===u){k=j+Math.cos(p)*10;l=e+Math.sin(p)*10}else{k=j;l=e}a.beginPath();a.moveTo(k,l);a.arc(k,l,m,r,s,false);a.closePath();ca(c[b])&&a.fill();a.strokeStyle=c[b];a.stroke();if(b===u){v=k+n/2*Math.cos(p);y=l+n/2*Math.sin(p)}else da(h[b],k+n*Math.cos(p),l+n*Math.sin(p),"center","middle");r=s}u!==false&&ra([{x:v,y:y,r:0,v:h[u]+" ("+f[u]+"%)",n:u,nds:0}],true);o.sort(function(a,
b){return a.a-b.a})}}},X={line:function(b){var d,g=false,c,e,h=l.linewidth||1,f=[];if(o.length){c=o[0];for(d=0;d<c.x.length;++d)if(c.v[d]!=void 0&&(Math.abs(b-c.x[d])<e||g===false)){e=Math.abs(b-c.x[d]);g=d}if(g!==false){for(d=0;d<o.length;++d){c=o[d];if(c.v[g]!=void 0){if(l.border){a.beginPath();a.lineWidth=h+2;a.arc(c.x[g],c.y[g],l.radius,0,2*Math.PI);if(l.linewidth==0){a.fillStyle=l.border;a.fill()}else{a.strokeStyle=l.border;a.stroke()}}a.beginPath();a.lineWidth=h;a.arc(c.x[g],c.y[g],l.radius,
0,2*Math.PI);if(l.linewidth==0){a.fillStyle=l.circle;a.fill()}else{a.strokeStyle=l.circle;a.stroke()}if(l.axis){a.lineWidth=1;if(/x/i.test(l.axis)){for(b=c.y[g]+l.radius;t<r;){a.moveTo(c.x[g],b);b=b+2;b>r&&(b=r);a.lineTo(c.x[g],b);b=b+2}a.stroke()}if(/y/i.test(l.axis)){for(b=c.x[g]+l.radius;b<K;){a.moveTo(b,c.y[g]);b=b+2;b>K&&(b=K);a.lineTo(b,c.y[g]);b=b+2}a.stroke()}}f.push({x:c.x[g],y:c.y[g],r:h/2+1+l.radius,v:c.v[g],n:g,nds:c.nds})}}ra(f)}}},chart:function(a,d){X.line(a,d)},curve:function(a,d,
g){X.line(a,d,g,true)},pie:function(a,d){var g,c=0;if(Math.sqrt(Math.pow(a-$,2)+Math.pow(d-aa,2))<=ma){g=Math.PI-Math.atan2(aa-d,a-$);for(g=(g+3*Math.PI)%(2*Math.PI);c<o.length&&g>o[c].a;)c++;--c<0&&(c=o.length-1);N=o[c].n;R(true)}else if(N!==false){N=false;R(true)}}};R=function(b){var d=u.split(/:/),g=d[0],c=d[1]||false;a.clearRect(0,0,G,H);if(ia){a.fillStyle=ia;a.fillRect(0,0,G,H)}if(/chart|line|curve/.test(u)){var e,h;a.lineWidth=s.linewidth||1;a.strokeStyle=s.color;if(s.x){d=0;for(e=s.x.length;d<
e;++d){h=A+Math.round(J*s.x[d]/100);a.beginPath();a.moveTo(h,Q);a.lineTo(h,r);a.stroke()}}if(s.y){d=0;for(e=s.y.length;d<e;++d){h=r-Math.round(D*s.y[d]/100);a.beginPath();a.moveTo(A,h);a.lineTo(K,h);a.stroke()}}}if(z&&i.y&&/chart|line|curve/.test(u)){var d=/\:[r|s]/.test(u)?F:I,f,k,m,n=d<10?100:d<100?10:1,o=Math.floor(i.fontpx/2.5);L(i.shadow);a.font=i.font;a.fillStyle=i.color;e=0;for(h=i.y.length;e<h;++e){k=r-Math.round(D*i.y[e]/100);m=Math.round(n*d*i.y[e]/100)/n;if(/left/i.test(i.ypos)){f=K+1;
a.textAlign="left";a.fillText(m,f,k+o)}if(/right/i.test(i.ypos)){f=A-2;a.textAlign="right";a.fillText(m,f,k+o)}}M()}if(C&&C.z=="top"){fa[g](c);pa()}else{pa();fa[g](c)}if(v!==false&&z>1){a.save();a.font=v.font;m=0;e=O(v.font)+3;h=e-3;f=z;o=3+e*f;k=v.x;for(var w=v.y,d=0;d<f;++d)if((n=a.measureText(q[d].tit)).width>m)m=n.width;n=9+h+m;a.lineWidth=1;if(m=v.background){L(v.shadowbox);a.fillStyle=m;a.fillRect(k,w,n,o);M()}if(m=v.border){a.strokeStyle=m;a.strokeRect(k,w,n,o)}d=0;for(n=w+3;d<f;++d,n=n+e){o=
q[d];L(v.shadow);a.fillStyle=o.col;a.fillRect(k+3,n,h,h);M();if(m=v.border2){a.strokeStyle=m;a.strokeRect(k+3,n,h,h)}L(v.shadow);a.textAlign="left";a.textBaseline="top";a.fillStyle=v.color;a.fillText(o.tit,k+6+h,n);M()}a.restore()}if(!b){y.onmouseover=y.onmousemove=y.onmouseout=void 0;N=false;if(l){Z=a.getImageData(0,0,G,H);if(B)X[g](B.x,B.y,c);y.onmouseover=function(a){B=ha(a)};y.onmousemove=function(b){if(B){g!="pie"&&a.putImageData(Z,0,0);B=ha(b);X[g](B.x,B.y,c)}};y.onmouseout=function(){B=void 0;
a.putImageData(Z,0,0)}}else B=void 0}};i.fontpx=O(i.font);/none|false/.test(s.x)&&(s.x=[]);/none|false/.test(s.y)&&(s.y=[]);A=k[3]+0.5;Q=k[0]+0.5;J=Math.max(G-k[1]-k[3],0);D=Math.max(H-k[0]-k[2],0);K=A+J;r=Q+D;e.datas&&oa(e.datas);R();return{canvas:y,data:q,clear:function(){q=[];z=0;return this},load:function(a){oa(a);return this},cls:function(){return this},draw:function(a){a&&(u=a.toLowerCase());R();return this}}},plotter=harry;