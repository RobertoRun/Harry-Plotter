// harry plotter 0.8
// ~L~ nikomomo@gmail.com 2009-2012
// https://github.com/nikopol/Harry-Plotter
var harry=function(i){var P="#88a4d7 #d685c9 #86d685 #ffc34f #93c2ea #f28989 #f9eb8a".split(" "),B=function(a,b,e){var c,a=a&&a.constructor==Array&&3==a.length?a:(c=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(a))?[parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10)]:(c=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(a))?[2.55*parseFloat(c[1]),2.55*parseFloat(c[2]),2.55*parseFloat(c[3])]:(c=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(a))?
[parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],16)]:(c=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(a))?[parseInt(c[1]+c[1],16),parseInt(c[2]+c[2],16),parseInt(c[3]+c[3],16)]:[0,0,0];"array"!=typeof b&&(b=[b,b,b]);for(c=0;3>c;++c)a[c]=Math.max(Math.min(a[c]+b[c],255),0);return void 0!=e?"rgba("+a.join(",")+","+e+")":"rgb("+a.join(",")+")"},L=function(a){var b=a.match(/\d+px/i);return b?parseInt(b,10):(b=a.match(/[0-9\.]+em/i))?Math.floor(16*parseFloat(b,10)):(b=a.match(/\d+pt/i))?Math.floor(1.3333*
parseInt(b,10)):10},ea=function(a){var b=Math.floor(a).toString(),e=parseInt(b.substr(0,1));return e*parseFloat("1E"+(b.length-1))==a?a:(e+1)*parseFloat("1E"+(b.length-1))},M=function(a,b){if("object"==typeof b)for(var e in b)a[e]=b[e];return a},d;if(i.canvas)d=document.getElementById(i.canvas);else{d=i.container;var Q=i.width||300,V=i.height||150,R=document.createElement("canvas");R.setAttribute("width",Q+"px");R.setAttribute("height",V+"px");(d?document.getElementById(d):document.body).appendChild(R);
d=R}var s=d,E=s.width,F=s.height,a=s.getContext("2d"),W,fa=i.background,x=i.mode||"line",ga=(i.fill||"a")[0].toLowerCase().replace(/[^nasvhrdl]/,"a"),q=parseFloat(i.opacity,10)||1,S=parseInt(i.linewidth,10)||1,pa=i.linejoin||"miter",ha=parseInt(i.radiuspoint,10)||0,ia=!1===i.autoscale?!1:!0,n=M({color:"#a0a0a0",font:'normal 9px "Sans Serif"',marks:0},i.labels),l=!1===i.mouseover?!1:M({radius:5,linewidth:S,circle:"#888",font:'normal 10px "Sans Serif"',color:"#fff",bullet:"rgba(99,99,99,0.8)",border:"#fff",
axis:!1,text:"%v"},i.mouseover),v,t=[],K=!1,ja,X,Y,C=!1===i.legends?!1:M({x:5,y:5,color:"#666",border2:"#fff",background:"rgba(255,255,255,0.5)",font:'10px "Sans Serif"'},i.legends);i.margins?d=i.margins:/pie/.test(F.mode)?(d=n.x?2*L(n.font):!1===l?0:10,d=[d,d,d,d]):(d=L(n.font),Q=Math.floor(d/2),V=n.marks,d=[n.y?Q:0,n.y?4*d:1,n.x?2+d+V:1,n.x?Q:0]);var u=M({color:"#a0a0a0",x:[0,100],y:[0,25,50,75,100]},i.grid),G=i.title?M({font:'bold 12px "Sans Serif"',color:"rgba(4,4,4,0.3)",x:d[3]+2,y:d[0]+2,z:"top"},
"string"==typeof i.title?{text:i.title}:i.title):!1,r=[],Z,H,y=0,D,z,N,I,A,J,o,O,ka=function(a){var b,e=a.values||a,c=a.labels||[],f={val:[],lab:[],len:0,sum:0,avg:0,max:0,min:0xffffffffffff,tit:a.title||"dataset#"+(r.length+1),col:a.color||P[r.length%P.length]};for(b in e){a=parseFloat(e[b],10);f.val.push(e[b]==null?null:a);f.lab.push(c[b]||b);f.sum=f.sum+a;if(a>f.max)f.max=a;if(a<f.min)f.min=a}f.len=f.val.length;f.avg=f.len?f.sum/f.len:0;r.push(f);y=r.length;if(y==1){Z=f.min;D=H=ia?ea(f.max):f.max}else{Z=
Math.min(f.min,Z);H=Math.max(f.max,H);b=D=0;for(e=r[0].val.length;b<e;++b){for(a=c=0;a<r.length;++a)c=c+(r[a].val[b]||0);c>D&&(D=ia?ea(c):c)}}},la=function(a){if(a.constructor==Array&&typeof a[0]=="object")for(var b=0,e=a.length;b<e;++b)ka(a[b]);else ka(a)},$=function(g){var b,e;if(ga=="a"){q=1;e=/\:river/.test(x)?"v":/line/.test(x)||/curve/.test(x)?y>1?"n":"v":/chart/.test(x)?y>1?"s":"v":/pie/.test(x.test)?"r":"s"}else e=ga;switch(e){case "s":b=B(g,0,q);break;case "l":b=B(g,21,q);break;case "d":b=
B(g,-21,q);break;case "v":b=a.createLinearGradient(0,o,0,N);b.addColorStop(0,B(g,-48,q));b.addColorStop(1,B(g,48,q));break;case "h":b=a.createLinearGradient(z,0,J,0);b.addColorStop(0,B(g,-48,q));b.addColorStop(1,B(g,48,q));break;case "r":b=a.createRadialGradient(J,o,0,z,o,1);b.addColorStop(1,B(g,-48,q));b.addColorStop(0,B(g,48,q))}return b?a.fillStyle=b:false},ma=function(){if(G&&a.font){a.font=G.font;a.textAlign="left";a.textBaseline="top";a.fillStyle=G.color;a.fillText(G.text,G.x,G.y)}},aa=function(g,
b,e,c,f){if(a.font&&n.x&&g%n.x==0){g=r[0].lab[g]||g;a.font=n.font;a.fillStyle=n.color;a.textAlign=c||"center";a.textBaseline=f||"alphabetic";a.fillText(g,b,e)}if(n.marks){a.save();a.lineWidth=1;a.moveTo(b,o);a.lineTo(b,o+n.marks);a.strokeStyle=n.color;a.stroke();a.restore()}},oa=function(g,b){a.save();a.font=l.font;var e,c,f,j=g.length,h,w,k=0,m=0,T=L(l.font),ba=T/2,i=T+3,d,p,n=E;p=0;d=F;var na=0;g.sort(function(a,b){return parseInt(b.v,10)-parseInt(a.v,10)});for(c=0;c<j;c++){h=g[c];f=r[h.nds].lab[h.n];
w=r[h.nds].tit;if(f=typeof l.text=="function"?l.text(h.n,h.v,f,h.x,h.y):l.text.replace("%v",h.v).replace("%l",f).replace("%n",h.n).replace("%t",w)){h.lines=f.split(/\n|\\n/);h.h=h.lines.length*i;h.h2=Math.floor(h.h/2);h.w=0;for(e in h.lines)if((f=a.measureText(h.lines[e]).width+6)>h.w)h.w=f;if(h.w>m)m=h.w;k=k+h.h;h.r++;n>h.x-h.r&&(n=h.x-h.r);p<h.x+h.r&&(p=h.x+h.r);if(d>h.y)d=h.y;if(na<h.y)na=h.y}}j>1&&(m=m+(6+T));if(k){k=k+3;if(b){p=n+(p-n)/2-m/2;p+m>E&&(p=E-1-m)}else p+m>=E&&(p=n-m);p<1&&(p=1);p=
Math.floor(p)+0.5;e=p+m;c=d+k/2+k/2;c>o&&(c=o-1);c=Math.floor(c)+0.5;h=c-k;a.beginPath();a.moveTo(p,c);a.lineTo(e,c);a.lineTo(e,h);a.lineTo(p,h);a.closePath();a.fillStyle=l.bullet;a.fill();a.lineWidth=1;a.lineJoin="round";a.strokeStyle=l.border;a.stroke();a.textAlign="left";a.textBaseline="top";d=h+3;for(c=0;c<j;c++){h=g[c];k=p+3;if(j>1){a.beginPath();a.arc(k+ba,d+ba,ba,0,2*Math.PI);a.fillStyle=r[h.nds].col;a.fill();k=k+(T+3)}a.fillStyle=l.color;for(e=0;e<h.lines.length;++e,d=d+i)a.fillText(h.lines[e],
k,d)}}a.restore()},da={line:function(g,b){var e=y,c=g?D?A/D:0:H?A/H:0,f,j,h,w,k,m=function(a,c,g,f,e,h){for(var j,d,w,k,i,m;e<=h;)if(f[e]===null)e++;else if(b){j=c[e];d=g[e];for(e++;e<=h&&f[e]===null;)e++;if(e>h)a.lineTo(j,d);else{w=(j+c[e])/2;k=(d+g[e])/2;i=(j+w)/2;m=(d+k)/2;a.quadraticCurveTo(j,d,i,m);i=(w+c[e])/2;m=(k+g[e])/2;a.quadraticCurveTo(w,k,i,m)}}else{a.lineTo(c[e],g[e]);e++}};a.lineWidth=S;a.lineJoin=pa;for(t=[];f=r[--e];)if((k=f.val.length)>1){var d=[],i=[];for(j=0;j<k;++j){w=0;if(g)for(h=
0;h<=e;h++)w=w+r[h].val[j];else w=f.val[j];d.push(z+Math.round(j*(I/(k-1))));i.push(o-Math.round(c*w))}t.push({x:d,y:i,v:r[e].val,nds:e});j--;d.push(z+Math.round(j*(I/(k-1))));i.push(o-Math.round(c*w));for(j=0;f.val[j]===null;)j++;for(h=k-1;f.val[h]===null;)h--;if(j<=h&&$(f.col)){a.beginPath();a.moveTo(d[j],o);a.lineTo(d[j],i[j]);m(a,d,i,f.val,j,h);a.lineTo(d[h],o);a.closePath();a.fill()}a.strokeStyle=f.col;a.beginPath();a.moveTo(d[j],i[j]);m(a,d,i,f.val,j,h);a.stroke();if(e==0)for(j=0;j<k;++j)aa(j,
d[j],F);if(ha){a.fillStyle=f.col;for(j=0;j<k;++j)if(f.val[j]!=void 0){a.beginPath();a.arc(d[j],i[j],ha,0,2*Math.PI);a.closePath();a.fill()}}}},curve:function(a){da.line(a,true)},chart:function(g){var b=y;t=[];if(b){var e,c,f=r[0].len,j=b>1?4:0,h=g?1:b,d=f&&b?(I-j*(f-1))/f/h-1:0,k,i,n,l=z,ca,s,p=g?D?A/D:0:H?A/H:0;d<0&&(d=0);a.lineWidth=S;a.lineJoin="miter";for(c=0;c<b;c++)t.push({x:[],y:[],v:[],nds:c});for(e=0;e<f;e++){aa(e,l+(d+1)*h/2,F-1);i=o;for(c=0;c<b;c++){k=r[c];n=g?i:o;i=n-Math.round(p*k.val[e]);
ca=Math.round(l);s=Math.round(l+d);if(k.val[e]!==null){a.beginPath();a.moveTo(ca,n);a.lineTo(ca,i);a.lineTo(s,i);a.lineTo(s,n);a.closePath();$(k.col)&&a.fill();a.strokeStyle=k.col;a.stroke()}t[c].x.push(0.5+Math.floor(l+d/2));t[c].y.push(i);t[c].v.push(k.val[e]);g||(l=l+(d+1))}l=l+(g?d+1+j:j)}}},pie:function(){var g=y;t=[];if(g){var b=0,e=[],c=[],f=Math.PI*2,j=[],h=[];if(g>1){for(var d=0,b=g,g=0;g<b;g++)d=d+r[g].sum;if(d)for(g=0;g<b;g++){e[g]=r[g].sum/d*f;c[g]=r[g].col;j.push(r[g].sum);h.push(Math.round(100*
r[g].sum/d))}}else{d=r[0];if(d.sum){b=d.len;for(g=0;g<b;g++){e[g]=d.val[g]/d.sum*f;c[g]=P[g%P.length];j.push(d.val[g]);h.push(Math.round(100*d.val[g]/d.sum))}}}var f=z+Math.round(I/2),d=N+Math.round(A/2),i=Math.min(A/2,I/2)-1,m=i+n.fontpx,l,o,s=Math.PI*1.5,u,p,v,x,q=K;ja=i;X=f;Y=d;K=q;a.lineWidth=S;a.lineJoin="miter";for(g=0;g<b;g++){u=s+e[g];p=(s+u)/2;t.push({a:s%(2*Math.PI),n:g});if(g===q){l=f+Math.cos(p)*10;o=d+Math.sin(p)*10}else{l=f;o=d}a.beginPath();a.moveTo(l,o);a.arc(l,o,i,s,u,false);a.closePath();
$(c[g])&&a.fill();a.strokeStyle=c[g];a.stroke();if(g===q){v=l+m/2*Math.cos(p);x=o+m/2*Math.sin(p)}else aa(j[g],l+m*Math.cos(p),o+m*Math.sin(p),"center","middle");s=u}q!==false&&oa([{x:v,y:x,r:0,v:j[q]+" ("+h[q]+"%)",n:q,nds:0}],true);t.sort(function(a,b){return a.a-b.a})}}},U={line:function(g,b){var e,c=false,f,d,h=l.linewidth||1,i=[];if(t.length){f=t[0];for(e=0;e<f.x.length;++e)if(f.v[e]!=void 0&&(Math.abs(g-f.x[e])<d||c===false)){d=Math.abs(g-f.x[e]);c=e}if(c!==false){for(e=0;e<t.length;++e){f=
t[e];if(f.v[c]!=void 0){if(l.border){a.beginPath();a.lineWidth=h+2;a.arc(f.x[c],f.y[c],l.radius,0,2*Math.PI);if(l.linewidth==0){a.fillStyle=l.border;a.fill()}else{a.strokeStyle=l.border;a.stroke()}}a.beginPath();a.lineWidth=h;a.arc(f.x[c],f.y[c],l.radius,0,2*Math.PI);if(l.linewidth==0){a.fillStyle=l.circle;a.fill()}else{a.strokeStyle=l.circle;a.stroke()}if(l.axis){a.lineWidth=1;if(/x/i.test(l.axis)){for(b=f.y[c]+l.radius;b<o;){a.moveTo(f.x[c],b);b=b+2;b>o&&(b=o);a.lineTo(f.x[c],b);b=b+2}a.stroke()}if(/y/i.test(l.axis)){for(g=
f.x[c]+l.radius;g<J;){a.moveTo(g,f.y[c]);g=g+2;g>J&&(g=J);a.lineTo(g,f.y[c]);g=g+2}a.stroke()}}i.push({x:f.x[c],y:f.y[c],r:h/2+1+l.radius,v:f.v[c],n:c,nds:f.nds})}}oa(i)}}},chart:function(a,b){U.line(a,b)},curve:function(a,b,e){U.line(a,b,e,true)},pie:function(a,b){var e,c=0;if(Math.sqrt(Math.pow(a-X,2)+Math.pow(b-Y,2))<=ja){e=Math.PI-Math.atan2(Y-b,a-X);for(e=(e+3*Math.PI)%(2*Math.PI);c<t.length&&e>t[c].a;)c++;--c<0&&(c=t.length-1);K=t[c].n;O(true)}else if(K!==false){K=false;O(true)}}};O=function(g){var b=
x.split(/:/),e=b[0],c=b[1]||false;a.clearRect(0,0,E,F);if(fa){a.fillStyle=fa;a.fillRect(0,0,E,F)}if(/chart|line|curve/.test(x)){var f,d;a.lineWidth=u.linewidth||1;a.strokeStyle=u.color;if(u.x){b=0;for(f=u.x.length;b<f;++b){d=z+Math.round(I*u.x[b]/100);a.beginPath();a.moveTo(d,N);a.lineTo(d,o);a.stroke()}}if(u.y){b=0;for(f=u.y.length;b<f;++b){d=o-Math.round(A*u.y[b]/100);a.beginPath();a.moveTo(z,d);a.lineTo(J,d);a.stroke()}}}if(y&&(n.y&&a.font)&&/chart|line|curve/.test(x)){var b=/\:[r|s]/.test(x)?
D:H,h,i,k,m=b<10?100:b<100?10:1,q=Math.floor(n.fontpx/2.5);a.font=n.font;a.fillStyle=n.color;a.textAlign="left";f=0;for(d=n.y.length;f<d;++f){h=J+1;i=o-Math.round(A*n.y[f]/100);k=Math.round(m*b*n.y[f]/100)/m;a.fillText(k,h,i+q)}}if(G&&G.z=="top"){da[e](c);ma()}else{ma();da[e](c)}if(C!==false&&y>1){a.save();a.font=C.font;k=0;f=L(C.font)+3;d=f-3;h=y;q=3+f*h;i=C.x;for(var t=C.y,b=0;b<h;++b)if((m=a.measureText(r[b].tit)).width>k)k=m.width;m=9+d+k;a.lineWidth=1;if(k=C.background){a.fillStyle=k;a.fillRect(i,
t,m,q)}if(k=C.border){a.strokeStyle=k;a.strokeRect(i,t,m,q)}b=0;for(m=t+3;b<h;++b,m=m+f){q=r[b];a.fillStyle=q.col;a.fillRect(i+3,m,d,d);if(k=C.border2){a.strokeStyle=k;a.strokeRect(i+3,m,d,d)}a.textAlign="left";a.textBaseline="top";a.fillStyle=C.color;a.fillText(q.tit,i+6+d,m)}a.restore()}if(!g){s.onmouseover=s.onmousemove=s.onmouseout=void 0;K=false;if(l){W=a.getImageData(0,0,E,F);if(v)U[e](v.x,v.y,c);s.onmouseover=function(a){v={x:(a||window.event).clientX-s.offsetLeft,y:(a||window.event).clientY-
s.offsetTop}};s.onmousemove=function(b){if(v){e!="pie"&&a.putImageData(W,0,0);v={x:(b||window.event).clientX-s.offsetLeft,y:(b||window.event).clientY-s.offsetTop};U[e](v.x,v.y,c);console.log(v)}};s.onmouseout=function(){v=void 0;a.putImageData(W,0,0)}}else v=void 0}};n.fontpx=L(n.font);/none|false/.test(u.x)&&(u.x=[]);/none|false/.test(u.y)&&(u.y=[]);z=d[3]+0.5;N=d[0]+0.5;I=Math.max(E-d[1]-d[3],0);A=Math.max(F-d[0]-d[2],0);J=z+I;o=N+A;i.datas&&la(i.datas);O();return{canvas:s,data:r,clear:function(){r=
[];y=0;return this},load:function(a){la(a);return this},cls:function(){return this},draw:function(a){a&&(x=a.toLowerCase());O();return this}}},plotter=function(i){return harry(i)};